<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>í¥ë¶€ì í†µí•© API ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif; background:#F9FAFB; color:#191F28; padding:24px; line-height:1.6; }
        .container { max-width:1200px; margin:0 auto; }
        .header { background:#FFFFFF; color:#191F28; padding:32px; border-radius:16px; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.04); margin-bottom:24px; border:1px solid #E5E8EB; }
        .header h1 { font-size:28px; font-weight:700; margin-bottom:8px; letter-spacing:-0.5px; }
        .header p { color:#4E5968; font-size:15px; font-weight:400; }
        .auth-switch { display:flex; justify-content:center; gap:12px; margin-bottom:24px; }
        .auth-switch button { padding:12px 24px; border:1px solid #E5E8EB; border-radius:12px; font-weight:600; font-size:15px; cursor:pointer; transition:all 0.2s ease; background:#FFFFFF; color:#4E5968; }
        .auth-switch button.active { background:#3182F6; color:#FFFFFF; border-color:#3182F6; }
        .auth-switch button:hover { background:#F9FAFB; }
        .auth-switch button.active:hover { background:#1B64DA; }
        .section { background:#FFFFFF; border-radius:16px; padding:32px; margin-bottom:24px; box-shadow:0 2px 8px rgba(0,0,0,0.04); transition:all 0.2s ease; border:1px solid #E5E8EB; }
        .section.hidden { display:none; }
        .section-title { font-size:18px; font-weight:700; color:#191F28; margin-bottom:20px; padding-bottom:12px; border-bottom:1px solid #E5E8EB; letter-spacing:-0.3px; }
        input, select, textarea { width:100%; padding:14px 16px; margin-bottom:12px; border:1px solid #E5E8EB; border-radius:12px; font-size:15px; transition:all 0.2s ease; background:#FFFFFF; color:#191F28; }
        input:focus, select:focus, textarea:focus { outline:none; border-color:#3182F6; box-shadow:0 0 0 3px rgba(49,130,246,0.1); }
        textarea { resize:vertical; min-height:100px; font-family:inherit; }
        .btn { padding:14px 24px; border:none; border-radius:12px; font-weight:600; cursor:pointer; transition:all 0.2s ease; font-size:15px; }
        .btn-primary { background:#3182F6; color:#FFFFFF; }
        .btn-primary:hover { background:#1B64DA; }
        .btn-success { background:#00C7AE; color:#FFFFFF; }
        .btn-success:hover { background:#00A896; }
        .response-box { margin-top:16px; padding:16px; border-radius:12px; display:none; font-family:'Courier New',monospace; font-size:13px; line-height:1.5; }
        .response-box.show { display:block; }
        .response-box.success { background:#F0FDF9; border:1px solid #00C7AE; color:#191F28; }
        .response-box.error { background:#FEF2F2; border:1px solid #F04452; color:#191F28; }

        /* ì‹ ê³  ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ */
        .emergency-list { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:16px; margin-top:16px; }
        .emergency-card { background:#FFFFFF; border-radius:16px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.04); transition:all 0.2s ease; border:1px solid #E5E8EB; }
        .emergency-card:hover { transform:translateY(-2px); box-shadow:0 4px 16px rgba(0,0,0,0.08); }
        .emergency-card .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; padding-bottom:12px; border-bottom:1px solid #F1F3F5; }
        .emergency-card .report-id { color:#3182F6; font-weight:600; font-size:15px; }
        .emergency-card .status { padding:6px 12px; border-radius:8px; font-size:13px; font-weight:600; }
        .emergency-card.pending .status { background:#FEF3C7; color:#92400E; }
        .emergency-card.confirmed .status { background:#FEE2E2; color:#991B1B; }
        .emergency-card.resolved .status { background:#D1FAE5; color:#065F46; }
        .emergency-card.false_alarm .status { background:#F3F4F6; color:#374151; }
        .emergency-card .card-body { font-size:14px; line-height:1.6; }
        .emergency-card .card-body p { margin-bottom:8px; color:#4E5968; }
        .emergency-card .card-body strong { color:#191F28; font-weight:600; margin-right:6px; }
        .emergency-card .ok { color:#00C7AE; font-weight:600; }
        .emergency-card .no { color:#F04452; font-weight:600; }
        .emergency-card .resolve-btn { width:100%; margin-top:16px; padding:12px; border:none; border-radius:12px; background:#00C7AE; color:#FFFFFF; font-weight:600; cursor:pointer; transition:all 0.2s ease; font-size:14px; }
        .emergency-card .resolve-btn:hover { background:#00A896; }
        .emergency-card .resolved-label { margin-top:16px; background:#D1FAE5; color:#065F46; text-align:center; border-radius:12px; padding:12px 0; font-weight:600; font-size:14px; }

        /* ì–´ë¥´ì‹  ì¹´ë“œ */
        .users-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:16px; margin-top:16px; }
        .user-card { background:#FFFFFF; border-radius:16px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.04); transition:all 0.2s ease; border:1px solid #E5E8EB; border-left:4px solid #E5E8EB; }
        .user-card.status-active { border-left-color:#00C7AE; }
        .user-card.status-warning { border-left-color:#F59E0B; }
        .user-card.status-emergency { border-left-color:#F04452; animation:shake 0.4s infinite; }
        @keyframes shake { 0%,100%{transform:translateX(0);}25%{transform:translateX(-3px);}75%{transform:translateX(3px);} }
        .user-header { display:flex; align-items:center; gap:12px; margin-bottom:16px; padding-bottom:12px; border-bottom:1px solid #F1F3F5; }
        .user-status-icon { font-size:28px; }
        .user-name { font-size:17px; font-weight:700; color:#191F28; letter-spacing:-0.3px; }
        .user-room { color:#4E5968; font-size:14px; margin-top:2px; }
        .user-activity { margin:12px 0; padding:16px; background:#F9FAFB; border-radius:12px; font-size:14px; border:1px solid #F1F3F5; }
        .user-activity .activity-type { font-weight:600; margin-bottom:6px; color:#191F28; }
        .user-activity .activity-detail { color:#4E5968; line-height:1.5; }

        /* í™œë™ í”¼ë“œ */
        .activity-feed { background:#FFFFFF; border-radius:16px; padding:24px; box-shadow:0 2px 8px rgba(0,0,0,0.04); margin-top:24px; border:1px solid #E5E8EB; }
        .activity-item { padding:16px; margin-bottom:12px; background:#F9FAFB; border-left:3px solid #E5E8EB; border-radius:12px; display:flex; justify-content:space-between; align-items:center; }
        .activity-item.emergency { border-left-color:#F04452; background:#FEF2F2; }
        .activity-item.warning { border-left-color:#F59E0B; background:#FFFBEB; }
        .activity-item div:first-child { color:#191F28; font-size:14px; font-weight:500; }
        .activity-time { font-size:13px; color:#9CA3AF; font-weight:400; }

        /* ëª¨ë‹¬ */
        .emergency-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center; z-index:1000; backdrop-filter:blur(4px); }
        .emergency-modal.show { display:flex; }
        .modal-content { background:#FFFFFF; padding:40px; border-radius:24px; max-width:480px; width:90%; text-align:center; animation:modalPop 0.25s ease; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); }
        @keyframes modalPop { 0%{transform:scale(0.95) translateY(10px);opacity:0;}100%{transform:scale(1) translateY(0);opacity:1;} }
        .modal-icon { font-size:72px; margin-bottom:20px; }
        .modal-title { font-size:24px; font-weight:700; margin-bottom:12px; color:#191F28; letter-spacing:-0.5px; }
        .modal-detail { color:#4E5968; margin-bottom:32px; line-height:1.6; font-size:15px; }
        .modal-actions { display:flex; gap:12px; }

        /* WebSocket ìƒíƒœ í‘œì‹œ */
        .ws-status { position:fixed; bottom:24px; right:24px; padding:12px 20px; background:#FFFFFF; border-radius:24px; box-shadow:0 4px 12px rgba(0,0,0,0.08); font-size:13px; display:flex; align-items:center; gap:10px; border:1px solid #E5E8EB; font-weight:500; color:#191F28; }
        .ws-indicator { width:10px; height:10px; border-radius:50%; background:#00C7AE; animation:blink 2s infinite; box-shadow:0 0 8px rgba(0,199,174,0.4); }
        @keyframes blink { 0%,100%{opacity:1;}50%{opacity:0.4;} }
        .hidden { display:none; }
        .notification { position:relative; cursor:pointer; font-size:24px; }
        .notification-badge { position:absolute; top:-8px; right:-8px; background:#F04452; color:#FFFFFF; border-radius:12px; padding:2px 8px; font-size:11px; font-weight:600; min-width:20px; text-align:center; display:flex; align-items:center; justify-content:center; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸµ í¥ë¶€ì ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
        <p>ì‹ ê³  / ì–´ë¥´ì‹  ìƒíƒœ í†µí•© ëª¨ë‹ˆí„°ë§</p>
    </div>

    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="login-screen" class="section">
        <div class="section-title">ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</div>
        <input id="username" type="text" placeholder="ì•„ì´ë””" value="admin_ssafy">
        <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" value="password123">
        <button class="btn btn-primary" onclick="login()">ë¡œê·¸ì¸</button>
        <div id="login-error" class="response-box error"></div>
    </div>

    <!-- ëŒ€ì‹œë³´ë“œ í™”ë©´ -->
    <div id="dashboard-screen" class="hidden">
        <div class="header">
            <h1>ğŸ¥ ê´€ë¦¬ì í˜ì´ì§€</h1>
            <div class="notification" onclick="clearBadge();">
                ğŸ””<span id="notification-badge" class="notification-badge" style="display:none;">0</span>
            </div>
        </div>

        <!-- ë“±ë¡ ë²„íŠ¼ -->
        <div class="section">
            <button class="btn btn-primary" onclick="openDeviceModal()" style="margin-right:10px;">ğŸ“± ê¸°ê¸° ë“±ë¡</button>
            <button class="btn btn-success" onclick="openUserModal()">ğŸ‘´ ì–´ë¥´ì‹  ë“±ë¡</button>
        </div>

        <div class="dashboard">
            <div class="section-title">ğŸ“Š ì‹¤ì‹œê°„ ì‹ ê³  ë¦¬ìŠ¤íŠ¸</div>
            <div id="res-emg-list" class="response-box"></div>

            <div class="section-title">ğŸ§‘â€ğŸ¦³ ë‹´ë‹¹ ì–´ë¥´ì‹  í˜„í™©</div>
            <div id="users-grid" class="users-grid"></div>

            <div class="section-title">ğŸ“ í™œë™ í”¼ë“œ</div>
            <div class="activity-feed">
                <div id="activity-list"><div style="color:#999;text-align:center;">í™œë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div></div>
            </div>
        </div>

        <div class="ws-status"><div class="ws-indicator"></div>ì‹¤ì‹œê°„ ì—°ê²°ë¨</div>
    </div>

    <!-- ì‹ ê³  ëª¨ë‹¬ -->
    <div id="emergency-modal" class="emergency-modal">
        <div class="modal-content">
            <div class="modal-icon">ğŸš¨</div>
            <div class="modal-title">ê¸´ê¸‰ ì‹ ê³  ë°œìƒ!</div>
            <div id="modal-detail" class="modal-detail"></div>
            <div class="modal-actions">
                <button class="btn btn-success" onclick="acknowledgeReport()">ì²˜ë¦¬ í™•ì¸</button>
                <button class="btn btn-primary" onclick="closeModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ê¸°ê¸° ë“±ë¡ ëª¨ë‹¬ -->
    <div id="device-modal" class="emergency-modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-icon">ğŸ“±</div>
            <div class="modal-title" style="color:#667eea;">ê¸°ê¸° ë“±ë¡</div>
            <div style="text-align:left; margin-top:20px;">
                <input id="device-serial" type="text" placeholder="ê¸°ê¸° ì¼ë ¨ë²ˆí˜¸ (í•„ìˆ˜)" style="margin-bottom:15px;">
                <input id="device-location" type="text" placeholder="ì„¤ì¹˜ ìœ„ì¹˜ (ì„ íƒ, ì˜ˆ: 101í˜¸)" style="margin-bottom:15px;">
                <div id="device-register-response" class="response-box"></div>
            </div>
            <div class="modal-actions" style="margin-top:20px;">
                <button class="btn btn-success" onclick="registerDevice()">ë“±ë¡</button>
                <button class="btn btn-primary" onclick="closeDeviceModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ì–´ë¥´ì‹  ë“±ë¡ ëª¨ë‹¬ -->
    <div id="user-modal" class="emergency-modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-icon">ğŸ‘´</div>
            <div class="modal-title" style="color:#2ecc71;">ì–´ë¥´ì‹  ë“±ë¡</div>
            <div style="text-align:left; margin-top:20px;">
                <input id="user-name" type="text" placeholder="ì´ë¦„ (í•„ìˆ˜)" style="margin-bottom:15px;">
                <input id="user-birthdate" type="date" placeholder="ìƒë…„ì›”ì¼ (ì„ íƒ)" style="margin-bottom:15px;">
                <select id="user-gender" style="margin-bottom:15px;">
                    <option value="">ì„±ë³„ ì„ íƒ (ì„ íƒ)</option>
                    <option value="MALE">ë‚¨ì„±</option>
                    <option value="FEMALE">ì—¬ì„±</option>
                </select>
                <input id="user-contact" type="text" placeholder="ë¹„ìƒ ì—°ë½ì²˜ (ì„ íƒ)" style="margin-bottom:15px;">
                <select id="user-device" style="margin-bottom:15px;">
                    <option value="">ì—°ê²°í•  ê¸°ê¸° ì„ íƒ (í•„ìˆ˜)</option>
                </select>
                <textarea id="user-medical-notes" placeholder="ì˜ë£Œ ë©”ëª¨ (ì„ íƒ, ì§€ë³‘, ë³µìš©ì•½ ë“±)"></textarea>
                <div id="user-register-response" class="response-box"></div>
            </div>
            <div class="modal-actions" style="margin-top:20px;">
                <button class="btn btn-success" onclick="registerUser()">ë“±ë¡</button>
                <button class="btn btn-primary" onclick="closeUserModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ì˜¤ë””ì˜¤ ì•Œë¦¼
    const alertAudio = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');

    // API ë² ì´ìŠ¤
    const API_BASE = 'http://localhost:8080/api';
    let accessToken = null;
    let adminId = null;
    let stompClient = null;

    // ì‹ ê³  ì¹´ë“œ ë°ì´í„° ì €ì¥
    let emergencyList = [];

    // ë¡œê·¸ì¸
    async function login(){
        const user = document.getElementById('username').value;
        const pwd  = document.getElementById('password').value;
        try {
            const res = await fetch(`${API_BASE}/admins/login`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({username:user, password:pwd})
            });
            if(!res.ok) throw new Error('ë¡œê·¸ì¸ ì‹¤íŒ¨');
            const data = await res.json();
            accessToken = data.accessToken;
            adminId     = data.userId;

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard-screen').classList.remove('hidden');

            // ì´ˆê¸° ë¡œë“œ
            loadDashboardData();
            connectWebSocket();
        } catch(e) {
            const errEl = document.getElementById('login-error');
            errEl.style.display='block';
            errEl.textContent = e.message;
        }
    }

    // ë°ì´í„° ë¡œë“œ â€“ ë‹´ë‹¹ ì–´ë¥´ì‹  & ê¸°ì¡´ ì‹ ê³ 
    async function loadDashboardData(){
        try {
            // ì–´ë¥´ì‹  ëª©ë¡
            const resUsers = await fetch(`${API_BASE}/admins/users`, {
                headers: {Authorization: `Bearer ${accessToken}`}
            });
            if(resUsers.ok) {
                const users = await resUsers.json();
                renderUsers(users);
            }
            // ê¸°ì¡´ ì‹ ê³  ëª©ë¡
            const resEmg = await fetch(`${API_BASE}/emergency/admins/reports`, {
                headers: {Authorization: `Bearer ${accessToken}`}
            });
            if(resEmg.ok) {
                const list = await resEmg.json();
                emergencyList = list; // ì„œë²„ì—ì„œ ì´ë¯¸ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬ë¨
                renderEmergencyCards(emergencyList);
                // PENDING + CONFIRMEDë§Œ ë°°ì§€ì— í‘œì‹œ
                const pendingCount = emergencyList.filter(i=>i.status==='PENDING' || i.status==='CONFIRMED').length;
                updateBadge(pendingCount);
            }
        } catch(e) {
            console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        }
    }

    // ì–´ë¥´ì‹  ì¹´ë“œ ë Œë”ë§
    function renderUsers(users){
        const grid = document.getElementById('users-grid');
        grid.innerHTML = '';
        users.forEach(u => {
            let cls = 'status-active';
            let icon = 'ğŸŸ¢';
            if (u.healthStatus === 'EMERGENCY') { cls = 'status-emergency'; icon = 'ğŸš¨'; }
            else if (!u.isActive)         { cls = 'status-warning';  icon = 'ğŸŸ¡'; }

            // ìµœê·¼ í™œë™ ë Œë”ë§
            let activitiesHtml = '';
            if (u.recentActivities && u.recentActivities.length > 0) {
                activitiesHtml = '<div style="margin-top:12px; padding-top:12px; border-top:1px solid #eee;">' +
                    '<div style="font-size:12px; color:#999; margin-bottom:8px;">ìµœê·¼ í™œë™</div>';
                u.recentActivities.forEach(a => {
                    activitiesHtml += `<div style="font-size:13px; color:#666; margin-bottom:4px;">${a.icon} ${a.description} <span style="color:#999; font-size:11px;">(${a.timeAgo})</span></div>`;
                });
                activitiesHtml += '</div>';
            } else {
                activitiesHtml = '<div style="margin-top:12px; padding-top:12px; border-top:1px solid #eee; font-size:12px; color:#999;">ìµœê·¼ í™œë™ ì—†ìŒ</div>';
            }

            const div = document.createElement('div');
            div.className = `user-card ${cls}`;
            div.setAttribute('data-user-id', u.id);  // userId ì¶”ì ìš©
            div.innerHTML = `
            <div class="user-header"><span class="user-status-icon">${icon}</span>
                <div>
                  <div class="user-name">${u.name}</div>
                  <div class="user-room">${u.emergencyContact||''}</div>
                </div>
            </div>
            <div class="user-activity">
              <div class="activity-type">${u.healthStatus||'ì •ìƒ'} ìƒíƒœ</div>
              <div class="activity-detail">${u.medicalNotes||'íŠ¹ì´ì‚¬í•­ ì—†ìŒ'}</div>
            </div>
            ${activitiesHtml}
        `;
            grid.appendChild(div);
        });
    }

    // ì‹ ê³  ì¹´ë“œ ë Œë”ë§
    function renderEmergencyCards(list){
        const container = document.getElementById('res-emg-list');
        if (!Array.isArray(list) || list.length === 0) {
            container.className = 'response-box show success';
            container.innerHTML = '<p style="padding:10px;">ì‹ ê³  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        container.className = 'response-box show success';

        // ìƒíƒœ í•œê¸€ ë³€í™˜
        const statusText = {
            'PENDING': 'ëŒ€ê¸°ì¤‘',
            'CONFIRMED': 'í™•ì •ë¨',
            'RESOLVED': 'ì²˜ë¦¬ì™„ë£Œ',
            'FALSE_ALARM': 'ì˜¤íƒ'
        };

        container.innerHTML = `
      <div class="emergency-list">
        ${list.map(item => `
          <div class="emergency-card ${item.status.toLowerCase()}">
            <div class="card-header">
              <span class="report-id">#${item.reportId}</span>
              <span class="status">${statusText[item.status] || item.status}</span>
            </div>
            <div class="card-body">
              <p><strong>ì‹ ê³ ì:</strong> ${item.userName} (${item.userId})</p>
              <p><strong>ë°œí™” ë‚´ìš©:</strong> "${item.fullText || item.triggerWord}"</p>
              <p><strong>íŠ¸ë¦¬ê±° ë‹¨ì–´:</strong> ${item.triggerWord}</p>
              <p><strong>í™•ì¸ì—¬ë¶€:</strong>
                <span class="${item.isConfirmed?'ok':'no'}">
                  ${item.isConfirmed?'í™•ì¸ë¨':'ë¯¸í™•ì¸'}
                </span>
              </p>
              <p><strong>ë°œìƒì‹œê°„:</strong> ${new Date(item.reportedAt).toLocaleString('ko-KR')}</p>
              ${item.message?`<p><strong>ë©”ì‹œì§€:</strong> ${item.message}</p>`:''}
            </div>
            ${item.status==='PENDING' || item.status==='CONFIRMED'
            ? `<button class="resolve-btn" onclick="handleEmergencyResolve(${item.reportId})">âœ… ì²˜ë¦¬</button>`
            : `<div class="resolved-label">âœ” ì²˜ë¦¬ ì™„ë£Œ</div>`
        }
          </div>
        `).join('')}
      </div>
    `;
    }

    // ì‹ ê³  ì²˜ë¦¬ ë²„íŠ¼
    async function handleEmergencyResolve(id){
        if (!accessToken) { alert('ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”!'); return; }
        const notes = 'ê´€ë¦¬ì í™•ì¸ ì™„ë£Œ';
        try {
            const res = await fetch(`${API_BASE}/emergency/admins/reports/${id}?notes=${encodeURIComponent(notes)}`, {
                method:'PUT',
                headers:{Authorization:`Bearer ${accessToken}`}
            });
            if (res.ok) {
                alert(`#${id} ì‹ ê³ ê°€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);

                // ğŸ”¥ í•´ë‹¹ ì‹ ê³ ì˜ userId ì°¾ê¸°
                const report = emergencyList.find(item => item.reportId === id);
                if (report) {
                    // ì–´ë¥´ì‹  ì¹´ë“œë¥¼ ì •ìƒ ìƒíƒœë¡œ ë³µêµ¬
                    resetUserCardToNormal(report.userId);
                }

                // ìƒíƒœ ë³€ê²½ ë°˜ì˜
                emergencyList = emergencyList.map(item => item.reportId===id ? {...item, status:'RESOLVED'} : item);
                renderEmergencyCards(emergencyList);
                updateBadge(emergencyList.filter(i=>i.status==='PENDING' || i.status==='CONFIRMED').length);
            } else {
                const err = await res.json();
                alert('ì²˜ë¦¬ ì‹¤íŒ¨: '+(err.message||res.statusText));
            }
        } catch(e){
            alert('ì—ëŸ¬ ë°œìƒ: '+e.message);
        }
    }

    // WebSocket ì—°ê²°
    function connectWebSocket(){
        if (!adminId) {
            console.error('âŒ adminIdê°€ ì—†ìŠµë‹ˆë‹¤! WebSocket ì—°ê²° ë¶ˆê°€');
            alert('ê´€ë¦¬ì IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            return;
        }

        console.log('ğŸ”Œ WebSocket ì—°ê²° ì‹œë„...');
        console.log('  URL:', `${API_BASE}/ws`);
        console.log('  adminId:', adminId);

        const socket = new SockJS(`${API_BASE}/ws`);
        stompClient = Stomp.over(socket);

        stompClient.connect({},
            // ì—°ê²° ì„±ê³µ ì½œë°±
            () => {
                console.log('âœ… WebSocket ì—°ê²° ì„±ê³µ!');
                console.log('ğŸ‘¤ í˜„ì¬ adminId:', adminId);
                const subscribePath = `/topic/admin/${adminId}/emergency`;
                console.log('ğŸ”” êµ¬ë… ê²½ë¡œ:', subscribePath);

                try {
                    const subscription = stompClient.subscribe(subscribePath, msg => {
                        console.log('ğŸ“© WebSocket ë©”ì‹œì§€ ìˆ˜ì‹ !', msg.body);
                        const alertData = JSON.parse(msg.body);
                        alertAudio.play();

                // Null-safe ì²˜ë¦¬
                const userName = alertData.userName || 'ì•Œ ìˆ˜ ì—†ìŒ';
                const triggerWord = alertData.triggerWord || 'ë¯¸ìƒ';
                const fullText = alertData.fullText || triggerWord;  // ì „ì²´ ë°œí™” í…ìŠ¤íŠ¸

                addActivity('emergency', userName, `ì‹ ê³ : "${fullText}"`);

                // ğŸ”¥ í•´ë‹¹ ì–´ë¥´ì‹  ì¹´ë“œë¥¼ ì¦‰ì‹œ ê¸´ê¸‰ ìƒíƒœë¡œ ë³€ê²½
                updateUserCardToEmergency(alertData.userId, userName);

                // ğŸ”¥ ë Œë”ë§ ê°€ëŠ¥í•œ í˜•íƒœë¡œ ë³€í™˜í•´ì„œ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
                const emergencyItem = {
                    reportId: alertData.reportId,
                    userId: alertData.userId,
                    userName: userName,
                    triggerWord: triggerWord,
                    fullText: fullText,  // ì „ì²´ ë°œí™” í…ìŠ¤íŠ¸ ì¶”ê°€
                    reportedAt: alertData.reportedAt,
                    status: 'CONFIRMED',      // WebSocketìœ¼ë¡œ ì˜¨ ê±´ ì´ë¯¸ confirmëœ ìƒíƒœ
                    isConfirmed: true,
                    message: null
                };

                // ë¦¬ìŠ¤íŠ¸ ìµœìƒë‹¨ì— ì¶”ê°€
                emergencyList.unshift(emergencyItem);
                renderEmergencyCards(emergencyList);
                updateBadge(emergencyList.filter(i=>i.status==='PENDING' || i.status==='CONFIRMED').length);

                // ëª¨ë‹¬ íŒì—…
                document.getElementById('modal-detail').innerHTML =
                    `<b>${userName}</b> ì–´ë¥´ì‹ ì´ ê¸´ê¸‰ ì‹ ê³ í•˜ì…¨ìŠµë‹ˆë‹¤.<br>
               ë°œí™” ë‚´ìš©: "<strong>${fullText}</strong>"<br>
               íŠ¸ë¦¬ê±° ë‹¨ì–´: "<strong>${triggerWord}</strong>"<br>
               ë°œìƒì‹œê°„: ${new Date(alertData.reportedAt).toLocaleString('ko-KR')}`;
                document.getElementById('emergency-modal').classList.add('show');
                    });

                    console.log('âœ… ì‘ê¸‰ ì•Œë¦¼ êµ¬ë… ì„±ê³µ:', subscribePath);
                    console.log('  subscription ID:', subscription.id);

                    // ì‚¬ìš©ì ìƒíƒœ êµ¬ë…
                    const statusPath = `/topic/admin/${adminId}/user-status`;
                    const statusSubscription = stompClient.subscribe(statusPath, msg => {
                        console.log('ğŸ“Š ì‚¬ìš©ì ìƒíƒœ ë©”ì‹œì§€ ìˆ˜ì‹ :', msg.body);
                        const statusData = JSON.parse(msg.body);
                        addActivity(statusData.status==='EMERGENCY'?'emergency':'warning',
                            statusData.userName, statusData.message);
                        loadDashboardData(); // ì–´ë¥´ì‹  ì¹´ë“œ ìƒíƒœ ê°±ì‹ 
                    });

                    console.log('âœ… ì‚¬ìš©ì ìƒíƒœ êµ¬ë… ì„±ê³µ:', statusPath);
                    console.log('  subscription ID:', statusSubscription.id);

                } catch (subscribeError) {
                    console.error('âŒ êµ¬ë… ì‹¤íŒ¨:', subscribeError);
                    alert('WebSocket êµ¬ë…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + subscribeError.message);
                }
            },
            // ì—°ê²° ì‹¤íŒ¨ ì½œë°±
            (error) => {
                console.error('âŒ WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
                console.error('  ì—ëŸ¬ ìƒì„¸:', error);
                alert('WebSocket ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        );
    }

    // ğŸ”¥ ì–´ë¥´ì‹  ì¹´ë“œë¥¼ ê¸´ê¸‰ ìƒíƒœë¡œ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
    function updateUserCardToEmergency(userId, userName) {
        const card = document.querySelector(`.user-card[data-user-id="${userId}"]`);
        if (!card) {
            console.warn(`User card not found for userId: ${userId}`);
            return;
        }

        // ê¸°ì¡´ status í´ë˜ìŠ¤ ì œê±° í›„ emergency ì¶”ê°€
        card.classList.remove('status-active', 'status-warning');
        card.classList.add('status-emergency');

        // ì•„ì´ì½˜ ë³€ê²½
        const icon = card.querySelector('.user-status-icon');
        if (icon) icon.textContent = 'ğŸš¨';

        // ìƒíƒœ í…ìŠ¤íŠ¸ ë³€ê²½
        const activityType = card.querySelector('.activity-type');
        if (activityType) activityType.textContent = 'EMERGENCY ìƒíƒœ';

        console.log(`âœ… User card updated to EMERGENCY for userId: ${userId}, name: ${userName}`);
    }

    // ğŸ”¥ ì–´ë¥´ì‹  ì¹´ë“œë¥¼ ì •ìƒ ìƒíƒœë¡œ ë³µêµ¬
    function resetUserCardToNormal(userId) {
        const card = document.querySelector(`.user-card[data-user-id="${userId}"]`);
        if (!card) {
            console.warn(`User card not found for userId: ${userId}`);
            return;
        }

        // emergency í´ë˜ìŠ¤ ì œê±°, active ì¶”ê°€
        card.classList.remove('status-emergency', 'status-warning');
        card.classList.add('status-active');

        // ì•„ì´ì½˜ì„ ì •ìƒìœ¼ë¡œ ë³€ê²½
        const icon = card.querySelector('.user-status-icon');
        if (icon) icon.textContent = 'ğŸŸ¢';

        // ìƒíƒœ í…ìŠ¤íŠ¸ ë³€ê²½
        const activityType = card.querySelector('.activity-type');
        if (activityType) activityType.textContent = 'ì •ìƒ ìƒíƒœ';

        console.log(`âœ… User card reset to NORMAL for userId: ${userId}`);
    }

    // í™œë™ í”¼ë“œ
    function addActivity(type,userName,detail){
        const list = document.getElementById('activity-list');
        if(list.children.length===1 && list.children[0].textContent.includes('í™œë™ ë‚´ì—­')) {
            list.innerHTML='';
        }
        const item = document.createElement('div');
        item.className=`activity-item ${type}`;
        item.innerHTML=`<div>${type==='emergency'?'ğŸš¨':'âš ï¸'} <strong>${userName}</strong> - ${detail}</div>
                     <div class="activity-time">${new Date().toLocaleTimeString('ko-KR')}</div>`;
        list.prepend(item);
        while(list.children.length>10) list.removeChild(list.lastChild);
    }

    // ë°°ì§€ ì—…ë°ì´íŠ¸
    function updateBadge(count){
        const badge = document.getElementById('notification-badge');
        if(count>0) {
            badge.style.display='flex';
            badge.textContent = count;
        } else {
            badge.style.display='none';
        }
    }
    function clearBadge(){
        updateBadge(0);
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeModal(){
        document.getElementById('emergency-modal').classList.remove('show');
    }
    function acknowledgeReport(){
        // ëª¨ë‹¬ì—ì„œ ì²˜ë¦¬ ë²„íŠ¼ ëˆ„ë¥´ë©´ ëª¨ë‹¬ë§Œ ë‹«ê³  ë¦¬ìŠ¤íŠ¸ëŠ” ì¹´ë“œ ë²„íŠ¼ìœ¼ë¡œ ì²˜ë¦¬
        closeModal();
    }

    // ê¸°ê¸° ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
    function openDeviceModal(){
        document.getElementById('device-modal').classList.add('show');
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('device-serial').value = '';
        document.getElementById('device-location').value = '';
        document.getElementById('device-register-response').className = 'response-box';
    }
    function closeDeviceModal(){
        document.getElementById('device-modal').classList.remove('show');
    }

    // ê¸°ê¸° ë“±ë¡
    async function registerDevice(){
        const serial = document.getElementById('device-serial').value.trim();
        const location = document.getElementById('device-location').value.trim();
        const responseBox = document.getElementById('device-register-response');

        if(!serial){
            responseBox.className = 'response-box show error';
            responseBox.textContent = 'ê¸°ê¸° ì¼ë ¨ë²ˆí˜¸ëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.';
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/admins/devices`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify({
                    serialNumber: serial,
                    location: location || null
                })
            });

            if(res.ok){
                const data = await res.json();
                responseBox.className = 'response-box show success';
                responseBox.textContent = `ê¸°ê¸°ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! (ID: ${data.id})`;

                // 2ì´ˆ í›„ ëª¨ë‹¬ ë‹«ê¸°
                setTimeout(() => {
                    closeDeviceModal();
                }, 2000);
            } else {
                const error = await res.json();
                responseBox.className = 'response-box show error';
                responseBox.textContent = `ë“±ë¡ ì‹¤íŒ¨: ${error.message || res.statusText}`;
            }
        } catch(e){
            responseBox.className = 'response-box show error';
            responseBox.textContent = `ì—ëŸ¬ ë°œìƒ: ${e.message}`;
        }
    }

    // ì–´ë¥´ì‹  ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
    async function openUserModal(){
        document.getElementById('user-modal').classList.add('show');
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('user-name').value = '';
        document.getElementById('user-birthdate').value = '';
        document.getElementById('user-gender').value = '';
        document.getElementById('user-contact').value = '';
        document.getElementById('user-device').value = '';
        document.getElementById('user-medical-notes').value = '';
        document.getElementById('user-register-response').className = 'response-box';

        // ê¸°ê¸° ëª©ë¡ ë¡œë“œ
        await loadDevicesForSelect();
    }
    function closeUserModal(){
        document.getElementById('user-modal').classList.remove('show');
    }

    // ê¸°ê¸° ëª©ë¡ì„ ì…€ë ‰íŠ¸ë°•ìŠ¤ì— ë¡œë“œ (ì—°ê²° ê°€ëŠ¥í•œ ê¸°ê¸°ë§Œ)
    async function loadDevicesForSelect(){
        try {
            // availableOnly=true íŒŒë¼ë¯¸í„°ë¡œ ì—°ê²° ì•ˆëœ ê¸°ê¸°ë§Œ ìš”ì²­
            const res = await fetch(`${API_BASE}/admins/devices?availableOnly=true`, {
                headers: {Authorization: `Bearer ${accessToken}`}
            });
            if(res.ok){
                const devices = await res.json();

                const select = document.getElementById('user-device');
                select.innerHTML = '<option value="">ì—°ê²°í•  ê¸°ê¸° ì„ íƒ (í•„ìˆ˜)</option>';

                if(devices.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'ì‚¬ìš© ê°€ëŠ¥í•œ ê¸°ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê¸°ê¸°ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.';
                    option.disabled = true;
                    select.appendChild(option);
                } else {
                    devices.forEach(d => {
                        const option = document.createElement('option');
                        option.value = d.id;
                        option.textContent = `${d.serialNumber} ${d.location ? '('+d.location+')' : ''}`;
                        select.appendChild(option);
                    });
                }
            }
        } catch(e){
            console.error('ê¸°ê¸° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
        }
    }

    // ì–´ë¥´ì‹  ë“±ë¡
    async function registerUser(){
        const name = document.getElementById('user-name').value.trim();
        const birthDate = document.getElementById('user-birthdate').value;
        const gender = document.getElementById('user-gender').value;
        const contact = document.getElementById('user-contact').value.trim();
        const deviceId = document.getElementById('user-device').value;
        const medicalNotes = document.getElementById('user-medical-notes').value.trim();
        const responseBox = document.getElementById('user-register-response');

        if(!name){
            responseBox.className = 'response-box show error';
            responseBox.textContent = 'ì´ë¦„ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.';
            return;
        }

        if(!deviceId){
            responseBox.className = 'response-box show error';
            responseBox.textContent = 'ì—°ê²°í•  ê¸°ê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.';
            return;
        }

        try {
            const requestBody = {
                name: name,
                deviceId: parseInt(deviceId)
            };

            // ì„ íƒ í•„ë“œë“¤ ì¶”ê°€
            if(birthDate) requestBody.birthDate = birthDate;
            if(gender) requestBody.gender = gender;
            if(contact) requestBody.emergencyContact = contact;
            if(medicalNotes) requestBody.medicalNotes = medicalNotes;

            const res = await fetch(`${API_BASE}/admins/users`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify(requestBody)
            });

            if(res.ok){
                const data = await res.json();
                responseBox.className = 'response-box show success';
                responseBox.textContent = `ì–´ë¥´ì‹ ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! (ID: ${data.id})`;

                // 2ì´ˆ í›„ ëª¨ë‹¬ ë‹«ê¸° ë° ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨
                setTimeout(() => {
                    closeUserModal();
                    loadDashboardData();
                }, 2000);
            } else {
                const error = await res.json();
                responseBox.className = 'response-box show error';
                responseBox.textContent = `ë“±ë¡ ì‹¤íŒ¨: ${error.message || res.statusText}`;
            }
        } catch(e){
            responseBox.className = 'response-box show error';
            responseBox.textContent = `ì—ëŸ¬ ë°œìƒ: ${e.message}`;
        }
    }
</script>
</body>
</html>

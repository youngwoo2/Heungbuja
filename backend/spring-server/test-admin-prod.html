<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>í¥ë¶€ì í†µí•© API ëŒ€ì‹œë³´ë“œ (ë°°í¬ ì„œë²„)</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <!-- ê³¡ ë¶„ì„ ì‹œê°í™” ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/wavesurfer.js@7.7.15/dist/wavesurfer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Malgun Gothic',sans-serif; background:linear-gradient(135deg,#eef1f6 0%,#f8f9fb 100%); color:#333; padding:30px; }
        .container { max-width:1200px; margin:0 auto; }
        .header { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:25px; border-radius:12px; text-align:center; box-shadow:0 4px 20px rgba(0,0,0,0.1); margin-bottom:30px; }
        .header h1 { font-size:30px; font-weight:bold; margin-bottom:5px; }
        .auth-switch { display:flex; justify-content:center; gap:15px; margin-bottom:25px; }
        .auth-switch button { padding:12px 28px; border:none; border-radius:8px; font-weight:bold; font-size:15px; cursor:pointer; transition:all 0.3s; background:white; color:#667eea; box-shadow:0 3px 8px rgba(0,0,0,0.05); }
        .auth-switch button.active { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; box-shadow:0 4px 12px rgba(102,126,234,0.4); transform:translateY(-1px); }
        .section { background:white; border-radius:12px; padding:25px; margin-bottom:25px; box-shadow:0 3px 10px rgba(0,0,0,0.05); transition:all 0.2s; }
        .section.hidden { display:none; }
        .section-title { font-size:20px; font-weight:bold; color:#444; margin-bottom:20px; border-bottom:2px solid #667eea; padding-bottom:10px; }
        input, select, textarea { width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:6px; font-size:14px; }
        textarea { resize:vertical; min-height:80px; }
        .btn { padding:10px 20px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; transition:0.2s; }
        .btn-primary { background:#667eea; color:white; }
        .btn-primary:hover { background:#5568d3; }
        .btn-success { background:#2ecc71; color:white; }
        .btn-success:hover { background:#27ae60; }
        .btn-secondary { background:#f2f4f6; color:#4e5968; }
        .btn-secondary:hover { background:#e5e8eb; }
        .btn-secondary:disabled { background:#e5e8eb; color:#aaa; cursor:not-allowed; }
        .response-box { margin-top:15px; padding:15px; border-radius:6px; display:none; font-family:'Courier New',monospace; font-size:13px; }
        .response-box.show { display:block; }
        .response-box.success { background:#d4edda; border-left:4px solid #28a745; }
        .response-box.error { background:#f8d7da; border-left:4px solid #dc3545; }

        /* ì‹ ê³  ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ */
        .emergency-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .emergency-list { display:grid; grid-template-columns:repeat(auto-fill,minmax(320px,1fr)); gap:20px; margin-top:10px; }
        .emergency-card {
            background:#fff;
            border-radius:12px;
            padding:20px;
            box-shadow:0 2px 10px rgba(0,0,0,0.06);
            transition:all 0.3s ease;
            border-left: 4px solid transparent;
        }
        .emergency-card:hover { transform:translateY(-2px); box-shadow:0 4px 20px rgba(0,0,0,0.1); }
        .emergency-card.pending { border-left-color:#f39c12; background: linear-gradient(to right, #fff9f0 0%, #fff 30%); }
        .emergency-card.confirmed { border-left-color:#e74c3c; background: linear-gradient(to right, #fff5f5 0%, #fff 30%); }
        .emergency-card.resolved { border-left-color:#2ecc71; opacity: 0.7; }
        .emergency-card.false_alarm { border-left-color:#95a5a6; opacity: 0.6; }
        .emergency-card .card-header {
            display:flex;
            justify-content:space-between;
            align-items: center;
            margin-bottom:15px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        .emergency-card .report-id {
            color:#667eea;
            font-size: 16px;
            font-weight: 700;
        }
        .emergency-card .status {
            padding:5px 12px;
            border-radius:20px;
            font-size:11px;
            color:white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .emergency-card.pending .status { background:#f39c12; box-shadow: 0 2px 8px rgba(243,156,18,0.3); }
        .emergency-card.confirmed .status { background:#e74c3c; box-shadow: 0 2px 8px rgba(231,76,60,0.3); }
        .emergency-card.resolved .status { background:#2ecc71; }
        .emergency-card.false_alarm .status { background:#95a5a6; }
        .emergency-card .card-body { font-size: 13px; line-height: 1.8; }
        .emergency-card .card-body p { margin-bottom: 8px; color: #555; }
        .emergency-card .card-body strong { color: #333; font-weight: 600; }
        .emergency-card .ok { color:#2ecc71; font-weight:bold; }
        .emergency-card .no { color:#e74c3c; font-weight:bold; }
        .emergency-card .resolve-btn {
            width:100%;
            margin-top:15px;
            padding:10px;
            border:none;
            border-radius:8px;
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color:white;
            font-weight:bold;
            cursor:pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        .emergency-card .resolve-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(46,204,113,0.3);
        }
        .emergency-card .resolved-label {
            margin-top:15px;
            background:#e8f5e9;
            color:#2ecc71;
            text-align:center;
            border-radius:8px;
            padding:10px 0;
            font-weight:bold;
            font-size: 13px;
        }
        .toggle-emergency-btn {
            padding: 8px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }
        .toggle-emergency-btn:hover {
            background: #667eea;
            color: white;
        }
        .emergency-hidden {
            display: none;
        }

        /* ê¸°ê¸°-ì‚¬ìš©ì ì¹´ë“œ ê·¸ë¦¬ë“œ */
        .device-user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        /* ê¸°ê¸°-ì‚¬ìš©ì ì¹´ë“œ */
        .device-user-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: all 0.3s;
        }
        .device-user-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }

        /* ì¹´ë“œ í—¤ë” */
        .du-card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .du-device-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .du-device-icon {
            font-size: 32px;
        }
        .du-device-details h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .du-device-details p {
            font-size: 13px;
            opacity: 0.9;
        }

        /* ì‘ê¸‰ ì‚¬ì´ë Œ */
        .du-emergency-siren {
            font-size: 32px;
            opacity: 0.3;
            transition: all 0.3s;
        }
        .du-emergency-siren.active {
            animation: siren 0.6s infinite;
            opacity: 1;
            filter: drop-shadow(0 0 10px #ff4757);
        }
        @keyframes siren {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.7; }
        }

        /* ì¹´ë“œ ë°”ë”” */
        .du-card-body {
            padding: 20px;
        }
        .du-user-section {
            cursor: pointer;
            transition: all 0.3s;
        }
        .du-user-main {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .du-user-main:hover {
            background: #e9ecef;
        }
        .du-user-info-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .du-user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        .du-user-details h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #2c3e50;
        }
        .du-user-details p {
            font-size: 13px;
            color: #7f8c8d;
        }
        .du-toggle-icon {
            font-size: 20px;
            color: #7f8c8d;
            transition: transform 0.3s;
        }
        .du-toggle-icon.open {
            transform: rotate(180deg);
        }

        /* ìƒì„¸ ì •ë³´ íŒ¨ë„ */
        .du-details-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .du-details-panel.open {
            max-height: 1200px;
        }
        .du-detail-section {
            padding: 15px;
            border-top: 1px solid #e9ecef;
        }
        .du-detail-section h5 {
            font-size: 14px;
            font-weight: 600;
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        .du-activity-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .du-activity-item .time {
            color: #95a5a6;
            font-size: 11px;
        }
        .du-activity-item .type {
            font-weight: 600;
            color: #667eea;
            margin-right: 8px;
        }

        /* ë¹ˆ ìƒíƒœ */
        .du-empty {
            padding: 40px 20px;
            text-align: center;
            color: #95a5a6;
        }
        .du-empty .icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        /* ê±´ê°• ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ€ì¼ */
        .health-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .health-stat-card {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        .health-stat-card .label {
            font-size: 11px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        .health-stat-card .value {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
        }
        .health-stat-card .value.good {
            color: #2ecc71;
        }
        .health-stat-card .value.warning {
            color: #f39c12;
        }
        .health-stat-card .value.danger {
            color: #e74c3c;
        }
        .action-performance-bar {
            background: #e9ecef;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 8px;
            position: relative;
        }
        .action-performance-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }
        .action-performance-bar .label {
            position: absolute;
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
            font-size: 11px;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .trend-chart {
            display: flex;
            align-items: flex-end;
            gap: 4px;
            height: 80px;
            margin-top: 10px;
        }
        .trend-bar {
            flex: 1;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px 4px 0 0;
            min-height: 5px;
            position: relative;
        }
        .trend-bar .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .trend-bar:hover .tooltip {
            opacity: 1;
        }
        .period-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        .period-tab {
            flex: 1;
            padding: 8px;
            background: #f8f9fa;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: #7f8c8d;
            cursor: pointer;
            transition: all 0.2s;
        }
        .period-tab:hover {
            background: #e9ecef;
        }
        .period-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* í™œë™ í”¼ë“œ */
        .activity-feed { background:white; border-radius:12px; padding:25px; box-shadow:0 2px 8px rgba(0,0,0,0.05); margin-top:30px; }
        .activity-item { padding:15px; margin-bottom:10px; background:#f8f9fa; border-left:4px solid #ddd; border-radius:6px; display:flex; justify-content:space-between; align-items:center; }
        .activity-item.emergency { border-left-color:#ff4757; background:#fff5f5; }
        .activity-item.warning { border-left-color:#ffa502; background:#fffaf2; }
        .activity-time { font-size:12px; color:#999; }

        /* ëª¨ë‹¬ */
        .emergency-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000; }
        .emergency-modal.show { display:flex; }
        .modal-content { background:white; padding:40px; border-radius:16px; max-width:450px; width:90%; text-align:center; animation:modalPop 0.3s; }
        @keyframes modalPop { 0%{transform:scale(0.8);opacity:0;}100%{transform:scale(1);opacity:1;} }
        .modal-icon { font-size:80px; margin-bottom:20px; }
        .modal-title { font-size:24px; font-weight:bold; margin-bottom:10px; color:#ff4757; }
        .modal-detail { color:#666; margin-bottom:30px; line-height:1.6; }
        .modal-actions { display:flex; gap:10px; }

        /* WebSocket ìƒíƒœ í‘œì‹œ */
        .ws-status { position:fixed; bottom:20px; right:20px; padding:10px 20px; background:white; border-radius:20px; box-shadow:0 2px 8px rgba(0,0,0,0.1); font-size:12px; display:flex; align-items:center; gap:8px; }
        .ws-indicator { width:8px; height:8px; border-radius:50%; background:#2ecc71; animation:blink 2s infinite; }
        @keyframes blink { 0%,100%{opacity:1;}50%{opacity:0.3;} }
        .hidden { display:none; }
        .server-badge { background:#28a745; color:white; padding:5px 10px; border-radius:5px; font-size:12px; font-weight:bold; margin-left:10px; }

        /* ê³¡ ë“±ë¡ ëª¨ë‹¬ */
        .song-upload-modal { max-width: 900px; }

        /* ìŠ¤í… ì¸ë””ì¼€ì´í„° */
        .step-indicator { display: flex; justify-content: space-between; margin-bottom: 30px; padding: 0 20px; }
        .step { flex: 1; display: flex; flex-direction: column; align-items: center; position: relative; }
        .step:not(:last-child)::after { content: ''; position: absolute; top: 20px; left: 50%; width: 100%; height: 2px; background: #ddd; z-index: 0; }
        .step.completed:not(:last-child)::after { background: #2ecc71; }
        .step.active:not(:last-child)::after { background: linear-gradient(90deg, #667eea 0%, #ddd 100%); }
        .step-circle { width: 40px; height: 40px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; z-index: 1; margin-bottom: 8px; transition: all 0.3s; }
        .step.completed .step-circle { background: #2ecc71; }
        .step.active .step-circle { background: #667eea; animation: pulse-step 1.5s infinite; }
        @keyframes pulse-step { 0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); } 50% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); } }
        .step-label { font-size: 12px; color: #666; text-align: center; }
        .step.active .step-label { color: #667eea; font-weight: bold; }
        .step.completed .step-label { color: #2ecc71; }

        /* ìŠ¤í… ì»¨í…ì¸  */
        .step-content { display: none; min-height: 300px; }
        .step-content.active { display: block; }

        /* íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ */
        .file-upload-area { border: 2px dashed #ccc; border-radius: 10px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; margin-bottom: 15px; }
        .file-upload-area:hover { border-color: #667eea; background: #f8f9fa; }
        .file-upload-area.dragover { border-color: #667eea; background: #e7f3ff; }
        .file-upload-area input[type="file"] { display: none; }
        .file-icon { font-size: 48px; margin-bottom: 10px; }
        .file-label { font-size: 16px; color: #666; margin-bottom: 5px; }
        .file-hint { font-size: 13px; color: #999; }
        .file-selected { color: #2ecc71; font-weight: bold; margin-top: 10px; }

        /* ì§„í–‰ë¥  ë°” */
        .upload-progress { display: none; margin-top: 20px; }
        .upload-progress.show { display: block; }
        .progress-bar-upload { height: 30px; background: #e9ecef; border-radius: 15px; overflow: hidden; margin-bottom: 10px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; }
        .progress-text { text-align: center; color: #666; font-size: 14px; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸµ í¥ë¶€ì ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ <span class="server-badge">ğŸŒ ë°°í¬ ì„œë²„</span></h1>
        <p>ì‹ ê³  / ì–´ë¥´ì‹  ìƒíƒœ í†µí•© ëª¨ë‹ˆí„°ë§</p>
    </div>

    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="login-screen" class="section">
        <div class="section-title">ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</div>
        <input id="username" type="text" placeholder="ì•„ì´ë””" value="superadmin">
        <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" value="superadmin123!">
        <button class="btn btn-primary" onclick="login()">ë¡œê·¸ì¸</button>
        <div id="login-error" class="response-box error"></div>
    </div>

    <!-- ëŒ€ì‹œë³´ë“œ í™”ë©´ -->
    <div id="dashboard-screen" class="hidden">
        <div class="header">
            <h1>ğŸ¥ ê´€ë¦¬ì í˜ì´ì§€</h1>
            <div class="notification" onclick="clearBadge();">
                ğŸ””<span id="notification-badge" class="notification-badge" style="display:none;">0</span>
            </div>
        </div>

        <!-- ë“±ë¡ ë²„íŠ¼ -->
        <div class="section">
            <button class="btn btn-primary" onclick="openDeviceModal()" style="margin-right:10px;">ğŸ“± ê¸°ê¸° ë“±ë¡</button>
            <button class="btn btn-success" onclick="openUserModal()" style="margin-right:10px;">ğŸ‘´ ì–´ë¥´ì‹  ë“±ë¡</button>
            <button class="btn btn-primary" onclick="showVisualizationScreen()" style="margin-right:10px;">ğŸµ ê³¡ ì‹œê°í™”</button>
            <button class="btn btn-success" onclick="openSimpleSongUploadModal()" style="margin-right:10px;">ğŸµ ê³¡ ê°„í¸ ë“±ë¡</button>
            <button class="btn btn-secondary" onclick="openSongUploadModal()">â• ê³¡ ìˆ˜ë™ ë“±ë¡</button>
        </div>

        <div class="dashboard">
            <!-- ì‘ê¸‰ ì‹ ê³  -->
            <div class="emergency-section-header">
                <div class="section-title" style="margin-bottom:0;">ğŸš¨ ì‘ê¸‰ ì‹ ê³  í˜„í™©</div>
                <button id="toggle-emergency-btn" class="toggle-emergency-btn" onclick="toggleEmergencyList()" style="display:none;">
                    ë” ë³´ê¸° (<span id="hidden-count">0</span>)
                </button>
            </div>
            <div id="res-emg-list" class="emergency-list" style="margin-bottom:30px;">
                <div style="color:#999;text-align:center;grid-column:1/-1;">ì‘ê¸‰ ì‹ ê³ ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...</div>
            </div>

            <!-- ê¸°ê¸°-ì‚¬ìš©ì ì¹´ë“œ -->
            <div class="section-title">ğŸ“± ê¸°ê¸° ë° ì‚¬ìš©ì ê´€ë¦¬</div>
            <div id="device-user-grid" class="device-user-grid">
                <div style="color:#999;text-align:center;grid-column:1/-1;">ê¸°ê¸° ë° ì‚¬ìš©ì ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>

            <!-- í™œë™ í”¼ë“œ -->
            <div class="section-title">
                ğŸ“ í™œë™ í”¼ë“œ
                <div style="float:right; display:flex; gap:10px; font-size:14px; font-weight:normal;">
                    <select id="activity-type-filter" onchange="onActivityFilterChange()" style="padding:5px 10px; border-radius:6px; border:1px solid #ccc;">
                        <option value="">ì „ì²´ í™œë™</option>
                        <option value="MUSIC_PLAY">ğŸµ ìŒì•… ì¬ìƒ</option>
                        <option value="MUSIC_CONTROL">â¯ï¸ ìŒì•… ì œì–´</option>
                        <option value="GAME_START">ğŸ® ê²Œì„ ì‹œì‘</option>
                        <option value="GAME_END">ğŸ ê²Œì„ ì¢…ë£Œ</option>
                        <option value="MODE_CHANGE">ğŸ”„ ëª¨ë“œ ë³€ê²½</option>
                        <option value="EMERGENCY">ğŸš¨ ì‘ê¸‰ ìƒí™©</option>
                        <option value="UNKNOWN">â“ ì¸ì‹ ë¶ˆê°€</option>
                    </select>
                    <button class="btn btn-secondary" onclick="loadActivityLogs()" style="padding:5px 15px; font-size:14px;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                </div>
            </div>
            <div class="activity-feed">
                <div id="activity-list"><div style="color:#999;text-align:center;">í™œë™ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
                <div id="activity-pagination" style="margin-top:20px; text-align:center; display:none;">
                    <button class="btn btn-secondary" onclick="loadActivityPage(currentPage - 1)" id="btn-prev-page" style="margin-right:10px;">â—€ ì´ì „</button>
                    <span id="page-info" style="margin:0 15px; font-weight:bold;">í˜ì´ì§€ 1</span>
                    <button class="btn btn-secondary" onclick="loadActivityPage(currentPage + 1)" id="btn-next-page">ë‹¤ìŒ â–¶</button>
                </div>
            </div>
        </div>

        <div class="ws-status"><div class="ws-indicator"></div>ì‹¤ì‹œê°„ ì—°ê²°ë¨</div>
    </div>

    <!-- ì‹ ê³  ëª¨ë‹¬ -->
    <div id="emergency-modal" class="emergency-modal">
        <div class="modal-content">
            <div class="modal-icon">ğŸš¨</div>
            <div class="modal-title">ê¸´ê¸‰ ì‹ ê³  ë°œìƒ!</div>
            <div id="modal-detail" class="modal-detail"></div>
            <div class="modal-actions">
                <button class="btn btn-success" onclick="acknowledgeReport()">ì²˜ë¦¬ í™•ì¸</button>
                <button class="btn btn-primary" onclick="closeModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ê¸°ê¸° ë“±ë¡ ëª¨ë‹¬ -->
    <div id="device-modal" class="emergency-modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-icon">ğŸ“±</div>
            <div class="modal-title" style="color:#667eea;">ê¸°ê¸° ë“±ë¡</div>
            <div style="text-align:left; margin-top:20px;">
                <input id="device-serial" type="text" placeholder="ê¸°ê¸° ì¼ë ¨ë²ˆí˜¸ (í•„ìˆ˜)" style="margin-bottom:15px;">
                <input id="device-location" type="text" placeholder="ì„¤ì¹˜ ìœ„ì¹˜ (ì„ íƒ, ì˜ˆ: 101í˜¸)" style="margin-bottom:15px;">
                <div id="device-register-response" class="response-box"></div>
            </div>
            <div class="modal-actions" style="margin-top:20px;">
                <button class="btn btn-success" onclick="registerDevice()">ë“±ë¡</button>
                <button class="btn btn-primary" onclick="closeDeviceModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ì–´ë¥´ì‹  ë“±ë¡ ëª¨ë‹¬ -->
    <div id="user-modal" class="emergency-modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-icon">ğŸ‘´</div>
            <div class="modal-title" style="color:#2ecc71;">ì–´ë¥´ì‹  ë“±ë¡</div>
            <div style="text-align:left; margin-top:20px;">
                <input id="user-name" type="text" placeholder="ì´ë¦„ (í•„ìˆ˜)" style="margin-bottom:15px;">
                <input id="user-birthdate" type="date" placeholder="ìƒë…„ì›”ì¼ (ì„ íƒ)" style="margin-bottom:15px;">
                <select id="user-gender" style="margin-bottom:15px;">
                    <option value="">ì„±ë³„ ì„ íƒ (ì„ íƒ)</option>
                    <option value="MALE">ë‚¨ì„±</option>
                    <option value="FEMALE">ì—¬ì„±</option>
                </select>
                <input id="user-contact" type="text" placeholder="ë¹„ìƒ ì—°ë½ì²˜ (ì„ íƒ)" style="margin-bottom:15px;">
                <select id="user-device" style="margin-bottom:15px;">
                    <option value="">ì—°ê²°í•  ê¸°ê¸° ì„ íƒ (í•„ìˆ˜)</option>
                </select>
                <textarea id="user-medical-notes" placeholder="ì˜ë£Œ ë©”ëª¨ (ì„ íƒ, ì§€ë³‘, ë³µìš©ì•½ ë“±)"></textarea>
                <div id="user-register-response" class="response-box"></div>
            </div>
            <div class="modal-actions" style="margin-top:20px;">
                <button class="btn btn-success" onclick="registerUser()">ë“±ë¡</button>
                <button class="btn btn-primary" onclick="closeUserModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ê³¡ ë“±ë¡ ëª¨ë‹¬ -->
    <div id="song-upload-modal" class="emergency-modal">
        <div class="modal-content song-upload-modal">
            <div class="modal-icon">ğŸµ</div>
            <div class="modal-title" style="color:#667eea;">ê³¡ ë“±ë¡í•˜ê¸°</div>

            <!-- ìŠ¤í… ì¸ë””ì¼€ì´í„° -->
            <div class="step-indicator">
                <div class="step active" data-step="1">
                    <div class="step-circle">1</div>
                    <div class="step-label">ê¸°ë³¸ ì •ë³´</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-circle">2</div>
                    <div class="step-label">ì˜¤ë””ì˜¤+ê°€ì‚¬</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-circle">3</div>
                    <div class="step-label">ì•ˆë¬´</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-circle">4</div>
                    <div class="step-label">ë¯¸ë¦¬ë³´ê¸°</div>
                </div>
                <div class="step" data-step="5">
                    <div class="step-circle">5</div>
                    <div class="step-label">ë¶„ì„ì¤‘</div>
                </div>
                <div class="step" data-step="6">
                    <div class="step-circle">âœ“</div>
                    <div class="step-label">ì™„ë£Œ</div>
                </div>
            </div>

            <!-- 1ë‹¨ê³„: ê¸°ë³¸ ì •ë³´ -->
            <div class="step-content active" data-step="1" style="text-align:left;">
                <h3 style="margin-bottom:20px; color:#667eea;">ğŸ“ ê³¡ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</h3>
                <input id="song-title" type="text" placeholder="ê³¡ ì œëª© (ì˜ˆ: ë‚´ ê±´ê°•ì´ ì–´ë•Œì„œ)" style="margin-bottom:15px;" required>
                <input id="song-artist" type="text" placeholder="ì•„í‹°ìŠ¤íŠ¸ (ì˜ˆ: ì•„ì´ìœ )" style="margin-bottom:15px;" required>
                <input id="song-s3-key" type="text" placeholder="S3 Key (ì˜ˆ: song/ì„¸ëŒ€ë¥¼_ì‡ëŠ”_ë…¸ë˜.mp3)" style="margin-bottom:15px;" required>
                <p style="font-size:12px; color:#999; margin-top:-10px;">â€» S3ì— ì´ë¯¸ ì—…ë¡œë“œëœ ì˜¤ë””ì˜¤ íŒŒì¼ì˜ Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
            </div>

            <!-- 2ë‹¨ê³„: ì˜¤ë””ì˜¤ + ê°€ì‚¬ ì—…ë¡œë“œ -->
            <div class="step-content" data-step="2" style="text-align:left;">
                <h3 style="margin-bottom:20px; color:#667eea;">ğŸ“ ì˜¤ë””ì˜¤ì™€ ê°€ì‚¬ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</h3>
                <p style="color:#666; margin-bottom:20px;">ì˜¤ë””ì˜¤ë¥¼ ìë™ ë¶„ì„í•˜ì—¬ ë°•ìì™€ ê°€ì‚¬ íƒ€ì´ë°ì„ ìƒì„±í•©ë‹ˆë‹¤.</p>

                <div class="file-upload-area" onclick="document.getElementById('audio-file').click()">
                    <div class="file-icon">ğŸµ</div>
                    <div class="file-label">ì˜¤ë””ì˜¤ íŒŒì¼ (.mp3, .wav)</div>
                    <div class="file-hint">í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</div>
                    <div class="file-selected" id="audio-file-name"></div>
                    <input type="file" id="audio-file" accept=".mp3,.wav" onchange="handleFileSelect(event, 'audio')">
                </div>

                <div class="file-upload-area" onclick="document.getElementById('lyrics-file').click()">
                    <div class="file-icon">ğŸ“</div>
                    <div class="file-label">ê°€ì‚¬ í…ìŠ¤íŠ¸ íŒŒì¼ (.txt)</div>
                    <div class="file-hint">í•œ ì¤„ì— í•œ ê°€ì‚¬ì”© ì…ë ¥ëœ í…ìŠ¤íŠ¸ íŒŒì¼</div>
                    <div class="file-selected" id="lyrics-file-name"></div>
                    <input type="file" id="lyrics-file" accept=".txt" onchange="handleFileSelect(event, 'lyrics')">
                </div>
            </div>

            <!-- 3ë‹¨ê³„: ì•ˆë¬´ JSON ì—…ë¡œë“œ -->
            <div class="step-content" data-step="3" style="text-align:left;">
                <h3 style="margin-bottom:20px; color:#667eea;">ğŸ’ƒ ì•ˆë¬´ ì •ë³´ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</h3>
                <p style="color:#666; margin-bottom:20px;">ì•ˆë¬´ëŠ” ìˆ˜ë™ìœ¼ë¡œ ì‘ì„±í•œ JSON íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>

                <div class="file-upload-area" onclick="document.getElementById('choreography-file').click()">
                    <div class="file-icon">ğŸ’ƒ</div>
                    <div class="file-label">ì•ˆë¬´ ì •ë³´ JSON</div>
                    <div class="file-hint">í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</div>
                    <div class="file-selected" id="choreography-file-name"></div>
                    <input type="file" id="choreography-file" accept=".json" onchange="handleFileSelect(event, 'choreography')">
                </div>
            </div>

            <!-- 4ë‹¨ê³„: ë¯¸ë¦¬ë³´ê¸° -->
            <div class="step-content" data-step="4" style="text-align:left;">
                <h3 style="margin-bottom:20px; color:#667eea;">ğŸ‘€ ì—…ë¡œë“œí•  ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”</h3>
                <div id="preview-content" style="background:#f8f9fa; padding:20px; border-radius:10px;">
                    <p><strong>ê³¡ ì œëª©:</strong> <span id="preview-title">-</span></p>
                    <p><strong>ì•„í‹°ìŠ¤íŠ¸:</strong> <span id="preview-artist">-</span></p>
                    <p><strong>ì˜¤ë””ì˜¤:</strong> <span id="preview-audio">-</span></p>
                    <p><strong>ê°€ì‚¬ í…ìŠ¤íŠ¸:</strong> <span id="preview-lyrics">-</span></p>
                    <p><strong>ì•ˆë¬´ JSON:</strong> <span id="preview-choreography">-</span></p>
                </div>
            </div>

            <!-- 5ë‹¨ê³„: ì—…ë¡œë“œ ì¤‘ -->
            <div class="step-content" data-step="5" style="text-align:center;">
                <h3 style="margin-bottom:20px; color:#667eea;">â³ ì—…ë¡œë“œ ë° ë¶„ì„ ì¤‘...</h3>
                <div class="upload-progress show">
                    <div class="progress-bar-upload">
                        <div class="progress-fill" id="upload-progress-fill" style="width: 0%;">0%</div>
                    </div>
                    <div class="progress-text" id="upload-progress-text">ì˜¤ë””ì˜¤ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
                </div>
            </div>

            <!-- 6ë‹¨ê³„: ì™„ë£Œ -->
            <div class="step-content" data-step="6" style="text-align:center;">
                <div style="font-size:80px; margin-bottom:20px;">âœ…</div>
                <h2 style="color:#2ecc71; margin-bottom:10px;">ê³¡ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
                <p style="color:#666; margin-bottom:30px;">ë“±ë¡í•œ ê³¡ì„ ì‹œê°í™” í™”ë©´ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <button class="btn btn-primary" onclick="goToVisualizationAfterUpload()" style="margin-right:10px;">ğŸµ ê³¡ ì‹œê°í™” ë³´ê¸°</button>
                <button class="btn btn-secondary" onclick="closeSongUploadModal()">ë‹«ê¸°</button>
            </div>

            <!-- ë²„íŠ¼ë“¤ -->
            <div class="modal-actions" style="margin-top:30px;" id="song-upload-actions">
                <button class="btn btn-secondary" onclick="prevSongUploadStep()" id="btn-prev-step">ì´ì „</button>
                <button class="btn btn-success" onclick="nextSongUploadStep()" id="btn-next-step">ë‹¤ìŒ</button>
                <button class="btn btn-secondary" onclick="closeSongUploadModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ê³¡ ê°„í¸ ë“±ë¡ ëª¨ë‹¬ -->
    <div id="simple-song-upload-modal" class="emergency-modal">
        <div class="modal-content">
            <div class="modal-icon">ğŸµ</div>
            <div class="modal-title" style="color:#667eea;">ê³¡ ê°„í¸ ë“±ë¡</div>
            <p style="color:#666; margin-bottom:30px;">ì˜¤ë””ì˜¤ì™€ ê°€ì‚¬ë§Œ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ë¶„ì„ë©ë‹ˆë‹¤</p>

            <div style="background:#f8f9fa; padding:20px; border-radius:10px; margin-bottom:20px;">
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:bold; margin-bottom:5px;">ê³¡ ì œëª©</label>
                    <input type="text" id="simple-song-title" placeholder="ì˜ˆ: ì•„ë¦¬ë‘" style="width:100%; padding:10px; border:2px solid #ddd; border-radius:5px;">
                </div>

                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:bold; margin-bottom:5px;">ì•„í‹°ìŠ¤íŠ¸</label>
                    <input type="text" id="simple-song-artist" placeholder="ì˜ˆ: ì „í†µë¯¼ìš”" style="width:100%; padding:10px; border:2px solid #ddd; border-radius:5px;">
                </div>

                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:bold; margin-bottom:5px;">S3 Key</label>
                    <input type="text" id="simple-song-s3-key" placeholder="ì˜ˆ: song/ì•„ë¦¬ë‘.mp3" style="width:100%; padding:10px; border:2px solid #ddd; border-radius:5px;">
                    <small style="color:#666;">S3ì— ì—…ë¡œë“œëœ ì˜¤ë””ì˜¤ íŒŒì¼ì˜ ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”</small>
                </div>

                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:bold; margin-bottom:5px;">ì˜¤ë””ì˜¤ íŒŒì¼ (.mp3, .wav)</label>
                    <input type="file" id="simple-audio-file" accept=".mp3,.wav" onchange="handleSimpleFileSelect(event, 'audio')" style="width:100%; padding:10px;">
                    <div id="simple-audio-file-name" style="margin-top:5px; color:#28a745; font-weight:bold;"></div>
                </div>

                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:bold; margin-bottom:5px;">ê°€ì‚¬ íŒŒì¼ (.txt)</label>
                    <input type="file" id="simple-lyrics-file" accept=".txt" onchange="handleSimpleFileSelect(event, 'lyrics')" style="width:100%; padding:10px;">
                    <div id="simple-lyrics-file-name" style="margin-top:5px; color:#28a745; font-weight:bold;"></div>
                    <small style="color:#666;">ê°€ì‚¬ë¥¼ í•œ ì¤„ì”© ì‘ì„±í•œ í…ìŠ¤íŠ¸ íŒŒì¼</small>
                </div>
            </div>

            <div id="simple-upload-progress-container" style="display:none; margin-bottom:20px;">
                <div style="background:#e9ecef; border-radius:10px; height:40px; overflow:hidden; position:relative;">
                    <div id="simple-upload-progress-fill" style="background:linear-gradient(90deg, #667eea 0%, #764ba2 100%); height:100%; width:0%; transition:width 0.3s; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:16px;">
                        0%
                    </div>
                </div>
                <div id="simple-upload-progress-text" style="text-align:center; margin-top:10px; color:#667eea; font-weight:bold;">
                    ì—…ë¡œë“œ ì¤€ë¹„ ì¤‘...
                </div>
            </div>

            <div id="simple-upload-result" style="margin-bottom:20px;"></div>

            <!-- ë¶„ì„ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° -->
            <div id="analysis-preview-container" style="display:none; margin-bottom:20px;">
                <h3 style="color:#667eea; margin-bottom:20px; font-size:24px; text-align:center;">
                    ğŸµ AI ë¶„ì„ ê²°ê³¼ ì‹œê°í™”
                </h3>

                <!-- í†µê³„ ëŒ€ì‹œë³´ë“œ -->
                <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:15px; margin-bottom:20px;">
                    <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding:20px; border-radius:12px; text-align:center; color:white; box-shadow:0 4px 15px rgba(102,126,234,0.3);">
                        <div style="font-size:14px; opacity:0.9; margin-bottom:8px;">BPM</div>
                        <div id="preview-bpm" style="font-size:32px; font-weight:bold;">--</div>
                        <div style="font-size:11px; opacity:0.8; margin-top:5px;">í…œí¬</div>
                    </div>
                    <div style="background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding:20px; border-radius:12px; text-align:center; color:white; box-shadow:0 4px 15px rgba(240,147,251,0.3);">
                        <div style="font-size:14px; opacity:0.9; margin-bottom:8px;">ë¹„íŠ¸ ìˆ˜</div>
                        <div id="preview-beats-count" style="font-size:32px; font-weight:bold;">--</div>
                        <div style="font-size:11px; opacity:0.8; margin-top:5px;">ì´ ë°•ì</div>
                    </div>
                    <div style="background:linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding:20px; border-radius:12px; text-align:center; color:white; box-shadow:0 4px 15px rgba(79,172,254,0.3);">
                        <div style="font-size:14px; opacity:0.9; margin-bottom:8px;">ê³¡ ê¸¸ì´</div>
                        <div id="preview-duration" style="font-size:32px; font-weight:bold;">--</div>
                        <div style="font-size:11px; opacity:0.8; margin-top:5px;">ì¬ìƒ ì‹œê°„</div>
                    </div>
                    <div style="background:linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding:20px; border-radius:12px; text-align:center; color:white; box-shadow:0 4px 15px rgba(67,233,123,0.3);">
                        <div style="font-size:14px; opacity:0.9; margin-bottom:8px;">ê°€ì‚¬ ì¤„ ìˆ˜</div>
                        <div id="preview-lyrics-count-card" style="font-size:32px; font-weight:bold;">--</div>
                        <div style="font-size:11px; opacity:0.8; margin-top:5px;">ì´ ë¼ì¸</div>
                    </div>
                </div>

                <!-- ì˜¤ë””ì˜¤ íŒŒí˜• ì‹œê°í™” -->
                <div style="background:#fff; border:2px solid #667eea; border-radius:12px; padding:25px; margin-bottom:20px; box-shadow:0 4px 15px rgba(0,0,0,0.05);">
                    <h4 style="color:#667eea; margin-bottom:15px; font-size:18px; display:flex; align-items:center; gap:10px;">
                        <span>ğŸ¼</span>
                        <span>ì˜¤ë””ì˜¤ íŒŒí˜• & ë¹„íŠ¸ íƒ€ì„ë¼ì¸</span>
                    </h4>
                    <div id="waveform-container" style="background:#f8f9fa; border-radius:8px; padding:15px; margin-bottom:15px;"></div>

                    <!-- ì¬ìƒ ì»¨íŠ¸ë¡¤ -->
                    <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
                        <button id="btn-play-pause" onclick="toggleWaveformPlayback()" style="background:#667eea; color:white; border:none; padding:12px 25px; border-radius:8px; font-weight:bold; cursor:pointer; font-size:14px;">
                            â–¶ï¸ ì¬ìƒ
                        </button>
                        <div id="current-time-display" style="font-family:monospace; font-size:16px; font-weight:bold; color:#667eea;">
                            00:00.0 / 00:00.0
                        </div>
                        <div style="flex:1; background:#e9ecef; height:8px; border-radius:4px; position:relative; overflow:hidden;">
                            <div id="playback-progress" style="background:linear-gradient(90deg, #667eea 0%, #764ba2 100%); height:100%; width:0%; transition:width 0.1s;"></div>
                        </div>
                    </div>

                    <!-- ë¹„íŠ¸ ë§ˆì»¤ ë²”ë¡€ -->
                    <div style="display:flex; gap:20px; flex-wrap:wrap; font-size:12px; color:#666;">
                        <div style="display:flex; align-items:center; gap:5px;">
                            <div style="width:12px; height:12px; background:#667eea; border-radius:50%;"></div>
                            <span>ë¹„íŠ¸ ë§ˆì»¤</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <div style="width:12px; height:3px; background:#dc3545;"></div>
                            <span>Bar ì‹œì‘</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <div style="width:12px; height:12px; background:#28a745; border-radius:3px;"></div>
                            <span>ê°€ì‚¬ êµ¬ê°„</span>
                        </div>
                    </div>
                </div>

                <!-- ë¹„íŠ¸ ë¶„í¬ ì°¨íŠ¸ -->
                <div style="background:#fff; border:2px solid #764ba2; border-radius:12px; padding:25px; margin-bottom:20px; box-shadow:0 4px 15px rgba(0,0,0,0.05);">
                    <h4 style="color:#764ba2; margin-bottom:15px; font-size:18px;">ğŸ“Š ë¹„íŠ¸ ê°„ê²© ë¶„í¬ (BPM ì¼ì •ì„±)</h4>
                    <canvas id="beat-interval-chart" style="max-height:200px;"></canvas>
                </div>

                <!-- ê°€ì‚¬-ë¹„íŠ¸ ë§¤ì¹­ íƒ€ì„ë¼ì¸ -->
                <div style="background:#fff; border:2px solid #28a745; border-radius:12px; padding:25px; margin-bottom:20px; box-shadow:0 4px 15px rgba(0,0,0,0.05);">
                    <h4 style="color:#28a745; margin-bottom:15px; font-size:18px;">ğŸ¤ ê°€ì‚¬-ë¹„íŠ¸ ë§¤ì¹­ íƒ€ì„ë¼ì¸</h4>
                    <canvas id="lyrics-timeline-chart" style="max-height:300px;"></canvas>

                    <!-- ê°€ì‚¬ ëª©ë¡ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥) -->
                    <div style="margin-top:20px; max-height:250px; overflow-y:auto; background:#f8f9fa; border-radius:8px; padding:10px;">
                        <div id="preview-lyrics-list"></div>
                    </div>
                </div>

                <!-- ì•ˆë¬´ ì •ë³´ -->
                <div style="background:#fff; border:2px solid #ffc107; border-radius:10px; padding:20px;">
                    <h4 style="color:#ffc107; margin-bottom:10px;">ğŸ’ƒ ì•ˆë¬´ ì •ë³´ (ìë™ ìƒì„±)</h4>
                    <div style="background:#fff3cd; padding:15px; border-radius:8px;">
                        <p style="margin:0; color:#856404;">
                            âœ… ê¸°ë³¸ ì•ˆë¬´ íŒ¨í„´ì´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤<br>
                            ğŸ“Œ 1ì ˆ: P1 íŒ¨í„´ ë°˜ë³µ<br>
                            ğŸ“Œ 2ì ˆ:<br>
                            &nbsp;&nbsp;&nbsp;Level 1: P1 íŒ¨í„´<br>
                            &nbsp;&nbsp;&nbsp;Level 2: P1 + P2 íŒ¨í„´<br>
                            &nbsp;&nbsp;&nbsp;Level 3: P3 + P4 íŒ¨í„´
                        </p>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-success" onclick="uploadSimpleSong()" id="btn-simple-upload">ğŸ¯ ë¶„ì„ ì‹œì‘</button>
                <button class="btn btn-primary" onclick="confirmAndRegisterSong()" id="btn-confirm-register" style="display:none;">âœ… ë“±ë¡ í™•ì •</button>
                <button class="btn btn-secondary" onclick="closeSimpleSongUploadModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ê³¡ ì‹œê°í™” í™”ë©´ -->
    <div id="visualization-screen" class="hidden">
        <div class="section">
            <button class="btn btn-primary" onclick="showDashboardScreen()" style="margin-bottom:20px;">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</button>
        </div>

        <div class="section">
            <label for="song-select" style="font-weight:bold; margin-right:10px;">ê³¡ ì„ íƒ:</label>
            <select id="song-select" onchange="onSongChange()" style="width:400px;">
                <option value="">ê³¡ì„ ì„ íƒí•˜ì„¸ìš”...</option>
            </select>
        </div>

        <!-- ì‹œê°í™” íƒ­ -->
        <div class="section">
            <div style="display:flex; gap:10px; margin-bottom:20px; border-bottom:2px solid #e5e8eb; padding-bottom:10px;">
                <button id="tab-basic-viz" class="btn btn-primary" onclick="switchVisualizationTab('basic')" style="flex:1;">
                    ğŸ“Š ê¸°ë³¸ ì‹œê°í™”
                </button>
                <button id="tab-timeline-viz" class="btn btn-secondary" onclick="switchVisualizationTab('timeline')" style="flex:1;">
                    ğŸ¼ ì•…ë³´ íƒ€ì„ë¼ì¸
                </button>
            </div>

            <!-- ê¸°ë³¸ ì‹œê°í™” ì»¨í…Œì´ë„ˆ -->
            <div id="basic-visualization-container">
                <div id="song-visualization-container"></div>
            </div>

            <!-- ì•…ë³´ íƒ€ì„ë¼ì¸ ì»¨í…Œì´ë„ˆ -->
            <div id="timeline-visualization-container" style="display:none;">
                <!-- ë¡œë”© ìƒíƒœ -->
                <div id="timeline-loading" style="text-align:center; padding:50px; color:#666;">
                    <div style="font-size:48px; margin-bottom:15px;">ğŸµ</div>
                    <div style="font-size:18px;">ê³¡ì„ ì„ íƒí•˜ë©´ ì•…ë³´ íƒ€ì„ë¼ì¸ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
                </div>

                <!-- ì•…ë³´ íƒ€ì„ë¼ì¸ ì»¨í…ì¸  -->
                <div id="score-timeline-content" style="display:none;">
                    <!-- 1. ìƒë‹¨ ì¶•ì•½ íƒ€ì„ë¼ì¸ (ê³ ì •) -->
                    <div style="background:#fff; border-radius:12px; padding:20px; margin-bottom:20px; box-shadow:0 4px 15px rgba(0,0,0,0.05); position:sticky; top:0; z-index:10;">
                        <h3 style="color:#667eea; margin-bottom:15px; font-size:18px;">ğŸ“Š ì „ì²´ íƒ€ì„ë¼ì¸ (í´ë¦­í•˜ì—¬ ì´ë™)</h3>
                        <div id="overview-timeline" style="position:relative; height:80px; background:#f8f9fa; border-radius:8px; overflow:hidden;">
                            <!-- ì„¹ì…˜ ë¸”ë¡ë“¤ì´ ì—¬ê¸° ë“¤ì–´ê° -->
                            <div id="overview-sections"></div>
                            <!-- ì¬ìƒ ìœ„ì¹˜ í‘œì‹œ -->
                            <div id="overview-playhead" style="position:absolute; top:0; bottom:0; width:3px; background:#dc3545; display:none; transition:left 0.1s;">
                                <div style="position:absolute; top:-8px; left:-6px; width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent; border-top:8px solid #dc3545;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. ì¤‘ê°„ ìƒì„¸ íƒ€ì„ë¼ì¸ (ê°€ë¡œ ìŠ¤í¬ë¡¤) -->
                    <div style="background:#fff; border-radius:12px; padding:20px; margin-bottom:20px; box-shadow:0 4px 15px rgba(0,0,0,0.05);">
                        <h3 style="color:#667eea; margin-bottom:15px; font-size:18px;">ğŸ¼ ìƒì„¸ ì•…ë³´ íƒ€ì„ë¼ì¸</h3>
                        <div id="detail-timeline-scroll" style="overflow-x:auto; overflow-y:hidden; position:relative; cursor:grab;">
                            <div id="detail-timeline" style="position:relative; min-width:2000px; height:400px;">
                                <!-- ë°°ê²½ ê·¸ë¦¬ë“œ -->
                                <div id="timeline-grid"></div>
                                <!-- ì„¹ì…˜ ë ˆì´ì–´ -->
                                <div id="timeline-sections" style="position:absolute; top:0; left:0; right:0; height:60px;"></div>
                                <!-- ê°€ì‚¬ ë ˆì´ì–´ -->
                                <div id="timeline-lyrics" style="position:absolute; top:70px; left:0; right:0; height:80px;"></div>
                                <!-- ë¹„íŠ¸ ë ˆì´ì–´ -->
                                <div id="timeline-beats" style="position:absolute; top:160px; left:0; right:0; height:60px;"></div>
                                <!-- ë™ì‘ ë ˆì´ì–´ -->
                                <div id="timeline-patterns" style="position:absolute; top:230px; left:0; right:0; height:80px;"></div>
                                <!-- ì‹œê°„ì¶• -->
                                <div id="timeline-axis" style="position:absolute; top:320px; left:0; right:0; height:80px;"></div>
                                <!-- ì¬ìƒ ìœ„ì¹˜ -->
                                <div id="detail-playhead" style="position:absolute; top:0; bottom:0; width:3px; background:#dc3545; left:0; display:none;">
                                    <div style="position:absolute; top:-8px; left:-6px; width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent; border-top:8px solid #dc3545;"></div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top:10px; font-size:12px; color:#666; text-align:center;">
                            ğŸ’¡ Tip: ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ë¡œ ìŠ¤í¬ë¡¤, Shift+íœ ë¡œ ì¢Œìš° ìŠ¤í¬ë¡¤
                        </div>
                    </div>

                    <!-- 3. í•˜ë‹¨ í˜„ì¬ ì¬ìƒ ì •ë³´ íŒ¨ë„ (ê³ ì •) -->
                    <div id="playback-info-panel" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border-radius:12px; padding:25px; box-shadow:0 4px 20px rgba(102,126,234,0.3); position:sticky; bottom:20px;">
                        <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:20px; align-items:center;">
                            <div>
                                <div style="font-size:12px; opacity:0.8; margin-bottom:5px;">â±ï¸ ì¬ìƒ ì‹œê°„</div>
                                <div id="current-playback-time" style="font-size:24px; font-weight:bold; font-family:monospace;">00:00.0</div>
                            </div>
                            <div>
                                <div style="font-size:12px; opacity:0.8; margin-bottom:5px;">ğŸ¬ ì„¹ì…˜</div>
                                <div id="current-section" style="font-size:20px; font-weight:bold;">-</div>
                            </div>
                            <div>
                                <div style="font-size:12px; opacity:0.8; margin-bottom:5px;">ğŸ¤ ê°€ì‚¬</div>
                                <div id="current-lyrics" style="font-size:16px; font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">-</div>
                            </div>
                            <div>
                                <div style="font-size:12px; opacity:0.8; margin-bottom:5px;">ğŸ’ƒ ë™ì‘</div>
                                <div id="current-pattern" style="font-size:20px; font-weight:bold;">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ì˜¤ë””ì˜¤ ì•Œë¦¼
    const alertAudio = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');

    // API ë² ì´ìŠ¤
    const API_BASE = 'https://heungbuja.site/api';  // â­ ë°°í¬ ì„œë²„
    let accessToken = null;
    let adminId = null;
    let stompClient = null;

    // ì‹ ê³  ì¹´ë“œ ë°ì´í„° ì €ì¥
    let emergencyList = [];

    // í™œë™ ë¡œê·¸ í˜ì´ì§• ìƒíƒœ
    let currentPage = 0;
    let totalPages = 0;
    let currentActivityType = '';

    // ë¡œê·¸ì¸
    async function login(){
        const user = document.getElementById('username').value;
        const pwd  = document.getElementById('password').value;
        try {
            const res = await fetch(`${API_BASE}/admins/login`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({username:user, password:pwd})
            });
            if(!res.ok) throw new Error('ë¡œê·¸ì¸ ì‹¤íŒ¨');
            const data = await res.json();
            accessToken = data.accessToken;
            adminId     = data.userId;

            // ë””ë²„ê¹…: ë¡œê·¸ì¸ ì •ë³´ ì¶œë ¥
            console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ!');
            console.log('ğŸ‘¤ ì‚¬ìš©ì ID:', adminId);
            console.log('ğŸ”‘ í† í°:', accessToken ? 'ìˆìŒ (ê¸¸ì´: ' + accessToken.length + ')' : 'ì—†ìŒ');
            console.log('ğŸ­ ê¶Œí•œ:', data.role || 'ê¶Œí•œ ì •ë³´ ì—†ìŒ');
            console.log('ğŸ“¦ ì „ì²´ ì‘ë‹µ:', data);

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard-screen').classList.remove('hidden');

            // ì´ˆê¸° ë¡œë“œ
            loadDashboardData();

            // WebSocket ì—°ê²° (ì—ëŸ¬ ë¬´ì‹œ)
            try {
                connectWebSocket();
            } catch(e) {
                console.warn('WebSocket ì—°ê²° ì‹¤íŒ¨ (ì‹ ê³  ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ë¹„í™œì„±í™”)');
            }
        } catch(e) {
            const errEl = document.getElementById('login-error');
            errEl.style.display='block';
            errEl.textContent = e.message;
        }
    }

    // ë°ì´í„° ë¡œë“œ â€“ ì‹ ê³  & í™œë™ ë¡œê·¸
    async function loadDashboardData(){
        try {
            // ê¸°ì¡´ ì‹ ê³  ëª©ë¡
            const resEmg = await fetch(`${API_BASE}/emergency/admins/reports`, {
                headers: {Authorization: `Bearer ${accessToken}`}
            });
            if(resEmg.ok) {
                const list = await resEmg.json();
                emergencyList = list; // ì„œë²„ì—ì„œ ì´ë¯¸ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬ë¨
                renderEmergencyCards(emergencyList);
                // PENDING + CONFIRMEDë§Œ ë°°ì§€ì— í‘œì‹œ
                const pendingCount = emergencyList.filter(i=>i.status==='PENDING' || i.status==='CONFIRMED').length;
                updateBadge(pendingCount);
            }
            // ê¸°ê¸°-ì‚¬ìš©ì ì¹´ë“œ ë¡œë“œ
            await loadDeviceUsers();
            // í™œë™ ë¡œê·¸ ë¡œë“œ
            await loadActivityLogs();
        } catch(e) {
            console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        }
    }

    // ê¸°ê¸°-ì‚¬ìš©ì ì¹´ë“œ ë¡œë“œ
    async function loadDeviceUsers() {
        try {
            const grid = document.getElementById('device-user-grid');
            grid.innerHTML = '<div style="color:#999;text-align:center;grid-column:1/-1;">ê¸°ê¸° ë° ì‚¬ìš©ì ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            // ê¸°ê¸°, ì‚¬ìš©ì, ì‘ê¸‰ì‹ ê³  ë°ì´í„° ë³‘ë ¬ ë¡œë“œ
            const [devicesRes, usersRes, emergenciesRes] = await Promise.all([
                fetch(`${API_BASE}/admins/devices`, { headers: { Authorization: `Bearer ${accessToken}` }}),
                fetch(`${API_BASE}/admins/users`, { headers: { Authorization: `Bearer ${accessToken}` }}),
                fetch(`${API_BASE}/emergency/admins/reports`, { headers: { Authorization: `Bearer ${accessToken}` }})
            ]);

            const devices = await devicesRes.json();
            const users = await usersRes.json();
            const emergencies = await emergenciesRes.json();

            if (devices.length === 0) {
                grid.innerHTML = '<div class="du-empty"><div class="icon">ğŸ“±</div><p>ë“±ë¡ëœ ê¸°ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
                return;
            }

            // ì¹´ë“œ ë Œë”ë§
            grid.innerHTML = '';
            devices.forEach(device => {
                const user = users.find(u => u.deviceId === device.id);
                const hasEmergency = user && emergencies.some(e => e.userId === user.id && e.status === 'CONFIRMED');
                const card = createDeviceUserCard(device, user, hasEmergency);
                grid.appendChild(card);
            });
        } catch (e) {
            console.error('ê¸°ê¸°-ì‚¬ìš©ì ë¡œë“œ ì‹¤íŒ¨:', e);
            const grid = document.getElementById('device-user-grid');
            grid.innerHTML = '<div class="du-empty"><div class="icon">âŒ</div><p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p></div>';
        }
    }

    // ê¸°ê¸°-ì‚¬ìš©ì ì¹´ë“œ ìƒì„±
    function createDeviceUserCard(device, user, hasEmergency) {
        const card = document.createElement('div');
        card.className = 'device-user-card';

        const cardHTML = `
            <div class="du-card-header">
                <div class="du-device-info">
                    <div class="du-device-icon">ğŸ“±</div>
                    <div class="du-device-details">
                        <h3>ê¸°ê¸° #${device.id}</h3>
                        <p>${device.serialNumber || 'ì‹œë¦¬ì–¼ ë²ˆí˜¸ ì—†ìŒ'}</p>
                    </div>
                </div>
                <div class="du-emergency-siren ${hasEmergency ? 'active' : ''}">ğŸš¨</div>
            </div>
            <div class="du-card-body">
                ${user ? `
                    <div class="du-user-section" onclick="toggleDeviceUserDetails(${device.id})">
                        <div class="du-user-main">
                            <div class="du-user-info-left">
                                <div class="du-user-avatar">ğŸ‘¤</div>
                                <div class="du-user-details">
                                    <h4>${user.name}</h4>
                                    <p>${user.birthDate || 'ìƒë…„ì›”ì¼ ì •ë³´ ì—†ìŒ'}</p>
                                </div>
                            </div>
                            <div class="du-toggle-icon" id="toggle-${device.id}">â–¼</div>
                        </div>
                    </div>
                    <div class="du-details-panel" id="details-${device.id}">
                        <div class="du-detail-section">
                            <h5>ğŸ’ª ê±´ê°• ëª¨ë‹ˆí„°ë§</h5>
                            <div class="period-tabs" id="unified-tabs-${user.id}">
                                <button class="period-tab active" onclick="switchUnifiedPeriod(${user.id}, 1, event)">ì˜¤ëŠ˜</button>
                                <button class="period-tab" onclick="switchUnifiedPeriod(${user.id}, 7, event)">ì¼ì£¼ì¼</button>
                                <button class="period-tab" onclick="switchUnifiedPeriod(${user.id}, 30, event)">í•œë‹¬</button>
                            </div>
                            <div id="health-stats-${user.id}">
                                <div style="text-align:center; padding:20px; color:#999; font-size:13px;">
                                    ê±´ê°• ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                                </div>
                            </div>
                        </div>
                        <div class="du-detail-section">
                            <h5>ğŸ¯ ë™ì‘ë³„ ìˆ˜í–‰ë„</h5>
                            <div id="action-performance-${user.id}">
                                <div style="text-align:center; padding:20px; color:#999; font-size:13px;">
                                    ìˆ˜í–‰ë„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                                </div>
                            </div>
                        </div>
                        <div class="du-detail-section">
                            <h5>ğŸ“ˆ í™œë™ ì¶”ì´</h5>
                            <div id="activity-trend-${user.id}">
                                <div style="text-align:center; padding:20px; color:#999; font-size:13px;">
                                    í™œë™ ì¶”ì´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                                </div>
                            </div>
                        </div>
                        <div class="du-detail-section">
                            <h5>ğŸ“Š ìµœê·¼ í™œë™</h5>
                            <div id="activities-${user.id}">
                                <div style="text-align:center; padding:20px; color:#999; font-size:13px;">
                                    í™œë™ ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                                </div>
                            </div>
                        </div>
                    </div>
                ` : `
                    <div class="du-empty">
                        <div class="icon">ğŸ‘¤</div>
                        <p>ì—°ê²°ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                `}
            </div>
        `;

        card.innerHTML = cardHTML;
        return card;
    }

    // ì‚¬ìš©ì ìƒì„¸ ì •ë³´ í† ê¸€
    async function toggleDeviceUserDetails(deviceId) {
        const panel = document.getElementById(`details-${deviceId}`);
        const icon = document.getElementById(`toggle-${deviceId}`);

        if (panel.classList.contains('open')) {
            panel.classList.remove('open');
            icon.classList.remove('open');
        } else {
            panel.classList.add('open');
            icon.classList.add('open');

            // ë°ì´í„° ë¡œë“œ (í•œ ë²ˆë§Œ)
            if (!panel.dataset.loaded) {
                await loadUserHealthData(deviceId);
                panel.dataset.loaded = 'true';
            }
        }
    }

    // ì‚¬ìš©ì ê±´ê°• ë°ì´í„° ë¡œë“œ (í†µí•©)
    async function loadUserHealthData(deviceId) {
        try {
            // deviceIdë¡œ user ì°¾ê¸°
            const usersRes = await fetch(`${API_BASE}/admins/users`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            const users = await usersRes.json();
            const user = users.find(u => u.deviceId === deviceId);

            if (!user) {
                console.error('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            // ë³‘ë ¬ë¡œ ëª¨ë“  ë°ì´í„° ë¡œë“œ
            await Promise.all([
                loadGameStats(user.id),
                loadActionPerformance(user.id, 1),  // ê¸°ë³¸ê°’: ì˜¤ëŠ˜
                loadActivityTrend(user.id, 1),  // ê¸°ë³¸ê°’: ì˜¤ëŠ˜
                loadUserActivitiesForCard(deviceId)
            ]);
        } catch (error) {
            console.error('ê±´ê°• ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    // ê²Œì„ í†µê³„ ë¡œë“œ
    async function loadGameStats(userId) {
        try {
            const response = await fetch(`${API_BASE}/admins/users/${userId}/game-stats`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });

            if (!response.ok) {
                throw new Error('ê²Œì„ í†µê³„ ë¡œë“œ ì‹¤íŒ¨');
            }

            const data = await response.json();
            renderGameStats(userId, data);
        } catch (error) {
            console.error('ê²Œì„ í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
            document.getElementById(`health-stats-${userId}`).innerHTML =
                '<div style="color:#e74c3c; padding:10px; text-align:center;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
        }
    }

    // ê²Œì„ í†µê³„ ë Œë”ë§
    function renderGameStats(userId, data) {
        const container = document.getElementById(`health-stats-${userId}`);

        if (!data || data.totalGames === 0) {
            container.innerHTML = '<div style="color:#999; padding:10px; text-align:center;">ì•„ì§ ê²Œì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
            return;
        }

        const avgScore = data.overallAverageScore || 0;
        const scoreClass = avgScore >= 2.5 ? 'good' : avgScore >= 2.0 ? 'warning' : 'danger';

        const html = `
            <div class="health-stats">
                <div class="health-stat-card">
                    <div class="label">ì´ ê²Œì„ ìˆ˜</div>
                    <div class="value">${data.totalGames}íšŒ</div>
                </div>
                <div class="health-stat-card">
                    <div class="label">í‰ê·  ì ìˆ˜</div>
                    <div class="value ${scoreClass}">${avgScore.toFixed(2)}</div>
                </div>
                <div class="health-stat-card">
                    <div class="label">PERFECT ë¹„ìœ¨</div>
                    <div class="value good">${data.perfectRate.toFixed(1)}%</div>
                </div>
                <div class="health-stat-card">
                    <div class="label">ì™„ë£Œìœ¨</div>
                    <div class="value">${data.totalGames > 0 ? ((data.completedGames / data.totalGames) * 100).toFixed(1) : 0}%</div>
                </div>
            </div>
            ${data.lastPlayedAt ? `
                <div style="font-size:11px; color:#7f8c8d; text-align:center; margin-top:10px;">
                    ë§ˆì§€ë§‰ í”Œë ˆì´: ${new Date(data.lastPlayedAt).toLocaleString('ko-KR')}
                </div>
            ` : ''}
        `;

        container.innerHTML = html;
    }

    // ë™ì‘ë³„ ìˆ˜í–‰ë„ ë¡œë“œ
    async function loadActionPerformance(userId, periodDays = 1) {
        try {
            const url = periodDays ?
                `${API_BASE}/admins/users/${userId}/action-performance?periodDays=${periodDays}` :
                `${API_BASE}/admins/users/${userId}/action-performance`;

            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });

            if (!response.ok) {
                throw new Error('ë™ì‘ë³„ ìˆ˜í–‰ë„ ë¡œë“œ ì‹¤íŒ¨');
            }

            const data = await response.json();
            renderActionPerformance(userId, data, periodDays);
        } catch (error) {
            console.error('ë™ì‘ë³„ ìˆ˜í–‰ë„ ë¡œë“œ ì‹¤íŒ¨:', error);
            document.getElementById(`action-performance-${userId}`).innerHTML =
                '<div style="color:#e74c3c; padding:10px; text-align:center;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
        }
    }

    // í†µí•© ê¸°ê°„ ì „í™˜ í•¨ìˆ˜ (ë™ì‘ë³„ ìˆ˜í–‰ë„ + í™œë™ ì¶”ì´ ë™ì‹œ ì—…ë°ì´íŠ¸)
    function switchUnifiedPeriod(userId, periodDays, event) {
        // íƒ­ í™œì„±í™” ìƒíƒœ ë³€ê²½
        const tabs = event.target.parentElement.querySelectorAll('.period-tab');
        tabs.forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');

        // ë‘ ì„¹ì…˜ ë™ì‹œì— ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
        loadActionPerformance(userId, periodDays);
        loadActivityTrend(userId, periodDays);
    }

    // ë™ì‘ë³„ ìˆ˜í–‰ë„ ë Œë”ë§
    function renderActionPerformance(userId, data, periodDays = 1) {
        const container = document.getElementById(`action-performance-${userId}`);

        if (!data || !data.topActions || data.topActions.length === 0) {
            const periodLabel = periodDays === 1 ? 'ì˜¤ëŠ˜' : periodDays === 7 ? 'ì¼ì£¼ì¼' : 'í•œë‹¬';
            container.innerHTML = `<div style="color:#999; padding:10px; text-align:center;">${periodLabel} ìˆ˜í–‰ë„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
            return;
        }

        const periodLabel = periodDays === 1 ? 'ì˜¤ëŠ˜' : periodDays === 7 ? 'ì¼ì£¼ì¼' : 'í•œë‹¬';
        let html = `<div style="font-size:11px; color:#7f8c8d; margin-bottom:10px; text-align:center;">${periodLabel} ê¸°ì¤€</div>`;

        // ì˜í•˜ëŠ” ë™ì‘ 1ê°œë§Œ í‘œì‹œ
        if (data.topActions && data.topActions.length > 0) {
            const topAction = data.topActions[0];
            const percentage = (topAction.averageScore / 3.0) * 100;
            html += '<div style="margin-bottom:10px; font-size:12px; font-weight:600; color:#2ecc71;">âœ… ê°€ì¥ ì˜í•˜ëŠ” ë™ì‘</div>';
            html += `
                <div class="action-performance-bar">
                    <div class="fill" style="width:${percentage}%"></div>
                    <div class="label">${topAction.actionName} (${topAction.averageScore.toFixed(2)}ì , ${topAction.attemptCount}íšŒ)</div>
                </div>
            `;
        }

        // ëª»í•˜ëŠ” ë™ì‘ 1ê°œë§Œ í‘œì‹œ
        if (data.weakActions && data.weakActions.length > 0) {
            const weakAction = data.weakActions[0];
            const percentage = (weakAction.averageScore / 3.0) * 100;
            html += '<div style="margin:15px 0 10px 0; font-size:12px; font-weight:600; color:#f39c12;">âš ï¸ ê°œì„ ì´ í•„ìš”í•œ ë™ì‘</div>';
            html += `
                <div class="action-performance-bar">
                    <div class="fill" style="width:${percentage}%; background:linear-gradient(90deg, #f39c12 0%, #e74c3c 100%);"></div>
                    <div class="label">${weakAction.actionName} (${weakAction.averageScore.toFixed(2)}ì , ${weakAction.attemptCount}íšŒ)</div>
                </div>
            `;
        }

        container.innerHTML = html;
    }

    // í™œë™ ì¶”ì´ ë¡œë“œ
    async function loadActivityTrend(userId, periodDays = 1) {
        try {
            const response = await fetch(`${API_BASE}/admins/users/${userId}/activity-trend?periodDays=${periodDays}`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });

            if (!response.ok) {
                throw new Error('í™œë™ ì¶”ì´ ë¡œë“œ ì‹¤íŒ¨');
            }

            const data = await response.json();
            renderActivityTrend(userId, data, periodDays);
        } catch (error) {
            console.error('í™œë™ ì¶”ì´ ë¡œë“œ ì‹¤íŒ¨:', error);
            document.getElementById(`activity-trend-${userId}`).innerHTML =
                '<div style="color:#e74c3c; padding:10px; text-align:center;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
        }
    }


    // í™œë™ ì¶”ì´ ë Œë”ë§
    function renderActivityTrend(userId, data, periodDays = 1) {
        const container = document.getElementById(`activity-trend-${userId}`);

        if (!data || !data.dailyActivities || data.dailyActivities.length === 0) {
            container.innerHTML = '<div style="color:#999; padding:10px; text-align:center;">í™œë™ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            return;
        }

        const maxGames = Math.max(...data.dailyActivities.map(d => d.gameCount), 1);

        const trendIcon = data.trend === 'INCREASING' ? 'ğŸ“ˆ' : data.trend === 'DECREASING' ? 'ğŸ“‰' : 'â¡ï¸';
        const trendText = data.trend === 'INCREASING' ? 'ì¦ê°€' : data.trend === 'DECREASING' ? 'ê°ì†Œ' : 'ì•ˆì •';
        const trendColor = data.trend === 'INCREASING' ? '#2ecc71' : data.trend === 'DECREASING' ? '#e74c3c' : '#7f8c8d';

        const periodLabel = periodDays === 1 ? 'ì˜¤ëŠ˜' : periodDays === 7 ? 'ì¼ì£¼ì¼' : 'í•œë‹¬';

        let html = `
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:12px;">
                <div>
                    <span style="color:#7f8c8d;">${periodLabel} ì´ ê²Œì„:</span>
                    <span style="font-weight:600;">${data.totalGames}íšŒ</span>
                </div>
                ${periodDays > 1 ? `
                    <div style="color:${trendColor}; font-weight:600;">
                        ${trendIcon} ${trendText}
                    </div>
                ` : ''}
            </div>
            <div class="trend-chart">
        `;

        data.dailyActivities.forEach(day => {
            const height = (day.gameCount / maxGames) * 100;
            html += `
                <div class="trend-bar" style="height:${height || 5}%">
                    <div class="tooltip">
                        ${day.date}<br>
                        ${day.dayOfWeek}<br>
                        ${day.gameCount}íšŒ
                        ${day.averageScore > 0 ? '<br>í‰ê· : ' + day.averageScore.toFixed(2) + 'ì ' : ''}
                    </div>
                </div>
            `;
        });

        html += `
            </div>
        `;

        if (periodDays > 1) {
            html += `
                <div style="font-size:11px; color:#7f8c8d; text-align:center; margin-top:10px;">
                    í‰ê·  ì¼ì¼: <strong>${data.averageDailyGames.toFixed(1)}íšŒ</strong> Â·
                    ê°€ì¥ í™œë°œí•œ ìš”ì¼: <strong>${data.mostActiveDayOfWeek}</strong>
                </div>
            `;
        }

        container.innerHTML = html;
    }

    // ì¹´ë“œìš© ì‚¬ìš©ì í™œë™ ë¡œë“œ
    async function loadUserActivitiesForCard(deviceId) {
        try {
            // deviceIdë¡œ user ì°¾ê¸°
            const usersRes = await fetch(`${API_BASE}/admins/users`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            const users = await usersRes.json();
            const user = users.find(u => u.deviceId === deviceId);

            if (!user) return;

            const activitiesDiv = document.getElementById(`activities-${user.id}`);

            // ìµœê·¼ í™œë™ ë¡œê·¸ ë¡œë“œ
            const res = await fetch(
                `${API_BASE}/admins/activity-logs/users/${user.id}?page=0&size=10`,
                { headers: { 'Authorization': `Bearer ${accessToken}` }}
            );
            const data = await res.json();

            if (data.content && data.content.length > 0) {
                activitiesDiv.innerHTML = data.content.map(log => `
                    <div class="du-activity-item">
                        <div>
                            <span class="type">${log.activityType}</span>
                            <span>${log.activitySummary}</span>
                        </div>
                        <div class="time">${new Date(log.createdAt).toLocaleString('ko-KR')}</div>
                    </div>
                `).join('');
            } else {
                activitiesDiv.innerHTML = '<p style="text-align:center; color:#95a5a6; padding:20px; font-size:13px;">ìµœê·¼ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤</p>';
            }
        } catch (e) {
            console.error('í™œë™ ë¡œë“œ ì‹¤íŒ¨:', e);
            const activitiesDiv = document.getElementById(`activities-${user.id}`);
            if (activitiesDiv) {
                activitiesDiv.innerHTML = '<p style="text-align:center; color:#e74c3c; padding:20px; font-size:13px;">í™œë™ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>';
            }
        }
    }

    // ì‚¬ìš©ìë³„ í™œë™ ìš”ì•½ ë¡œë“œ (ìµëª…í™”)
    async function loadUserActivitySummary() {
        try {
            // ìµœê·¼ 1ì£¼ì¼ í™œë™ ë¡œê·¸ ì¡°íšŒ
            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const startDate = weekAgo.toISOString().slice(0, 19);
            const endDate = now.toISOString().slice(0, 19);

            const res = await fetch(
                `${API_BASE}/admins/activity-logs/range?startDate=${encodeURIComponent(startDate)}&endDate=${encodeURIComponent(endDate)}&page=0&size=1000`,
                { headers: { Authorization: `Bearer ${accessToken}` }}
            );

            if (res.ok) {
                const data = await res.json();
                const logs = data.content || [];

                // ì‚¬ìš©ìë³„ë¡œ ê·¸ë£¹í™”
                const userActivityMap = {};
                logs.forEach(log => {
                    const userId = log.userId;
                    if (!userActivityMap[userId]) {
                        userActivityMap[userId] = {
                            userId: userId,
                            userName: log.userName,
                            activities: [],
                            stats: {
                                MUSIC_PLAY: 0,
                                GAME_START: 0,
                                EMERGENCY: 0,
                                total: 0
                            }
                        };
                    }
                    userActivityMap[userId].activities.push(log);
                    userActivityMap[userId].stats[log.activityType] =
                        (userActivityMap[userId].stats[log.activityType] || 0) + 1;
                    userActivityMap[userId].stats.total++;
                });

                renderUserActivitySummary(Object.values(userActivityMap));
            } else {
                console.error('ì‚¬ìš©ì í™œë™ ìš”ì•½ ë¡œë“œ ì‹¤íŒ¨:', res.status);
                document.getElementById('users-grid').innerHTML =
                    '<div style="color:#999;text-align:center;grid-column:1/-1;">í™œë™ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
            }
        } catch (e) {
            console.error('ì‚¬ìš©ì í™œë™ ìš”ì•½ ë¡œë“œ ì—ëŸ¬:', e);
            document.getElementById('users-grid').innerHTML =
                '<div style="color:#999;text-align:center;grid-column:1/-1;">í™œë™ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ</div>';
        }
    }

    // ì‚¬ìš©ìë³„ í™œë™ ìš”ì•½ ë Œë”ë§ (ìµëª…í™”)
    function renderUserActivitySummary(userActivities) {
        const grid = document.getElementById('users-grid');

        if (userActivities.length === 0) {
            grid.innerHTML = '<div style="color:#999;text-align:center;grid-column:1/-1;">ìµœê·¼ í™œë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
            return;
        }

        // í™œë™ëŸ‰ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ (ë§ì€ ìˆœ)
        userActivities.sort((a, b) => b.stats.total - a.stats.total);

        grid.innerHTML = '';
        userActivities.forEach(user => {
            // ìµëª…í™”: ì´ë¦„ì˜ ì²« ê¸€ìë§Œ ë³´ì´ê³  ë‚˜ë¨¸ì§€ëŠ” *
            const anonymizedName = user.userName ?
                user.userName[0] + '*'.repeat(Math.min(user.userName.length - 1, 2)) :
                'ìµëª…';

            // ìƒíƒœ ê²°ì •
            let cls = 'status-active';
            let icon = 'ğŸŸ¢';
            let statusText = 'ì •ìƒ';

            if (user.stats.EMERGENCY > 0) {
                cls = 'status-emergency';
                icon = 'ğŸš¨';
                statusText = 'ì‘ê¸‰';
            } else if (user.stats.total === 0) {
                cls = 'status-warning';
                icon = 'ğŸŸ¡';
                statusText = 'ë¹„í™œì„±';
            }

            // ìµœê·¼ í™œë™ (ìµœëŒ€ 5ê°œ)
            const recentActivities = user.activities
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 5);

            const activityIcons = {
                'MUSIC_PLAY': 'ğŸµ',
                'MUSIC_CONTROL': 'â¯ï¸',
                'GAME_START': 'ğŸ®',
                'GAME_END': 'ğŸ',
                'MODE_CHANGE': 'ğŸ”„',
                'EMERGENCY': 'ğŸš¨',
                'UNKNOWN': 'â“'
            };

            let activitiesHtml = '<div style="margin-top:12px; padding-top:12px; border-top:1px solid #eee;">';
            activitiesHtml += '<div style="font-size:12px; color:#999; margin-bottom:8px;">ìµœê·¼ í™œë™ (1ì£¼ì¼)</div>';

            if (recentActivities.length > 0) {
                recentActivities.forEach(a => {
                    const timeAgo = getTimeAgo(new Date(a.createdAt));
                    const actIcon = activityIcons[a.activityType] || 'ğŸ“';
                    activitiesHtml += `<div style="font-size:13px; color:#666; margin-bottom:4px;">${actIcon} ${a.activitySummary} <span style="color:#999; font-size:11px;">(${timeAgo})</span></div>`;
                });
            } else {
                activitiesHtml += '<div style="font-size:12px; color:#999;">í™œë™ ì—†ìŒ</div>';
            }
            activitiesHtml += '</div>';

            const div = document.createElement('div');
            div.className = `user-card ${cls}`;
            div.setAttribute('data-user-id', user.userId);
            div.innerHTML = `
                <div class="user-header">
                    <span class="user-status-icon">${icon}</span>
                    <div>
                        <div class="user-name">${anonymizedName} (ID: ${user.userId})</div>
                        <div class="user-room">ì´ í™œë™: ${user.stats.total}íšŒ</div>
                    </div>
                </div>
                <div class="user-activity">
                    <div class="activity-type">${statusText} ìƒíƒœ</div>
                    <div class="activity-detail">
                        ğŸµ ìŒì•…: ${user.stats.MUSIC_PLAY || 0}íšŒ |
                        ğŸ® ê²Œì„: ${user.stats.GAME_START || 0}íšŒ
                        ${user.stats.EMERGENCY ? ` | ğŸš¨ ì‘ê¸‰: ${user.stats.EMERGENCY}íšŒ` : ''}
                    </div>
                </div>
                ${activitiesHtml}
            `;
            grid.appendChild(div);
        });
    }

    // ì‹œê°„ ê²½ê³¼ í‘œì‹œ (ì˜ˆ: "3ì‹œê°„ ì „")
    function getTimeAgo(date) {
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (days > 0) return `${days}ì¼ ì „`;
        if (hours > 0) return `${hours}ì‹œê°„ ì „`;
        if (minutes > 0) return `${minutes}ë¶„ ì „`;
        return 'ë°©ê¸ˆ ì „';
    }

    // ì‹ ê³  ì¹´ë“œ ë Œë”ë§
    let emergencyExpanded = false;
    const EMERGENCY_PREVIEW_COUNT = 3; // ê¸°ë³¸ìœ¼ë¡œ ë³´ì—¬ì¤„ ê°œìˆ˜

    function renderEmergencyCards(list){
        const container = document.getElementById('res-emg-list');
        const toggleBtn = document.getElementById('toggle-emergency-btn');
        const hiddenCount = document.getElementById('hidden-count');

        if (!Array.isArray(list) || list.length === 0) {
            container.className = 'emergency-list';
            container.innerHTML = '<div style="color:#999;text-align:center;grid-column:1/-1; padding:30px;">âœ… ì‹ ê³  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            toggleBtn.style.display = 'none';
            return;
        }

        container.className = 'emergency-list';

        // ìƒíƒœ í•œê¸€ ë³€í™˜
        const statusText = {
            'PENDING': 'ëŒ€ê¸°ì¤‘',
            'CONFIRMED': 'í™•ì •ë¨',
            'RESOLVED': 'ì²˜ë¦¬ì™„ë£Œ',
            'FALSE_ALARM': 'ì˜¤íƒ'
        };

        // ë” ë³´ê¸° ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€ ê²°ì •
        if (list.length > EMERGENCY_PREVIEW_COUNT) {
            toggleBtn.style.display = 'block';
            hiddenCount.textContent = list.length - EMERGENCY_PREVIEW_COUNT;
        } else {
            toggleBtn.style.display = 'none';
        }

        container.innerHTML = list.map((item, index) => {
            const isHidden = !emergencyExpanded && index >= EMERGENCY_PREVIEW_COUNT;
            return `
          <div class="emergency-card ${item.status.toLowerCase()} ${isHidden ? 'emergency-hidden' : ''}" data-emergency-index="${index}">
            <div class="card-header">
              <span class="report-id">#${item.reportId}</span>
              <span class="status">${statusText[item.status] || item.status}</span>
            </div>
            <div class="card-body">
              <p><strong>ì‹ ê³ ì:</strong> ${item.userName}</p>
              <p><strong>ë°œí™” ë‚´ìš©:</strong> "${item.fullText || item.triggerWord}"</p>
              <p><strong>í™•ì¸ì—¬ë¶€:</strong>
                <span class="${item.isConfirmed?'ok':'no'}">
                  ${item.isConfirmed?'âœ“ í™•ì¸ë¨':'âœ— ë¯¸í™•ì¸'}
                </span>
              </p>
              <p><strong>ë°œìƒì‹œê°„:</strong> ${new Date(item.reportedAt).toLocaleString('ko-KR', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
            </div>
            ${item.status==='PENDING' || item.status==='CONFIRMED'
            ? `<button class="resolve-btn" onclick="handleEmergencyResolve(${item.reportId})">âœ… ì²˜ë¦¬ ì™„ë£Œ</button>`
            : `<div class="resolved-label">âœ” ì²˜ë¦¬ ì™„ë£Œ</div>`
        }
          </div>
        `;
        }).join('');
    }

    function toggleEmergencyList() {
        emergencyExpanded = !emergencyExpanded;
        const toggleBtn = document.getElementById('toggle-emergency-btn');
        const cards = document.querySelectorAll('.emergency-card');

        cards.forEach((card, index) => {
            if (index >= EMERGENCY_PREVIEW_COUNT) {
                if (emergencyExpanded) {
                    card.classList.remove('emergency-hidden');
                } else {
                    card.classList.add('emergency-hidden');
                }
            }
        });

        toggleBtn.textContent = emergencyExpanded ? 'ì ‘ê¸°' : `ë” ë³´ê¸° (${emergencyList.length - EMERGENCY_PREVIEW_COUNT})`;
    }

    // ì‹ ê³  ì²˜ë¦¬ ë²„íŠ¼
    async function handleEmergencyResolve(id){
        if (!accessToken) { alert('ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”!'); return; }
        const notes = 'ê´€ë¦¬ì í™•ì¸ ì™„ë£Œ';
        try {
            const res = await fetch(`${API_BASE}/emergency/admins/reports/${id}?notes=${encodeURIComponent(notes)}`, {
                method:'PUT',
                headers:{Authorization:`Bearer ${accessToken}`}
            });
            if (res.ok) {
                alert(`#${id} ì‹ ê³ ê°€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);

                // ğŸ”¥ í•´ë‹¹ ì‹ ê³ ì˜ userId ì°¾ê¸°
                const report = emergencyList.find(item => item.reportId === id);
                if (report) {
                    // ì–´ë¥´ì‹  ì¹´ë“œë¥¼ ì •ìƒ ìƒíƒœë¡œ ë³µêµ¬
                    resetUserCardToNormal(report.userId);
                }

                // ìƒíƒœ ë³€ê²½ ë°˜ì˜
                emergencyList = emergencyList.map(item => item.reportId===id ? {...item, status:'RESOLVED'} : item);
                renderEmergencyCards(emergencyList);
                updateBadge(emergencyList.filter(i=>i.status==='PENDING' || i.status==='CONFIRMED').length);
            } else {
                const err = await res.json();
                alert('ì²˜ë¦¬ ì‹¤íŒ¨: '+(err.message||res.statusText));
            }
        } catch(e){
            alert('ì—ëŸ¬ ë°œìƒ: '+e.message);
        }
    }

    // WebSocket ì—°ê²°
    function connectWebSocket(){
        try {
            const socket = new SockJS(`${API_BASE}/ws`);
            stompClient = Stomp.over(socket);

            // ì—ëŸ¬ í•¸ë“¤ëŸ¬ ì¶”ê°€
            socket.onclose = function() {
                console.warn('WebSocket ì—°ê²° ì¢…ë£Œ (ì‹ ê³  ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ë¹„í™œì„±í™”)');
            };
            socket.onerror = function(error) {
                console.warn('WebSocket ì—ëŸ¬ (ë¬´ì‹œë¨):', error);
            };

            stompClient.connect({}, () => {
            console.log('âœ… WebSocket ì—°ê²° ì„±ê³µ!');
            console.log('ğŸ‘¤ í˜„ì¬ adminId:', adminId);
            const subscribePath = `/topic/admin/${adminId}/emergency`;
            console.log('ğŸ”” êµ¬ë… ê²½ë¡œ:', subscribePath);

            stompClient.subscribe(subscribePath, msg => {
                console.log('ğŸ“© WebSocket ë©”ì‹œì§€ ìˆ˜ì‹ !', msg.body);
                const alertData = JSON.parse(msg.body);
                alertAudio.play();

                // Null-safe ì²˜ë¦¬
                const userName = alertData.userName || 'ì•Œ ìˆ˜ ì—†ìŒ';
                const triggerWord = alertData.triggerWord || 'ë¯¸ìƒ';
                const fullText = alertData.fullText || triggerWord;  // ì „ì²´ ë°œí™” í…ìŠ¤íŠ¸

                addActivity('emergency', userName, `ì‹ ê³ : "${fullText}"`);

                // ğŸ”¥ í•´ë‹¹ ì–´ë¥´ì‹  ì¹´ë“œë¥¼ ì¦‰ì‹œ ê¸´ê¸‰ ìƒíƒœë¡œ ë³€ê²½
                updateUserCardToEmergency(alertData.userId, userName);

                // ğŸ”¥ ë Œë”ë§ ê°€ëŠ¥í•œ í˜•íƒœë¡œ ë³€í™˜í•´ì„œ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
                const emergencyItem = {
                    reportId: alertData.reportId,
                    userId: alertData.userId,
                    userName: userName,
                    triggerWord: triggerWord,
                    fullText: fullText,  // ì „ì²´ ë°œí™” í…ìŠ¤íŠ¸ ì¶”ê°€
                    reportedAt: alertData.reportedAt,
                    status: 'CONFIRMED',      // WebSocketìœ¼ë¡œ ì˜¨ ê±´ ì´ë¯¸ confirmëœ ìƒíƒœ
                    isConfirmed: true,
                    message: null
                };

                // ë¦¬ìŠ¤íŠ¸ ìµœìƒë‹¨ì— ì¶”ê°€
                emergencyList.unshift(emergencyItem);
                renderEmergencyCards(emergencyList);
                updateBadge(emergencyList.filter(i=>i.status==='PENDING' || i.status==='CONFIRMED').length);

                // ëª¨ë‹¬ íŒì—…
                document.getElementById('modal-detail').innerHTML =
                    `<b>${userName}</b> ì–´ë¥´ì‹ ì´ ê¸´ê¸‰ ì‹ ê³ í•˜ì…¨ìŠµë‹ˆë‹¤.<br>
               ë°œí™” ë‚´ìš©: "<strong>${fullText}</strong>"<br>
               íŠ¸ë¦¬ê±° ë‹¨ì–´: "<strong>${triggerWord}</strong>"<br>
               ë°œìƒì‹œê°„: ${new Date(alertData.reportedAt).toLocaleString('ko-KR')}`;
                document.getElementById('emergency-modal').classList.add('show');
            });
            stompClient.subscribe(`/topic/admin/${adminId}/user-status`, msg => {
                const statusData = JSON.parse(msg.body);
                addActivity(statusData.status==='EMERGENCY'?'emergency':'warning',
                    statusData.userName, statusData.message);
                // ì‚¬ìš©ì í™œë™ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
                loadUserActivitySummary();
            });
        }, (error) => {
            console.warn('STOMP ì—°ê²° ì‹¤íŒ¨ (ì‹ ê³  ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ë¹„í™œì„±í™”):', error);
        });
        } catch(e) {
            console.warn('WebSocket ì´ˆê¸°í™” ì‹¤íŒ¨ (ì‹ ê³  ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ë¹„í™œì„±í™”):', e);
        }
    }

    // ğŸ”¥ ì‚¬ìš©ì ì¹´ë“œë¥¼ ê¸´ê¸‰ ìƒíƒœë¡œ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (í™œë™ ë¡œê·¸ ê¸°ë°˜)
    function updateUserCardToEmergency(userId, userName) {
        const card = document.querySelector(`.user-card[data-user-id="${userId}"]`);
        if (!card) {
            console.warn(`User card not found for userId: ${userId}, í™œë™ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¡œë“œí•©ë‹ˆë‹¤`);
            // ì¹´ë“œê°€ ì—†ìœ¼ë©´ ì „ì²´ ì‚¬ìš©ì í™œë™ì„ ë‹¤ì‹œ ë¡œë“œ
            loadUserActivitySummary();
            return;
        }

        // ê¸°ì¡´ status í´ë˜ìŠ¤ ì œê±° í›„ emergency ì¶”ê°€
        card.classList.remove('status-active', 'status-warning');
        card.classList.add('status-emergency');

        // ì•„ì´ì½˜ ë³€ê²½
        const icon = card.querySelector('.user-status-icon');
        if (icon) icon.textContent = 'ğŸš¨';

        // ìƒíƒœ í…ìŠ¤íŠ¸ ë³€ê²½
        const activityType = card.querySelector('.activity-type');
        if (activityType) activityType.textContent = 'ì‘ê¸‰ ìƒíƒœ';

        console.log(`âœ… User card updated to EMERGENCY for userId: ${userId}, name: ${userName}`);
    }

    // ğŸ”¥ ì‚¬ìš©ì ì¹´ë“œë¥¼ ì •ìƒ ìƒíƒœë¡œ ë³µêµ¬ (í™œë™ ë¡œê·¸ ê¸°ë°˜)
    function resetUserCardToNormal(userId) {
        const card = document.querySelector(`.user-card[data-user-id="${userId}"]`);
        if (!card) {
            console.warn(`User card not found for userId: ${userId}`);
            return;
        }

        // emergency í´ë˜ìŠ¤ ì œê±°, active ì¶”ê°€
        card.classList.remove('status-emergency', 'status-warning');
        card.classList.add('status-active');

        // ì•„ì´ì½˜ì„ ì •ìƒìœ¼ë¡œ ë³€ê²½
        const icon = card.querySelector('.user-status-icon');
        if (icon) icon.textContent = 'ğŸŸ¢';

        // ìƒíƒœ í…ìŠ¤íŠ¸ ë³€ê²½
        const activityType = card.querySelector('.activity-type');
        if (activityType) activityType.textContent = 'ì •ìƒ ìƒíƒœ';

        console.log(`âœ… User card reset to NORMAL for userId: ${userId}`);
    }

    // í™œë™ í”¼ë“œ (WebSocket ì‹¤ì‹œê°„)
    function addActivity(type,userName,detail){
        const list = document.getElementById('activity-list');
        if(list.children.length===1 && list.children[0].textContent.includes('í™œë™ ë‚´ì—­')) {
            list.innerHTML='';
        }
        const item = document.createElement('div');
        item.className=`activity-item ${type}`;
        item.innerHTML=`<div>${type==='emergency'?'ğŸš¨':'âš ï¸'} <strong>${userName}</strong> - ${detail}</div>
                     <div class="activity-time">${new Date().toLocaleTimeString('ko-KR')}</div>`;
        list.prepend(item);
        while(list.children.length>10) list.removeChild(list.lastChild);
    }

    // ===== í™œë™ ë¡œê·¸ API í•¨ìˆ˜ë“¤ =====

    // í™œë™ í†µê³„ ì¡°íšŒ (ì˜¤ëŠ˜)
    async function loadActivityStats() {
        try {
            const now = new Date();
            const startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0).toISOString().slice(0,19);
            const endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59).toISOString().slice(0,19);

            console.log('í™œë™ í†µê³„ ì¡°íšŒ:', { startDate, endDate });

            const res = await fetch(
                `${API_BASE}/admins/activity-logs/stats?startDate=${startDate}&endDate=${endDate}`,
                { headers: { Authorization: `Bearer ${accessToken}` }}
            );

            console.log('í™œë™ í†µê³„ ì‘ë‹µ:', res.status);

            if (res.ok) {
                const data = await res.json();
                console.log('í™œë™ í†µê³„ ë°ì´í„°:', data);
                renderActivityStats(data);
            } else {
                const errorText = await res.text();
                console.error('í™œë™ í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', res.status, errorText);
                // ë¹ˆ ë°ì´í„°ë¡œ ë Œë”ë§
                renderActivityStats({ stats: {}, totalCount: 0 });
            }
        } catch (e) {
            console.error('í™œë™ í†µê³„ ë¡œë“œ ì—ëŸ¬:', e);
            // ë¹ˆ ë°ì´í„°ë¡œ ë Œë”ë§
            renderActivityStats({ stats: {}, totalCount: 0 });
        }
    }

    // í™œë™ í†µê³„ ë Œë”ë§
    function renderActivityStats(data) {
        const container = document.getElementById('activity-stats');
        const stats = data.stats || {};
        const totalCount = data.totalCount || 0;

        const statLabels = {
            'MUSIC_PLAY': { icon: 'ğŸµ', label: 'ìŒì•… ì¬ìƒ' },
            'MUSIC_CONTROL': { icon: 'â¯ï¸', label: 'ìŒì•… ì œì–´' },
            'GAME_START': { icon: 'ğŸ®', label: 'ê²Œì„ ì‹œì‘' },
            'GAME_END': { icon: 'ğŸ', label: 'ê²Œì„ ì¢…ë£Œ' },
            'MODE_CHANGE': { icon: 'ğŸ”„', label: 'ëª¨ë“œ ë³€ê²½' },
            'EMERGENCY': { icon: 'ğŸš¨', label: 'ì‘ê¸‰ ìƒí™©' },
            'UNKNOWN': { icon: 'â“', label: 'ì¸ì‹ ë¶ˆê°€' }
        };

        let html = '';
        for (const [type, info] of Object.entries(statLabels)) {
            const count = stats[type] || 0;
            html += `
                <div style="background:white; padding:20px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.05); text-align:center;">
                    <div style="font-size:32px; margin-bottom:8px;">${info.icon}</div>
                    <div style="font-size:24px; font-weight:bold; color:#667eea; margin-bottom:4px;">${count}</div>
                    <div style="font-size:13px; color:#8b95a1;">${info.label}</div>
                </div>
            `;
        }

        // ì „ì²´ í™œë™ ì¹´ë“œ
        html += `
            <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); padding:20px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); text-align:center; color:white;">
                <div style="font-size:32px; margin-bottom:8px;">ğŸ“Š</div>
                <div style="font-size:24px; font-weight:bold; margin-bottom:4px;">${totalCount}</div>
                <div style="font-size:13px;">ì „ì²´ í™œë™</div>
            </div>
        `;

        container.innerHTML = html;
    }

    // í™œë™ ë¡œê·¸ ì¡°íšŒ (í˜ì´ì§•)
    async function loadActivityLogs(page = 0) {
        try {
            currentPage = page;
            let url = `${API_BASE}/admins/activity-logs?page=${page}&size=20&sort=createdAt,desc`;

            // í•„í„°ë§ ì ìš©
            if (currentActivityType) {
                url = `${API_BASE}/admins/activity-logs/filter?activityType=${currentActivityType}&page=${page}&size=20`;
            }

            const res = await fetch(url, {
                headers: { Authorization: `Bearer ${accessToken}` }
            });

            if (res.ok) {
                const data = await res.json();
                renderActivityLogs(data);
            } else {
                console.error('í™œë™ ë¡œê·¸ ì¡°íšŒ ì‹¤íŒ¨:', res.status);
                document.getElementById('activity-list').innerHTML =
                    '<div style="color:#999;text-align:center;">í™œë™ ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
            }
        } catch (e) {
            console.error('í™œë™ ë¡œê·¸ ë¡œë“œ ì—ëŸ¬:', e);
            document.getElementById('activity-list').innerHTML =
                '<div style="color:#999;text-align:center;">í™œë™ ë¡œê·¸ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ</div>';
        }
    }

    // í™œë™ ë¡œê·¸ ë Œë”ë§
    function renderActivityLogs(data) {
        const list = document.getElementById('activity-list');
        const content = data.content || [];
        totalPages = data.totalPages || 0;

        if (content.length === 0) {
            list.innerHTML = '<div style="color:#999;text-align:center;">í™œë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
            document.getElementById('activity-pagination').style.display = 'none';
            return;
        }

        const activityIcons = {
            'MUSIC_PLAY': 'ğŸµ',
            'MUSIC_CONTROL': 'â¯ï¸',
            'GAME_START': 'ğŸ®',
            'GAME_END': 'ğŸ',
            'MODE_CHANGE': 'ğŸ”„',
            'EMERGENCY': 'ğŸš¨',
            'UNKNOWN': 'â“'
        };

        list.innerHTML = content.map(log => {
            const icon = activityIcons[log.activityType] || 'ğŸ“';
            const cls = log.activityType === 'EMERGENCY' ? 'emergency' : '';
            const time = new Date(log.createdAt).toLocaleString('ko-KR');

            return `
                <div class="activity-item ${cls}">
                    <div>${icon} <strong>${log.userName}</strong> - ${log.activitySummary}</div>
                    <div class="activity-time">${time}</div>
                </div>
            `;
        }).join('');

        // í˜ì´ì§• UI ì—…ë°ì´íŠ¸
        document.getElementById('activity-pagination').style.display = 'block';
        document.getElementById('page-info').textContent = `í˜ì´ì§€ ${currentPage + 1} / ${totalPages}`;
        document.getElementById('btn-prev-page').disabled = currentPage === 0;
        document.getElementById('btn-next-page').disabled = currentPage >= totalPages - 1;
    }

    // í˜ì´ì§€ ì´ë™
    function loadActivityPage(page) {
        if (page < 0 || page >= totalPages) return;
        loadActivityLogs(page);
    }

    // í•„í„° ë³€ê²½
    function onActivityFilterChange() {
        const select = document.getElementById('activity-type-filter');
        currentActivityType = select.value;
        loadActivityLogs(0); // ì²« í˜ì´ì§€ë¡œ ì´ë™
    }

    // ë°°ì§€ ì—…ë°ì´íŠ¸
    function updateBadge(count){
        const badge = document.getElementById('notification-badge');
        if(count>0) {
            badge.style.display='flex';
            badge.textContent = count;
        } else {
            badge.style.display='none';
        }
    }
    function clearBadge(){
        updateBadge(0);
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeModal(){
        document.getElementById('emergency-modal').classList.remove('show');
    }
    function acknowledgeReport(){
        // ëª¨ë‹¬ì—ì„œ ì²˜ë¦¬ ë²„íŠ¼ ëˆ„ë¥´ë©´ ëª¨ë‹¬ë§Œ ë‹«ê³  ë¦¬ìŠ¤íŠ¸ëŠ” ì¹´ë“œ ë²„íŠ¼ìœ¼ë¡œ ì²˜ë¦¬
        closeModal();
    }

    // ê¸°ê¸° ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
    function openDeviceModal(){
        document.getElementById('device-modal').classList.add('show');
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('device-serial').value = '';
        document.getElementById('device-location').value = '';
        document.getElementById('device-register-response').className = 'response-box';
    }
    function closeDeviceModal(){
        document.getElementById('device-modal').classList.remove('show');
    }

    // ê¸°ê¸° ë“±ë¡
    async function registerDevice(){
        const serial = document.getElementById('device-serial').value.trim();
        const location = document.getElementById('device-location').value.trim();
        const responseBox = document.getElementById('device-register-response');

        if(!serial){
            responseBox.className = 'response-box show error';
            responseBox.textContent = 'ê¸°ê¸° ì¼ë ¨ë²ˆí˜¸ëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.';
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/admins/devices`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify({
                    serialNumber: serial,
                    location: location || null
                })
            });

            if(res.ok){
                const data = await res.json();
                responseBox.className = 'response-box show success';
                responseBox.textContent = `ê¸°ê¸°ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! (ID: ${data.id})`;

                // 2ì´ˆ í›„ ëª¨ë‹¬ ë‹«ê¸°
                setTimeout(() => {
                    closeDeviceModal();
                }, 2000);
            } else {
                const error = await res.json();
                responseBox.className = 'response-box show error';
                responseBox.textContent = `ë“±ë¡ ì‹¤íŒ¨: ${error.message || res.statusText}`;
            }
        } catch(e){
            responseBox.className = 'response-box show error';
            responseBox.textContent = `ì—ëŸ¬ ë°œìƒ: ${e.message}`;
        }
    }

    // ì–´ë¥´ì‹  ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
    async function openUserModal(){
        document.getElementById('user-modal').classList.add('show');
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('user-name').value = '';
        document.getElementById('user-birthdate').value = '';
        document.getElementById('user-gender').value = '';
        document.getElementById('user-contact').value = '';
        document.getElementById('user-device').value = '';
        document.getElementById('user-medical-notes').value = '';
        document.getElementById('user-register-response').className = 'response-box';

        // ê¸°ê¸° ëª©ë¡ ë¡œë“œ
        await loadDevicesForSelect();
    }
    function closeUserModal(){
        document.getElementById('user-modal').classList.remove('show');
    }

    // ê¸°ê¸° ëª©ë¡ì„ ì…€ë ‰íŠ¸ë°•ìŠ¤ì— ë¡œë“œ (ì—°ê²° ê°€ëŠ¥í•œ ê¸°ê¸°ë§Œ)
    async function loadDevicesForSelect(){
        try {
            // availableOnly=true íŒŒë¼ë¯¸í„°ë¡œ ì—°ê²° ì•ˆëœ ê¸°ê¸°ë§Œ ìš”ì²­
            const res = await fetch(`${API_BASE}/admins/devices?availableOnly=true`, {
                headers: {Authorization: `Bearer ${accessToken}`}
            });
            if(res.ok){
                const devices = await res.json();

                const select = document.getElementById('user-device');
                select.innerHTML = '<option value="">ì—°ê²°í•  ê¸°ê¸° ì„ íƒ (í•„ìˆ˜)</option>';

                if(devices.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'ì‚¬ìš© ê°€ëŠ¥í•œ ê¸°ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê¸°ê¸°ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.';
                    option.disabled = true;
                    select.appendChild(option);
                } else {
                    devices.forEach(d => {
                        const option = document.createElement('option');
                        option.value = d.id;
                        option.textContent = `${d.serialNumber} ${d.location ? '('+d.location+')' : ''}`;
                        select.appendChild(option);
                    });
                }
            }
        } catch(e){
            console.error('ê¸°ê¸° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
        }
    }

    // ì–´ë¥´ì‹  ë“±ë¡
    async function registerUser(){
        const name = document.getElementById('user-name').value.trim();
        const birthDate = document.getElementById('user-birthdate').value;
        const gender = document.getElementById('user-gender').value;
        const contact = document.getElementById('user-contact').value.trim();
        const deviceId = document.getElementById('user-device').value;
        const medicalNotes = document.getElementById('user-medical-notes').value.trim();
        const responseBox = document.getElementById('user-register-response');

        if(!name){
            responseBox.className = 'response-box show error';
            responseBox.textContent = 'ì´ë¦„ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.';
            return;
        }

        if(!deviceId){
            responseBox.className = 'response-box show error';
            responseBox.textContent = 'ì—°ê²°í•  ê¸°ê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.';
            return;
        }

        try {
            const requestBody = {
                name: name,
                deviceId: parseInt(deviceId)
            };

            // ì„ íƒ í•„ë“œë“¤ ì¶”ê°€
            if(birthDate) requestBody.birthDate = birthDate;
            if(gender) requestBody.gender = gender;
            if(contact) requestBody.emergencyContact = contact;
            if(medicalNotes) requestBody.medicalNotes = medicalNotes;

            const res = await fetch(`${API_BASE}/admins/users`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify(requestBody)
            });

            if(res.ok){
                const data = await res.json();
                responseBox.className = 'response-box show success';
                responseBox.textContent = `ì–´ë¥´ì‹ ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! (ID: ${data.id})`;

                // 2ì´ˆ í›„ ëª¨ë‹¬ ë‹«ê¸° ë° ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨
                setTimeout(() => {
                    closeUserModal();
                    loadDashboardData();
                }, 2000);
            } else {
                const error = await res.json();
                responseBox.className = 'response-box show error';
                responseBox.textContent = `ë“±ë¡ ì‹¤íŒ¨: ${error.message || res.statusText}`;
            }
        } catch(e){
            responseBox.className = 'response-box show error';
            responseBox.textContent = `ì—ëŸ¬ ë°œìƒ: ${e.message}`;
        }
    }

    // ===== ê³¡ ì‹œê°í™” ê´€ë ¨ í•¨ìˆ˜ =====

    async function showVisualizationScreen() {
        document.getElementById('dashboard-screen').classList.add('hidden');
        document.getElementById('visualization-screen').classList.remove('hidden');

        // ê³¡ ëª©ë¡ ë¡œë“œ
        await loadSongList();
    }

    async function loadSongList() {
        try {
            const res = await fetch(`${API_BASE}/admins/songs`, {
                headers: {Authorization: `Bearer ${accessToken}`}
            });

            if (!res.ok) throw new Error('ê³¡ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');

            const songs = await res.json();
            const select = document.getElementById('song-select');
            select.innerHTML = '<option value="">ê³¡ì„ ì„ íƒí•˜ì„¸ìš”...</option>';

            songs.forEach(song => {
                const option = document.createElement('option');
                option.value = song.id;
                option.textContent = `${song.title} - ${song.artist}`;
                select.appendChild(option);
            });

            // ì²« ë²ˆì§¸ ê³¡ ìë™ ì„ íƒ (ìˆì„ ê²½ìš°)
            if (songs.length > 0) {
                select.value = songs[0].id;
                loadSongVisualization(songs[0].id);
            }
        } catch(e) {
            console.error('ê³¡ ëª©ë¡ ë¡œë“œ ì—ëŸ¬:', e);
            alert('ê³¡ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + e.message);
        }
    }

    let currentVisualizationTab = 'basic';
    let currentSongData = null;

    function onSongChange() {
        const select = document.getElementById('song-select');
        const songId = select.value;

        if (songId) {
            loadSongVisualization(parseInt(songId));
        } else {
            document.getElementById('song-visualization-container').innerHTML = '';
            document.getElementById('timeline-loading').style.display = 'block';
            document.getElementById('score-timeline-content').style.display = 'none';
        }
    }

    function switchVisualizationTab(tab) {
        currentVisualizationTab = tab;

        // íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½
        if (tab === 'basic') {
            document.getElementById('tab-basic-viz').className = 'btn btn-primary';
            document.getElementById('tab-timeline-viz').className = 'btn btn-secondary';
            document.getElementById('basic-visualization-container').style.display = 'block';
            document.getElementById('timeline-visualization-container').style.display = 'none';
        } else {
            document.getElementById('tab-basic-viz').className = 'btn btn-secondary';
            document.getElementById('tab-timeline-viz').className = 'btn btn-primary';
            document.getElementById('basic-visualization-container').style.display = 'none';
            document.getElementById('timeline-visualization-container').style.display = 'block';

            // ì•…ë³´ íƒ€ì„ë¼ì¸ ë Œë”ë§ (ë°ì´í„°ê°€ ìˆìœ¼ë©´)
            if (currentSongData) {
                renderScoreTimeline(currentSongData);
            }
        }
    }

    function showDashboardScreen() {
        document.getElementById('visualization-screen').classList.add('hidden');
        document.getElementById('dashboard-screen').classList.remove('hidden');
    }

    async function loadSongVisualization(songId) {
        try {
            const res = await fetch(`${API_BASE}/admins/songs/${songId}/visualization`, {
                headers: {Authorization: `Bearer ${accessToken}`}
            });

            if (!res.ok) throw new Error('ì‹œê°í™” ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');

            const data = await res.json();
            console.log('ì‹œê°í™” ë°ì´í„°:', data);

            // ë°ì´í„° ì €ì¥
            currentSongData = data;

            // ê¸°ë³¸ ì‹œê°í™” ë Œë”ë§
            renderVisualization(data);

            // ì•…ë³´ íƒ€ì„ë¼ì¸ íƒ­ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ë Œë”ë§
            if (currentVisualizationTab === 'timeline') {
                renderScoreTimeline(data);
            } else {
                // ë¡œë”© ìƒíƒœ ì œê±°
                document.getElementById('timeline-loading').style.display = 'none';
                document.getElementById('score-timeline-content').style.display = 'none';
            }
        } catch(e) {
            console.error('ì‹œê°í™” ë¡œë“œ ì—ëŸ¬:', e);
            alert('ê³¡ ì‹œê°í™” ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + e.message);
        }
    }

    function renderVisualization(data) {
        const container = document.getElementById('song-visualization-container');

        // ë©”íŠ¸ë¡œë†ˆ ë¹„íŠ¸ ë°ì´í„° ì¤€ë¹„
        const beats = data.songBeat.beats || [];
        const sections = data.songBeat.sections || [];

        // HTML í…œí”Œë¦¿ (Toss ìŠ¤íƒ€ì¼ë¡œ ê¹”ë”í•˜ê²Œ)
        container.innerHTML = `
            <style>
                .viz-container { max-width: 1200px; margin: 0 auto; background: white; }
                .viz-header { background: white; padding: 40px 50px; border-bottom: 1px solid #e5e7eb; }
                .viz-header h1 { font-size: 28px; margin-bottom: 8px; color: #191f28; font-weight: 700; }
                .viz-song-info { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
                .viz-song-title { font-size: 22px; font-weight: 600; color: #4e5968; }
                .viz-song-meta { display: flex; gap: 20px; font-size: 15px; color: #8b95a1; }
                .viz-controls { padding: 24px 50px; background: white; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 12px; }
                .viz-btn { padding: 12px 24px; border: none; border-radius: 10px; font-size: 15px; cursor: pointer; transition: all 0.2s; font-weight: 600; }
                .viz-btn-primary { background: #3182f6; color: white; }
                .viz-btn-primary:hover { background: #1b64da; }
                .viz-btn-secondary { background: #f2f4f6; color: #4e5968; }
                .viz-btn-secondary:hover { background: #e5e8eb; }
                .viz-section { padding: 40px 50px; background: white; }
                .viz-current-section { text-align: center; margin-bottom: 32px; padding: 24px; background: #f9fafb; border-radius: 16px; border: 1px solid #e5e7eb; }
                .viz-section-name { font-size: 20px; font-weight: 700; color: #191f28; margin-bottom: 8px; }
                .viz-time-display { font-size: 32px; font-weight: 700; color: #3182f6; letter-spacing: 1px; }
                .viz-progress-container { margin: 32px 0; }
                .viz-progress-wrapper { position: relative; height: 60px; background: #f9fafb; border-radius: 12px; overflow: hidden; border: 1px solid #e5e7eb; }
                .viz-progress-bar { position: absolute; top: 0; left: 0; height: 100%; background: #3182f6; width: 0%; transition: width 0.3s; }
                .viz-section-markers { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; }
                .viz-section-marker { flex: 1; border-right: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600; color: #8b95a1; padding: 8px; }

                /* ë©”íŠ¸ë¡œë†ˆ (16ë¹„íŠ¸) - ê°„ë‹¨í•œ ë°•ìŠ¤ */
                .viz-beat-visualizer { margin: 32px 0; padding: 24px; background: white; border-radius: 12px; border: 1px solid #e5e7eb; }
                .viz-beat-visualizer h3 { font-size: 14px; font-weight: 600; color: #8b95a1; margin-bottom: 16px; text-align: center; }
                .viz-metronome-display { display: flex; flex-direction: column; gap: 16px; }
                .viz-metronome-header { display: flex; justify-content: space-around; align-items: center; margin-bottom: 8px; }
                .viz-bar-info, .viz-bpm-info { display: flex; flex-direction: column; align-items: center; gap: 4px; }
                .viz-bar-label, .viz-bpm-label { font-size: 11px; font-weight: 600; color: #8b95a1; text-transform: uppercase; }
                .viz-bar-number, .viz-bpm-value { font-size: 20px; font-weight: 700; color: #4e5968; }
                .viz-beat-indicators { display: grid; grid-template-columns: repeat(16, 1fr); gap: 4px; width: 100%; }
                .viz-beat-box { aspect-ratio: 1; border: 1px solid #d1d5db; background: white; transition: all 0.1s; }
                .viz-beat-box.active { background: #3182f6; border-color: #3182f6; }

                /* ê°€ì‚¬ ë…¸ë˜ë°© ìŠ¤íƒ€ì¼ (ë°ì€ ë°°ê²½) */
                .viz-lyrics-karaoke { margin-top: 40px; padding: 40px; background: white; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; min-height: 250px; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
                .viz-action-indicator { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; gap: 8px; opacity: 0; transition: opacity 0.1s; pointer-events: none; }
                .viz-action-indicator.active { opacity: 1; animation: actionPulse 0.4s ease-out; }
                .viz-action-icon { font-size: 80px; }
                .viz-action-name { font-size: 18px; font-weight: 700; color: #3182f6; background: white; padding: 6px 16px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
                @keyframes actionPulse { 0% { transform: translateX(-50%) scale(0.8); opacity: 0; } 50% { transform: translateX(-50%) scale(1.1); opacity: 1; } 100% { transform: translateX(-50%) scale(1); opacity: 1; } }
                .viz-current-lyric { font-size: 38px; font-weight: 700; color: #191f28; text-align: center; margin-bottom: 12px; line-height: 1.4; }
                .viz-next-lyric { font-size: 20px; font-weight: 500; color: #8b95a1; text-align: center; margin-top: 8px; }
                .viz-lyric-progress { margin-top: 24px; width: 100%; max-width: 600px; height: 6px; background: #f2f4f6; border-radius: 3px; overflow: hidden; }
                .viz-lyric-progress-bar { height: 100%; background: linear-gradient(90deg, #3182f6, #60a5fa); transition: width 0.1s linear; }

                /* íƒ€ì„ë¼ì¸ */
                .viz-timeline { margin: 32px 0; }
                .viz-timeline h3 { font-size: 18px; font-weight: 700; color: #191f28; margin-bottom: 24px; }
                .viz-timeline-track { display: flex; flex-direction: column; gap: 16px; }
                .viz-timeline-item { display: flex; align-items: center; padding: 20px 24px; background: #f9fafb; border-radius: 16px; border: 2px solid #e5e7eb; transition: all 0.3s; }
                .viz-timeline-item.past { opacity: 0.5; }
                .viz-timeline-item.current { background: white; border-color: #3182f6; box-shadow: 0 4px 16px rgba(49, 130, 246, 0.15); }
                .viz-timeline-item.upcoming { opacity: 0.8; }
                .viz-timeline-indicator { width: 8px; height: 8px; border-radius: 50%; background: #e5e7eb; }
                .viz-timeline-item.past .viz-timeline-indicator { background: #10b981; }
                .viz-timeline-item.current .viz-timeline-indicator { background: #3182f6; animation: vizIndicatorPulse 1.5s ease-in-out infinite; }
                @keyframes vizIndicatorPulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(49, 130, 246, 0.7); } 50% { transform: scale(1.3); box-shadow: 0 0 0 8px rgba(49, 130, 246, 0); } }
                .viz-timeline-time { min-width: 80px; font-size: 18px; font-weight: 700; color: #3182f6; }
                .viz-timeline-item.past .viz-timeline-time { color: #8b95a1; }
                .viz-timeline-item.upcoming .viz-timeline-time { color: #4e5968; }
                .viz-timeline-content { flex: 1; margin-left: 24px; }
                .viz-timeline-lyric { font-size: 20px; font-weight: 600; color: #191f28; margin-bottom: 8px; }
                .viz-timeline-actions { display: flex; gap: 12px; flex-wrap: wrap; }
                .viz-action-chip { display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: white; border-radius: 20px; font-size: 14px; font-weight: 600; color: #4e5968; border: 1px solid #e5e7eb; }
                .viz-timeline-item.current .viz-action-chip { background: #eff6ff; border-color: #3182f6; color: #3182f6; }
            </style>

            <div class="viz-container">
                <!-- í—¤ë” -->
                <div class="viz-header">
                    <h1>ê³¡ ì‹œê°í™” ë„êµ¬</h1>
                    <div class="viz-song-info">
                        <div class="viz-song-title">í¥ë¶€ì ì²´ì¡°ì†¡ - ì•„ì´ìœ </div>
                        <div class="viz-song-meta">
                            <span>BPM: ${data.bpm.toFixed(2)}</span>
                            <span>ê¸¸ì´: ${Math.floor(data.duration/60)}:${Math.floor(data.duration%60).toString().padStart(2,'0')}</span>
                        </div>
                    </div>
                </div>

                <!-- ì¬ìƒ ì»¨íŠ¸ë¡¤ -->
                <div class="viz-controls">
                    <button class="viz-btn viz-btn-primary" onclick="playVisualization()">â–¶ ì¬ìƒ</button>
                    <button class="viz-btn viz-btn-secondary" onclick="pauseVisualization()">â¸ ì¼ì‹œì •ì§€</button>
                    <button class="viz-btn viz-btn-secondary" onclick="stopVisualization()">â¹ ì •ì§€</button>
                </div>

                <!-- íƒ€ì„ë¼ì¸ -->
                <div class="viz-section">
                    <!-- í˜„ì¬ êµ¬ê°„ -->
                    <div class="viz-current-section">
                        <div class="viz-section-name" id="viz-section-name">Intro</div>
                        <div class="viz-time-display">
                            <span id="viz-current-time">0:00</span> / <span id="viz-total-time">${Math.floor(data.duration/60)}:${Math.floor(data.duration%60).toString().padStart(2,'0')}</span>
                        </div>
                    </div>

                    <!-- ì§„í–‰ ë°” -->
                    <div class="viz-progress-container">
                        <div class="viz-progress-wrapper">
                            <div class="viz-progress-bar" id="viz-progress-bar"></div>
                            <div class="viz-section-markers">
                                ${sections.map(s => `<div class="viz-section-marker">${s.label}<br>${formatTime(beats.find(b => b.i === s.startBeat)?.t || 0)}</div>`).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- ê°€ì‚¬ ë…¸ë˜ë°© ìŠ¤íƒ€ì¼ -->
                    <div class="viz-lyrics-karaoke">
                        <div class="viz-action-indicator" id="viz-action-indicator">
                            <div class="viz-action-icon" id="viz-action-icon">ğŸ™Œ</div>
                            <div class="viz-action-name" id="viz-action-name">ë™ì‘</div>
                        </div>
                        <div class="viz-current-lyric" id="viz-current-lyric">ê°€ì‚¬ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>
                        <div class="viz-next-lyric" id="viz-next-lyric">ë‹¤ìŒ: -</div>
                        <div class="viz-lyric-progress">
                            <div class="viz-lyric-progress-bar" id="viz-lyric-progress-bar" style="width: 0%;"></div>
                        </div>
                    </div>

                    <!-- ë©”íŠ¸ë¡œë†ˆ (16ë¹„íŠ¸) - ê°„ë‹¨í•œ ë°•ìŠ¤ -->
                    <div class="viz-beat-visualizer">
                        <h3>16ë¹„íŠ¸ ë©”íŠ¸ë¡œë†ˆ</h3>
                        <div class="viz-metronome-display">
                            <div class="viz-metronome-header">
                                <div class="viz-bar-info">
                                    <span class="viz-bar-label">ë§ˆë””</span>
                                    <span class="viz-bar-number" id="viz-bar-number">1</span>
                                </div>
                                <div class="viz-bpm-info">
                                    <span class="viz-bpm-label">BPM</span>
                                    <span class="viz-bpm-value">${data.bpm.toFixed(1)}</span>
                                </div>
                            </div>
                            <div class="viz-beat-indicators">
                                ${[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16].map(i =>
                                    `<div class="viz-beat-box" data-beat="${i}"></div>`
                                ).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- ê°€ì‚¬ & ë™ì‘ íƒ€ì„ë¼ì¸ -->
                    <div class="viz-timeline">
                        <h3>ê°€ì‚¬ & ë™ì‘ íƒ€ì„ë¼ì¸ (Verse1)</h3>
                        <div class="viz-timeline-track" id="viz-timeline-track">
                            ${renderTimelineItems(data.verse1Timeline, data.lyricsInfo)}
                        </div>
                    </div>
                </div>
            </div>
        `;

        // ì‹œê°í™” ì¬ìƒ ê´€ë ¨ ë³€ìˆ˜ ì´ˆê¸°í™”
        window.vizData = data;
        window.vizIsPlaying = false;
        window.vizCurrentTime = 0;
        window.vizLastBeatIndex = -1;
        window.lastActionTime = null;
    }

    function formatTime(seconds) {
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${min}:${sec.toString().padStart(2, '0')}`;
    }

    function renderTimelineItems(timeline, lyricsInfo) {
        if (!timeline || timeline.length === 0) return '<p>íƒ€ì„ë¼ì¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';

        const lyrics = lyricsInfo?.lines || [];

        // ë™ì‘ ì´ëª¨ì§€ ë§¤í•‘ (0ë¶€í„° ì‹œì‘)
        const actionIcons = {
            0: 'ğŸ‘',      // 1, 2ì ˆ ì† ë°•ìˆ˜
            1: 'ğŸ‘',      // 1ì ˆ íŒ” ì¹˜ê¸°
            2: 'ğŸ‘',      // 2ì ˆ 1ë‹¨ê³„ ì—‰ë©ì´ ë°•ìˆ˜
            3: 'ğŸ™†â€â™€ï¸',  // 2ì ˆ 2ë‹¨ê³„ íŒ” ë»—ê¸°
            4: 'ğŸ¤¸',      // 2ì ˆ 2ë‹¨ê³„ ê¸°ìš°ëš±
            5: 'ğŸšª',      // 2ì ˆ ë¹„ìƒêµ¬
            6: 'ğŸ™‹',      // 2ì ˆ ê²¨ë“œë‘ì´ë°•ìˆ˜
            7: 'ğŸ’ƒ'       // ê¸°íƒ€
        };

        if (lyrics.length === 0) {
            // ê°€ì‚¬ ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ ë°©ì‹ëŒ€ë¡œ í‘œì‹œ
            return timeline.slice(0, 10).map((event, idx) => {
                const cls = idx === 0 ? 'past' : idx === 1 ? 'current' : 'upcoming';
                const icon = actionIcons[event.actionCode] || 'ğŸ’ƒ';

                return `
                    <div class="viz-timeline-item ${cls}">
                        <div class="viz-timeline-indicator"></div>
                        <div class="viz-timeline-time">${event.time.toFixed(1)}s</div>
                        <div class="viz-timeline-content">
                            <div class="viz-timeline-lyric">ë™ì‘</div>
                            <div class="viz-timeline-actions">
                                <div class="viz-action-chip">
                                    <span>${icon}</span>
                                    <span>${event.actionName}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ê°€ì‚¬ë³„ë¡œ ë™ì‘ë“¤ì„ ê·¸ë£¹í™”
        const lyricItems = [];

        lyrics.forEach((lyric, lyricIdx) => {
            // ì´ ê°€ì‚¬ì˜ ë¹„íŠ¸ ë²”ìœ„ í™•ì¸ (sbeat ~ ebeat)
            const beatCount = lyric.ebeat - lyric.sbeat;

            // ì´ ê°€ì‚¬ì˜ ì‹œê°„ ë²”ìœ„ì— í•´ë‹¹í•˜ëŠ” ë™ì‘ë“¤ì„ ì°¾ê¸°
            const actionsInLyric = timeline.filter(event =>
                event.time >= lyric.start && event.time < lyric.end
            );

            // ë™ì‘ì´ ì—†ëŠ” ê°€ì‚¬ë„ í‘œì‹œ (ê°€ì‚¬ë§Œ ìˆëŠ” êµ¬ê°„)
            const cls = lyricIdx === 0 ? 'past' : lyricIdx === 1 ? 'current' : 'upcoming';

            if (actionsInLyric.length === 0) {
                // ê°€ì‚¬ë§Œ ìˆê³  ë™ì‘ì´ ì—†ëŠ” êµ¬ê°„
                lyricItems.push(`
                    <div class="viz-timeline-item ${cls}" style="opacity: 0.6;">
                        <div class="viz-timeline-indicator"></div>
                        <div class="viz-timeline-time">${lyric.start.toFixed(1)}s</div>
                        <div class="viz-timeline-content">
                            <div class="viz-timeline-lyric">${lyric.text}</div>
                            <div class="viz-timeline-actions">
                                <div class="viz-action-chip" style="background: #f0f0f0; border-color: #ddd;">
                                    <span>ğŸµ</span>
                                    <span>ê°€ì‚¬ë§Œ (ë™ì‘ ì—†ìŒ, ${beatCount}ë°•ì)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
            } else {
                // ë™ì‘ì´ ìˆëŠ” êµ¬ê°„ - ëª¨ë“  ë™ì‘ í‘œì‹œ
                lyricItems.push(`
                    <div class="viz-timeline-item ${cls}">
                        <div class="viz-timeline-indicator"></div>
                        <div class="viz-timeline-time">${lyric.start.toFixed(1)}s</div>
                        <div class="viz-timeline-content">
                            <div class="viz-timeline-lyric">
                                ${lyric.text}
                                <span style="color: #999; font-size: 0.85em;">(${beatCount}ë°•ì, ë™ì‘ ${actionsInLyric.length}ê°œ)</span>
                            </div>
                            <div class="viz-timeline-actions">
                                ${actionsInLyric.map((event, idx) => {
                                    const icon = actionIcons[event.actionCode] || 'ğŸ’ƒ';
                                    return `
                                        <div class="viz-action-chip">
                                            <span>${icon}</span>
                                            <span>${event.actionName}</span>
                                            <span style="font-size: 0.85em; color: #999;">#${idx + 1}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `);
            }
        });

        return lyricItems.join('');
    }

    // ì‹œê°í™” ì¬ìƒ ê´€ë ¨ í•¨ìˆ˜
    function playVisualization() {
        if (!window.vizData) return;
        if (window.vizIsPlaying) return;

        window.vizIsPlaying = true;
        window.vizAnimationInterval = setInterval(() => {
            window.vizCurrentTime += 0.1;
            updateVisualizationUI(window.vizCurrentTime);
            updateBeatVisualizer(window.vizCurrentTime);
        }, 100);
    }

    function pauseVisualization() {
        window.vizIsPlaying = false;
        clearInterval(window.vizAnimationInterval);
    }

    function stopVisualization() {
        window.vizIsPlaying = false;
        clearInterval(window.vizAnimationInterval);
        window.vizCurrentTime = 0;
        window.lastActionTime = null;
        updateVisualizationUI(0);
        updateBeatVisualizer(0);
    }

    function updateVisualizationUI(time) {
        const data = window.vizData;
        if (!data) return;

        // ì§„í–‰ ë°”
        const progress = (time / data.duration) * 100;
        document.getElementById('viz-progress-bar').style.width = progress + '%';

        // ì‹œê°„ í‘œì‹œ
        const min = Math.floor(time / 60);
        const sec = Math.floor(time % 60);
        document.getElementById('viz-current-time').textContent = `${min}:${sec.toString().padStart(2, '0')}`;

        // êµ¬ê°„ í‘œì‹œ
        const sections = data.songBeat.sections || [];
        const beats = data.songBeat.beats || [];
        let currentSection = 'Intro';

        for (let section of sections) {
            const startBeat = beats.find(b => b.i === section.startBeat);
            const endBeat = beats.find(b => b.i === section.endBeat);
            if (startBeat && endBeat && time >= startBeat.t && time <= endBeat.t) {
                currentSection = section.label;
                break;
            }
        }

        const sectionNames = {
            'intro': 'Intro',
            'verse1': 'Verse1 (1ì ˆ ì•ˆë¬´)',
            'break': 'Break (íœ´ì‹)',
            'verse2': 'Verse2 (2ì ˆ ì•ˆë¬´)'
        };
        document.getElementById('viz-section-name').textContent = sectionNames[currentSection] || currentSection;
    }

    function updateBeatVisualizer(time) {
        const data = window.vizData;
        if (!data) return;

        const beats = data.songBeat.beats || [];

        // í˜„ì¬ ì‹œê°„ì— ê°€ì¥ ê°€ê¹Œìš´ ë¹„íŠ¸ ì°¾ê¸°
        let currentBeat = null;
        let minDiff = Infinity;

        for (let beat of beats) {
            const diff = Math.abs(beat.t - time);
            if (diff < minDiff && beat.t <= time + 0.05) {
                minDiff = diff;
                currentBeat = beat;
            }
        }

        if (!currentBeat || currentBeat.i === window.vizLastBeatIndex) {
            return;
        }

        window.vizLastBeatIndex = currentBeat.i;

        // ë§ˆë”” ë²ˆí˜¸ ì—…ë°ì´íŠ¸
        document.getElementById('viz-bar-number').textContent = currentBeat.bar;

        // 16ë¹„íŠ¸ ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸ (ê°„ë‹¨í•œ ë°•ìŠ¤)
        const beatBoxes = document.querySelectorAll('.viz-beat-box');
        beatBoxes.forEach(box => box.classList.remove('active'));

        // 16ë¶„ìŒí‘œ ë‹¨ìœ„ë¡œ ê³„ì‚° (1ë¹„íŠ¸ = 4ê°œì˜ 16ë¶„ìŒí‘œ)
        // beatëŠ” 1,2,3,4 (4ë¹„íŠ¸), 16ë¶„ìŒí‘œëŠ” 1-16
        const sixteenthNote = ((currentBeat.beat - 1) * 4) + 1;

        // 16ë¶„ìŒí‘œ ë²”ìœ„ (ì˜ˆ: beat=1ì´ë©´ 1-4, beat=2ì´ë©´ 5-8)
        for (let i = 0; i < 4; i++) {
            const noteIndex = sixteenthNote + i;
            if (noteIndex <= 16) {
                const activeBox = document.querySelector(`.viz-beat-box[data-beat="${noteIndex}"]`);
                if (activeBox && i === 0) {  // ê° ë¹„íŠ¸ì˜ ì²« ë²ˆì§¸ 16ë¶„ìŒí‘œë§Œ ê°•ì¡°
                    activeBox.classList.add('active');
                }
            }
        }

        // ë™ì‘ ì•…ë³´ì— ë”°ë¼ ë™ì‘ í‘œì‹œ
        updateActionIndicator(time);

        // ê°€ì‚¬ ë…¸ë˜ë°© ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        updateKaraokeLyrics(time);
    }

    // ë™ì‘ ì•…ë³´ì— ë”°ë¼ ë™ì‘ í‘œì‹œ
    function updateActionIndicator(time) {
        const data = window.vizData;
        if (!data || !data.verse1Timeline) return;

        const timeline = data.verse1Timeline;

        // ë™ì‘ ì´ëª¨ì§€ ë§¤í•‘ (0ë¶€í„° ì‹œì‘)
        const actionIcons = {
            0: 'ğŸ‘',      // 1, 2ì ˆ ì† ë°•ìˆ˜
            1: 'ğŸ‘',      // 1ì ˆ íŒ” ì¹˜ê¸°
            2: 'ğŸ‘',      // 2ì ˆ 1ë‹¨ê³„ ì—‰ë©ì´ ë°•ìˆ˜
            3: 'ğŸ™†â€â™€ï¸',  // 2ì ˆ 2ë‹¨ê³„ íŒ” ë»—ê¸°
            4: 'ğŸ¤¸',      // 2ì ˆ 2ë‹¨ê³„ ê¸°ìš°ëš±
            5: 'ğŸšª',      // 2ì ˆ ë¹„ìƒêµ¬
            6: 'ğŸ™‹',      // 2ì ˆ ê²¨ë“œë‘ì´ë°•ìˆ˜
            7: 'ğŸ’ƒ'       // ê¸°íƒ€
        };

        // í˜„ì¬ ì‹œê°„ì—ì„œ Â±0.2ì´ˆ ë‚´ì˜ ë™ì‘ ì°¾ê¸°
        const currentAction = timeline.find(event =>
            Math.abs(event.time - time) < 0.2
        );

        const actionIndicator = document.getElementById('viz-action-indicator');
        const actionIcon = document.getElementById('viz-action-icon');
        const actionName = document.getElementById('viz-action-name');

        if (currentAction && (!window.lastActionTime || Math.abs(window.lastActionTime - currentAction.time) > 0.3)) {
            // ìƒˆë¡œìš´ ë™ì‘ í‘œì‹œ
            window.lastActionTime = currentAction.time;

            actionIcon.textContent = actionIcons[currentAction.actionCode] || 'ğŸ’ƒ';
            actionName.textContent = currentAction.actionName || 'ë™ì‘';

            actionIndicator.classList.add('active');
            setTimeout(() => actionIndicator.classList.remove('active'), 400);
        }
    }

    // ê°€ì‚¬ ë…¸ë˜ë°© ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    function updateKaraokeLyrics(time) {
        const data = window.vizData;
        if (!data || !data.lyricsInfo || !data.lyricsInfo.lines) return;

        const lyrics = data.lyricsInfo.lines;

        // í˜„ì¬ ì‹œê°„ì— í•´ë‹¹í•˜ëŠ” ê°€ì‚¬ ì°¾ê¸°
        let currentLyric = null;
        let nextLyric = null;
        let progress = 0;

        for (let i = 0; i < lyrics.length; i++) {
            const lyric = lyrics[i];
            if (time >= lyric.start && time < lyric.end) {
                currentLyric = lyric;
                nextLyric = lyrics[i + 1] || null;

                // í˜„ì¬ ê°€ì‚¬ ì§„í–‰ë¥  ê³„ì‚°
                const duration = lyric.end - lyric.start;
                const elapsed = time - lyric.start;
                progress = (elapsed / duration) * 100;
                break;
            }
        }

        // UI ì—…ë°ì´íŠ¸
        const currentLyricEl = document.getElementById('viz-current-lyric');
        const nextLyricEl = document.getElementById('viz-next-lyric');
        const progressBarEl = document.getElementById('viz-lyric-progress-bar');

        if (currentLyric) {
            currentLyricEl.textContent = currentLyric.text;
            nextLyricEl.textContent = nextLyric ? `ë‹¤ìŒ: ${nextLyric.text}` : 'ë§ˆì§€ë§‰ ê°€ì‚¬';
            progressBarEl.style.width = progress + '%';
        } else {
            currentLyricEl.textContent = 'ê°€ì‚¬ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...';
            nextLyricEl.textContent = lyrics[0] ? `ë‹¤ìŒ: ${lyrics[0].text}` : '-';
            progressBarEl.style.width = '0%';
        }
    }

    // ===== ê³¡ ë“±ë¡ ê´€ë ¨ í•¨ìˆ˜ë“¤ =====

    let currentUploadStep = 1;
    let uploadedFiles = {
        audio: null,
        lyrics: null,
        choreography: null
    };

    function openSongUploadModal() {
        currentUploadStep = 1;
        uploadedFiles = { audio: null, lyrics: null, choreography: null };
        document.getElementById('song-upload-modal').classList.add('show');
        updateUploadStepUI();

        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('song-title').value = '';
        document.getElementById('song-artist').value = '';
        document.getElementById('song-s3-key').value = '';
        document.getElementById('audio-file-name').textContent = '';
        document.getElementById('lyrics-file-name').textContent = '';
        document.getElementById('choreography-file-name').textContent = '';
    }

    function closeSongUploadModal() {
        document.getElementById('song-upload-modal').classList.remove('show');
    }

    function nextSongUploadStep() {
        // í˜„ì¬ ë‹¨ê³„ ê²€ì¦
        if (currentUploadStep === 1) {
            const title = document.getElementById('song-title').value.trim();
            const artist = document.getElementById('song-artist').value.trim();
            const s3Key = document.getElementById('song-s3-key').value.trim();
            if (!title || !artist || !s3Key) {
                alert('ê³¡ ì œëª©, ì•„í‹°ìŠ¤íŠ¸, S3 Keyë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
        } else if (currentUploadStep === 2) {
            if (!uploadedFiles.audio || !uploadedFiles.lyrics) {
                alert('ì˜¤ë””ì˜¤ íŒŒì¼ê³¼ ê°€ì‚¬ íŒŒì¼ì„ ëª¨ë‘ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }
        } else if (currentUploadStep === 3) {
            if (!uploadedFiles.choreography) {
                alert('ì•ˆë¬´ JSON íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }
        } else if (currentUploadStep === 4) {
            // ì—…ë¡œë“œ ì‹œì‘
            currentUploadStep++;
            updateUploadStepUI();
            uploadSongToServer();
            return;
        }

        if (currentUploadStep < 6) {
            currentUploadStep++;
            updateUploadStepUI();
        }
    }

    function prevSongUploadStep() {
        if (currentUploadStep > 1 && currentUploadStep !== 5 && currentUploadStep !== 6) {
            currentUploadStep--;
            updateUploadStepUI();
        }
    }

    function updateUploadStepUI() {
        // ìŠ¤í… ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸
        document.querySelectorAll('.step').forEach(step => {
            const stepNum = parseInt(step.dataset.step);
            step.classList.remove('active', 'completed');
            if (stepNum === currentUploadStep) {
                step.classList.add('active');
            } else if (stepNum < currentUploadStep) {
                step.classList.add('completed');
            }
        });

        // ì»¨í…ì¸  ì—…ë°ì´íŠ¸
        document.querySelectorAll('.step-content').forEach(content => {
            content.classList.remove('active');
        });
        document.querySelector(`.step-content[data-step="${currentUploadStep}"]`).classList.add('active');

        // 4ë‹¨ê³„(ë¯¸ë¦¬ë³´ê¸°)ì— ë„ë‹¬í•˜ë©´ ë¯¸ë¦¬ë³´ê¸° ì •ë³´ ì—…ë°ì´íŠ¸
        if (currentUploadStep === 4) {
            document.getElementById('preview-title').textContent = document.getElementById('song-title').value || '-';
            document.getElementById('preview-artist').textContent = document.getElementById('song-artist').value || '-';
            document.getElementById('preview-audio').textContent = uploadedFiles.audio ? uploadedFiles.audio.name : '-';
            document.getElementById('preview-lyrics').textContent = uploadedFiles.lyrics ? uploadedFiles.lyrics.name : '-';
            document.getElementById('preview-choreography').textContent = uploadedFiles.choreography ? uploadedFiles.choreography.name : '-';
        }

        // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        const prevBtn = document.getElementById('btn-prev-step');
        const nextBtn = document.getElementById('btn-next-step');
        const actions = document.getElementById('song-upload-actions');

        if (currentUploadStep === 1) {
            prevBtn.style.display = 'none';
            nextBtn.textContent = 'ë‹¤ìŒ';
            actions.style.display = 'flex';
        } else if (currentUploadStep === 5 || currentUploadStep === 6) {
            actions.style.display = 'none';
        } else {
            prevBtn.style.display = 'block';
            nextBtn.textContent = currentUploadStep === 4 ? 'ì—…ë¡œë“œ ì‹œì‘' : 'ë‹¤ìŒ';
            actions.style.display = 'flex';
        }
    }

    function handleFileSelect(event, fileType) {
        const file = event.target.files[0];
        if (file) {
            uploadedFiles[fileType] = file;
            const displayName = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            document.getElementById(`${fileType}-file-name`).textContent = displayName;
        }
    }

    async function uploadSongToServer() {
        try {
            console.log('ğŸµ ê³¡ ì—…ë¡œë“œ ì‹œì‘');
            console.log('ğŸ”‘ ì‚¬ìš© ì¤‘ì¸ í† í°:', accessToken ? 'ìˆìŒ (ê¸¸ì´: ' + accessToken.length + ')' : 'âŒ ì—†ìŒ!');

            const s3Key = document.getElementById('song-s3-key').value.trim();
            if (!s3Key) {
                alert('S3 Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                currentUploadStep = 1;
                updateUploadStepUI();
                return;
            }

            const formData = new FormData();
            formData.append('title', document.getElementById('song-title').value);
            formData.append('artist', document.getElementById('song-artist').value);
            formData.append('s3Key', s3Key);
            formData.append('audioFile', uploadedFiles.audio);
            formData.append('lyricsFile', uploadedFiles.lyrics);
            formData.append('choreographyJson', uploadedFiles.choreography);

            console.log('ğŸ“ S3 Key:', s3Key);

            // ì§„í–‰ë¥  í‘œì‹œ ì‹œì‘
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 5;
                if (progress <= 90) {
                    updateUploadProgress(progress);
                }
            }, 1000);

            console.log('ğŸ“¤ API ìš”ì²­ URL:', `${API_BASE}/admins/songs`);
            const res = await fetch(`${API_BASE}/admins/songs`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                },
                body: formData
            });

            clearInterval(progressInterval);

            console.log('ğŸ“¥ ì‘ë‹µ ìƒíƒœ:', res.status, res.statusText);

            if (res.ok) {
                const result = await res.json();
                console.log('âœ… ì—…ë¡œë“œ ì„±ê³µ:', result);
                updateUploadProgress(100);
                setTimeout(() => {
                    currentUploadStep = 6;
                    updateUploadStepUI();
                }, 500);
            } else {
                const error = await res.json().catch(() => ({ message: res.statusText }));
                console.error('âŒ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                console.error('   ìƒíƒœ ì½”ë“œ:', res.status);
                console.error('   ì—ëŸ¬ ë‚´ìš©:', error);
                alert(`ì—…ë¡œë“œ ì‹¤íŒ¨ (${res.status}): ${error.error || error.message || res.statusText}`);
                currentUploadStep = 2;
                updateUploadStepUI();
            }

        } catch (e) {
            console.error('âŒ ì—…ë¡œë“œ ì¤‘ ì˜ˆì™¸ ë°œìƒ:', e);
            alert(`ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.message}`);
            currentUploadStep = 2;
            updateUploadStepUI();
        }
    }

    function updateUploadProgress(percent) {
        const fillEl = document.getElementById('upload-progress-fill');
        const textEl = document.getElementById('upload-progress-text');
        fillEl.style.width = percent + '%';
        fillEl.textContent = percent + '%';

        if (percent < 20) {
            textEl.textContent = 'íŒŒì¼ì„ ì„œë²„ì— ì—…ë¡œë“œí•˜ê³  ìˆìŠµë‹ˆë‹¤...';
        } else if (percent < 50) {
            textEl.textContent = 'ì˜¤ë””ì˜¤ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤... (ë¹„íŠ¸ ê²€ì¶œ)';
        } else if (percent < 70) {
            textEl.textContent = 'ê°€ì‚¬ íƒ€ì´ë°ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
        } else if (percent < 90) {
            textEl.textContent = 'ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
        } else {
            textEl.textContent = 'ê³¡ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!';
        }
    }

    function goToVisualizationAfterUpload() {
        closeSongUploadModal();
        showVisualizationScreen();
        // ê³¡ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        loadSongList();
    }

    // ===== ê³¡ ê°„í¸ ë“±ë¡ ê´€ë ¨ í•¨ìˆ˜ë“¤ =====

    let simpleUploadedFiles = {
        audio: null,
        lyrics: null
    };

    let analyzedData = null; // ë¶„ì„ ê²°ê³¼ ì €ì¥

    function openSimpleSongUploadModal() {
        simpleUploadedFiles = { audio: null, lyrics: null };
        analyzedData = null;
        document.getElementById('simple-song-upload-modal').classList.add('show');

        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('simple-song-title').value = '';
        document.getElementById('simple-song-artist').value = '';
        document.getElementById('simple-song-s3-key').value = '';
        document.getElementById('simple-audio-file').value = '';
        document.getElementById('simple-lyrics-file').value = '';
        document.getElementById('simple-audio-file-name').textContent = '';
        document.getElementById('simple-lyrics-file-name').textContent = '';
        document.getElementById('simple-upload-progress-container').style.display = 'none';
        document.getElementById('simple-upload-result').innerHTML = '';
        document.getElementById('analysis-preview-container').style.display = 'none';
        document.getElementById('btn-simple-upload').style.display = 'inline-block';
        document.getElementById('btn-confirm-register').style.display = 'none';
    }

    function closeSimpleSongUploadModal() {
        document.getElementById('simple-song-upload-modal').classList.remove('show');
    }

    function handleSimpleFileSelect(event, fileType) {
        const file = event.target.files[0];
        if (file) {
            simpleUploadedFiles[fileType] = file;
            document.getElementById(`simple-${fileType}-file-name`).textContent = `âœ… ${file.name}`;
        }
    }

    async function uploadSimpleSong() {
        try {
            console.log('ğŸµ ê³¡ ë¶„ì„ ì‹œì‘ (music-server)');

            // ì…ë ¥ê°’ ê²€ì¦
            const title = document.getElementById('simple-song-title').value.trim();
            const artist = document.getElementById('simple-song-artist').value.trim();
            const s3Key = document.getElementById('simple-song-s3-key').value.trim();

            if (!title || !artist || !s3Key) {
                alert('ê³¡ ì œëª©, ì•„í‹°ìŠ¤íŠ¸, S3 Keyë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!simpleUploadedFiles.audio || !simpleUploadedFiles.lyrics) {
                alert('ì˜¤ë””ì˜¤ íŒŒì¼ê³¼ ê°€ì‚¬ íŒŒì¼ì„ ëª¨ë‘ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }

            // FormData ìƒì„± (Spring ì„œë²„ -> music-server ë¶„ì„ìš©)
            const formData = new FormData();
            formData.append('title', title);
            formData.append('audioFile', simpleUploadedFiles.audio);
            formData.append('lyricsFile', simpleUploadedFiles.lyrics);

            console.log('ğŸ“ Audio:', simpleUploadedFiles.audio.name);
            console.log('ğŸ“ Lyrics:', simpleUploadedFiles.lyrics.name);

            // ì§„í–‰ë¥  í‘œì‹œ ì‹œì‘
            document.getElementById('simple-upload-progress-container').style.display = 'block';
            document.getElementById('btn-simple-upload').disabled = true;

            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 10;
                if (progress <= 90) {
                    updateSimpleAnalysisProgress(progress);
                }
            }, 800);

            // Spring ì„œë²„ë¥¼ í†µí•´ music-serverë¡œ ë¶„ì„ ìš”ì²­
            console.log('ğŸ“¤ Spring ì„œë²„ -> music-server ë¶„ì„ ìš”ì²­');
            console.log('ğŸ”‘ ì‚¬ìš© ì¤‘ì¸ í† í°:', accessToken ? 'ìˆìŒ (ê¸¸ì´: ' + accessToken.length + ')' : 'âŒ ì—†ìŒ!');
            const res = await fetch(`${API_BASE}/admins/songs/analyze-only`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                },
                body: formData
            });

            clearInterval(progressInterval);

            console.log('ğŸ“¥ ì‘ë‹µ ìƒíƒœ:', res.status, res.statusText);

            if (res.ok) {
                const result = await res.json();
                console.log('âœ… ë¶„ì„ ì„±ê³µ:', result);
                updateSimpleAnalysisProgress(100);

                // ë¶„ì„ ê²°ê³¼ ì €ì¥
                analyzedData = {
                    title: title,
                    artist: artist,
                    s3Key: s3Key,
                    beats: result.beats,
                    lyrics: result.lyrics,
                    duration: result.duration
                };

                // ë¶„ì„ ê²°ê³¼ ì‹œê°í™”
                displayAnalysisPreview(analyzedData);

                // UI ì—…ë°ì´íŠ¸
                document.getElementById('simple-upload-progress-container').style.display = 'none';
                document.getElementById('analysis-preview-container').style.display = 'block';
                document.getElementById('btn-simple-upload').style.display = 'none';
                document.getElementById('btn-confirm-register').style.display = 'inline-block';

            } else {
                const error = await res.json().catch(() => ({ message: res.statusText }));
                console.error('âŒ ë¶„ì„ ì‹¤íŒ¨:', error);
                alert(`ë¶„ì„ ì‹¤íŒ¨ (${res.status}): ${error.detail || error.message || res.statusText}`);
                document.getElementById('simple-upload-progress-container').style.display = 'none';
                document.getElementById('btn-simple-upload').disabled = false;
            }

        } catch (e) {
            console.error('âŒ ë¶„ì„ ì¤‘ ì˜ˆì™¸ ë°œìƒ:', e);
            alert(`ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.message}\n\nmusic-serverê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`);
            document.getElementById('simple-upload-progress-container').style.display = 'none';
            document.getElementById('btn-simple-upload').disabled = false;
        }
    }

    let wavesurfer = null;
    let beatIntervalChart = null;
    let lyricsTimelineChart = null;

    function displayAnalysisPreview(data) {
        console.log('ğŸ“Š ë¶„ì„ ê²°ê³¼ ì‹œê°í™” ì‹œì‘');

        // 1. í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
        const bpm = data.beats.tempoMap[0].bpm.toFixed(1);
        const beatsCount = data.beats.beats.length;
        const durationMin = Math.floor(data.duration / 60);
        const durationSec = Math.floor(data.duration % 60);
        const lyricsCount = data.lyrics.lines.length;

        document.getElementById('preview-bpm').textContent = bpm;
        document.getElementById('preview-beats-count').textContent = beatsCount;
        document.getElementById('preview-duration').textContent = `${durationMin}:${durationSec.toString().padStart(2, '0')}`;
        document.getElementById('preview-lyrics-count-card').textContent = lyricsCount;

        // 2. ì˜¤ë””ì˜¤ íŒŒí˜• ì‹œê°í™” (WaveSurfer.js)
        initializeWaveform(data);

        // 3. ë¹„íŠ¸ ê°„ê²© ë¶„í¬ ì°¨íŠ¸
        createBeatIntervalChart(data.beats.beats);

        // 4. ê°€ì‚¬-ë¹„íŠ¸ ë§¤ì¹­ íƒ€ì„ë¼ì¸
        createLyricsTimelineChart(data.lyrics.lines, data.beats.beats);

        // 5. ê°€ì‚¬ ëª©ë¡
        displayLyricsList(data.lyrics.lines);
    }

    function initializeWaveform(data) {
        console.log('ğŸµ WaveSurfer ì´ˆê¸°í™”');

        // ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ ì œê±°
        if (wavesurfer) {
            wavesurfer.destroy();
        }

        const container = document.getElementById('waveform-container');
        container.innerHTML = ''; // ì´ˆê¸°í™”

        // WaveSurfer ìƒì„±
        wavesurfer = WaveSurfer.create({
            container: container,
            waveColor: '#ddd',
            progressColor: '#667eea',
            cursorColor: '#764ba2',
            barWidth: 2,
            barRadius: 3,
            cursorWidth: 2,
            height: 120,
            barGap: 1,
            responsive: true
        });

        // ì˜¤ë””ì˜¤ íŒŒì¼ ë¡œë“œ (simpleUploadedFiles.audio ì‚¬ìš©)
        if (simpleUploadedFiles.audio) {
            const audioUrl = URL.createObjectURL(simpleUploadedFiles.audio);
            wavesurfer.load(audioUrl);

            wavesurfer.on('ready', () => {
                console.log('âœ… WaveSurfer ì¤€ë¹„ ì™„ë£Œ');
                // ë¹„íŠ¸ ë§ˆì»¤ ì¶”ê°€
                addBeatMarkers(data.beats.beats);
                // ê°€ì‚¬ êµ¬ê°„ ë§ˆì»¤ ì¶”ê°€
                addLyricsRegions(data.lyrics.lines);
            });

            wavesurfer.on('audioprocess', updatePlaybackTime);
            wavesurfer.on('seek', updatePlaybackTime);
        }
    }

    function addBeatMarkers(beats) {
        // ë¹„íŠ¸ ë§ˆì»¤ëŠ” WaveSurfer Regions í”ŒëŸ¬ê·¸ì¸ì´ í•„ìš”í•˜ë¯€ë¡œ
        // ê°„ë‹¨í•˜ê²Œ CSSë¡œ í‘œì‹œ (ë˜ëŠ” canvas overlay)
        // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ êµ¬í˜„
    }

    function addLyricsRegions(lyrics) {
        // ê°€ì‚¬ êµ¬ê°„ í‘œì‹œ
        // WaveSurfer Regions í”ŒëŸ¬ê·¸ì¸ ì‚¬ìš© ì‹œ ì¶”ê°€ ê°€ëŠ¥
    }

    function toggleWaveformPlayback() {
        if (wavesurfer) {
            wavesurfer.playPause();
            const btn = document.getElementById('btn-play-pause');
            if (wavesurfer.isPlaying()) {
                btn.textContent = 'â¸ï¸ ì¼ì‹œì •ì§€';
                btn.style.background = '#dc3545';
            } else {
                btn.textContent = 'â–¶ï¸ ì¬ìƒ';
                btn.style.background = '#667eea';
            }
        }
    }

    function updatePlaybackTime() {
        if (!wavesurfer) return;

        const currentTime = wavesurfer.getCurrentTime();
        const duration = wavesurfer.getDuration();

        const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = (seconds % 60).toFixed(1);
            return `${mins.toString().padStart(2, '0')}:${secs.padStart(4, '0')}`;
        };

        document.getElementById('current-time-display').textContent =
            `${formatTime(currentTime)} / ${formatTime(duration)}`;

        const progress = (currentTime / duration) * 100;
        document.getElementById('playback-progress').style.width = progress + '%';
    }

    function createBeatIntervalChart(beats) {
        console.log('ğŸ“Š ë¹„íŠ¸ ê°„ê²© ì°¨íŠ¸ ìƒì„±');

        // ë¹„íŠ¸ ê°„ ì‹œê°„ ê°„ê²© ê³„ì‚°
        const intervals = [];
        for (let i = 1; i < beats.length; i++) {
            intervals.push((beats[i].t - beats[i-1].t) * 1000); // msë¡œ ë³€í™˜
        }

        // ê°„ê²© ë¶„í¬ ê³„ì‚° (íˆìŠ¤í† ê·¸ë¨)
        const binCount = 20;
        const min = Math.min(...intervals);
        const max = Math.max(...intervals);
        const binSize = (max - min) / binCount;

        const bins = new Array(binCount).fill(0);
        const labels = [];

        intervals.forEach(interval => {
            const binIndex = Math.min(Math.floor((interval - min) / binSize), binCount - 1);
            bins[binIndex]++;
        });

        for (let i = 0; i < binCount; i++) {
            labels.push(`${(min + i * binSize).toFixed(0)}ms`);
        }

        // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
        if (beatIntervalChart) {
            beatIntervalChart.destroy();
        }

        const ctx = document.getElementById('beat-interval-chart');
        beatIntervalChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ë¹„íŠ¸ ê°„ê²© ë¹ˆë„',
                    data: bins,
                    backgroundColor: 'rgba(102, 126, 234, 0.6)',
                    borderColor: '#667eea',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: `í‰ê·  ê°„ê²©: ${(intervals.reduce((a,b) => a+b, 0) / intervals.length).toFixed(1)}ms (ì¼ì •í• ìˆ˜ë¡ BPM ì•ˆì •ì )`
                    }
                },
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'ë¹ˆë„' } },
                    x: { title: { display: true, text: 'ë¹„íŠ¸ ê°„ê²© (ms)' } }
                }
            }
        });
    }

    function createLyricsTimelineChart(lyrics, beats) {
        console.log('ğŸ¤ ê°€ì‚¬ íƒ€ì„ë¼ì¸ ì°¨íŠ¸ ìƒì„±');

        // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
        if (lyricsTimelineChart) {
            lyricsTimelineChart.destroy();
        }

        const labels = lyrics.slice(0, 15).map(line => `${line.lineIndex}. ${line.text.substring(0, 15)}...`);
        const startTimes = lyrics.slice(0, 15).map(line => line.start);
        const durations = lyrics.slice(0, 15).map(line => line.end - line.start);

        const ctx = document.getElementById('lyrics-timeline-chart');
        lyricsTimelineChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ê°€ì‚¬ ê¸¸ì´ (ì´ˆ)',
                    data: durations,
                    backgroundColor: 'rgba(40, 167, 69, 0.6)',
                    borderColor: '#28a745',
                    borderWidth: 2
                }]
            },
            options: {
                indexAxis: 'y', // ê°€ë¡œ ë§‰ëŒ€
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const idx = context.dataIndex;
                                return [
                                    `ê¸¸ì´: ${durations[idx].toFixed(1)}ì´ˆ`,
                                    `ì‹œì‘: ${startTimes[idx]}s`,
                                    `ë: ${(startTimes[idx] + durations[idx]).toFixed(1)}s`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    x: { beginAtZero: true, title: { display: true, text: 'ê¸¸ì´ (ì´ˆ)' } }
                }
            }
        });
    }

    function displayLyricsList(lyrics) {
        const html = lyrics.map(line => {
            const duration = line.end - line.start;
            const color = duration > 5 ? '#dc3545' : duration > 3 ? '#ffc107' : '#28a745';

            return `<div style="padding:12px; border-bottom:1px solid #ddd; border-left:4px solid ${color}; margin-bottom:5px; background:white; border-radius:4px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <div style="font-weight:bold; color:#333; font-size:14px;">${line.lineIndex}. ${line.text}</div>
                    <div style="background:${color}; color:white; padding:3px 8px; border-radius:12px; font-size:11px; font-weight:bold;">
                        ${duration.toFixed(1)}s
                    </div>
                </div>
                <div style="font-size:11px; color:#666; font-family:monospace;">
                    â±ï¸ ${line.start}s ~ ${line.end}s &nbsp;|&nbsp; ğŸµ Beat ${line.sBeat} ~ ${line.eBeat}
                </div>
            </div>`;
        }).join('');

        document.getElementById('preview-lyrics-list').innerHTML = html;
    }

    async function confirmAndRegisterSong() {
        try {
            console.log('âœ… ê³¡ ë“±ë¡ í™•ì •');
            console.log('ğŸ”‘ ì‚¬ìš© ì¤‘ì¸ í† í°:', accessToken ? 'ìˆìŒ (ê¸¸ì´: ' + accessToken.length + ')' : 'âŒ ì—†ìŒ!');

            if (!analyzedData) {
                alert('ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¶„ì„í•´ì£¼ì„¸ìš”.');
                return;
            }

            // FormData ìƒì„± (Spring ì„œë²„ ë“±ë¡ìš©)
            const formData = new FormData();
            formData.append('title', analyzedData.title);
            formData.append('artist', analyzedData.artist);
            formData.append('s3Key', analyzedData.s3Key);
            formData.append('audioFile', simpleUploadedFiles.audio);
            formData.append('lyricsFile', simpleUploadedFiles.lyrics);

            console.log('ğŸ“¤ Spring ì„œë²„ë¡œ ë“±ë¡ ìš”ì²­');
            document.getElementById('btn-confirm-register').disabled = true;
            document.getElementById('btn-confirm-register').textContent = 'ë“±ë¡ ì¤‘...';

            const res = await fetch(`${API_BASE}/admins/songs/auto`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                },
                body: formData
            });

            console.log('ğŸ“¥ ì‘ë‹µ ìƒíƒœ:', res.status, res.statusText);

            if (res.ok) {
                const result = await res.json();
                console.log('âœ… ë“±ë¡ ì„±ê³µ:', result);

                document.getElementById('simple-upload-result').innerHTML = `
                    <div style="background:#d4edda; border:2px solid #c3e6cb; border-radius:10px; padding:20px; text-align:center;">
                        <div style="font-size:50px; margin-bottom:10px;">âœ…</div>
                        <h3 style="color:#155724; margin-bottom:10px;">ê³¡ ë“±ë¡ ì™„ë£Œ!</h3>
                        <p style="color:#155724;">
                            ê³¡ ID: ${result.songId}<br>
                            ì œëª©: ${result.title}<br>
                            ì•„í‹°ìŠ¤íŠ¸: ${result.artist}
                        </p>
                        <button class="btn btn-primary" onclick="goToVisualizationAfterSimpleUpload()" style="margin-top:15px;">ğŸµ ê³¡ ì‹œê°í™” ë³´ê¸°</button>
                    </div>
                `;

                document.getElementById('analysis-preview-container').style.display = 'none';
                document.getElementById('btn-confirm-register').style.display = 'none';

            } else {
                const error = await res.json().catch(() => ({ message: res.statusText }));
                console.error('âŒ ë“±ë¡ ì‹¤íŒ¨:', error);
                alert(`ë“±ë¡ ì‹¤íŒ¨ (${res.status}): ${error.error || error.message || res.statusText}`);
                document.getElementById('btn-confirm-register').disabled = false;
                document.getElementById('btn-confirm-register').textContent = 'âœ… ë“±ë¡ í™•ì •';
            }

        } catch (e) {
            console.error('âŒ ë“±ë¡ ì¤‘ ì˜ˆì™¸ ë°œìƒ:', e);
            alert(`ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.message}`);
            document.getElementById('btn-confirm-register').disabled = false;
            document.getElementById('btn-confirm-register').textContent = 'âœ… ë“±ë¡ í™•ì •';
        }
    }

    function updateSimpleAnalysisProgress(percent) {
        const fillEl = document.getElementById('simple-upload-progress-fill');
        const textEl = document.getElementById('simple-upload-progress-text');
        fillEl.style.width = percent + '%';
        fillEl.textContent = percent + '%';

        if (percent < 30) {
            textEl.textContent = 'ì˜¤ë””ì˜¤ íŒŒì¼ ë¡œë”© ì¤‘...';
        } else if (percent < 60) {
            textEl.textContent = 'ë¹„íŠ¸ ê²€ì¶œ ì¤‘... (librosa)';
        } else if (percent < 90) {
            textEl.textContent = 'ê°€ì‚¬ íƒ€ì´ë° ë¶„ì„ ì¤‘...';
        } else {
            textEl.textContent = 'ë¶„ì„ ì™„ë£Œ!';
        }
    }

    function goToVisualizationAfterSimpleUpload() {
        closeSimpleSongUploadModal();
        showVisualizationScreen();
        // ê³¡ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        loadSongList();
    }

    // ===== ì•…ë³´ íƒ€ì„ë¼ì¸ ë Œë”ë§ =====

    function renderScoreTimeline(data) {
        console.log('ğŸ¼ ì•…ë³´ íƒ€ì„ë¼ì¸ ë Œë”ë§ ì‹œì‘', data);

        document.getElementById('timeline-loading').style.display = 'none';
        document.getElementById('score-timeline-content').style.display = 'block';

        const { beats, lyrics, actionTimeline, sections } = data;
        const duration = beats.audio.durationSec;

        // ì„¹ì…˜ ìƒ‰ìƒ ë§¤í•‘
        const sectionColors = {
            'intro': '#667eea',
            'verse1': '#28a745',
            'break': '#ffc107',
            'verse2': '#764ba2'
        };

        // íŒ¨í„´ ìƒ‰ìƒ ë§¤í•‘
        const patternColors = {
            'P1': '#4facfe',
            'P2': '#43e97b',
            'P3': '#fa709a',
            'P4': '#f093fb'
        };

        // 1. ìƒë‹¨ ì¶•ì•½ íƒ€ì„ë¼ì¸ ë Œë”ë§
        renderOverviewTimeline(sections, duration, sectionColors);

        // 2. ì¤‘ê°„ ìƒì„¸ íƒ€ì„ë¼ì¸ ë Œë”ë§
        renderDetailTimeline(data, sectionColors, patternColors);

        // 3. ë“œë˜ê·¸ ìŠ¤í¬ë¡¤ ê¸°ëŠ¥ ì¶”ê°€
        enableDragScroll();
    }

    function renderOverviewTimeline(sections, duration, colors) {
        const container = document.getElementById('overview-sections');
        if (!container) return;

        container.innerHTML = '';

        if (!sections || sections.length === 0) {
            container.innerHTML = '<div style="padding:30px; text-align:center; color:#999;">ì„¹ì…˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            return;
        }

        sections.forEach(section => {
            const startPercent = (section.startTime / duration) * 100;
            const widthPercent = ((section.endTime - section.startTime) / duration) * 100;
            const color = colors[section.label] || '#ccc';

            const div = document.createElement('div');
            div.style.cssText = `
                position: absolute;
                left: ${startPercent}%;
                width: ${widthPercent}%;
                height: 100%;
                background: ${color};
                border-right: 2px solid rgba(255,255,255,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                font-size: 14px;
                cursor: pointer;
                transition: transform 0.2s;
            `;
            div.textContent = section.label.toUpperCase();
            div.title = `${section.startTime.toFixed(1)}s ~ ${section.endTime.toFixed(1)}s`;

            // í´ë¦­í•˜ë©´ í•´ë‹¹ ìœ„ì¹˜ë¡œ ìŠ¤í¬ë¡¤
            div.onclick = () => {
                const scrollContainer = document.getElementById('detail-timeline-scroll');
                const targetX = (section.startTime / duration) * 2000;
                scrollContainer.scrollLeft = targetX - 200;
            };

            div.onmouseenter = () => div.style.transform = 'translateY(-2px)';
            div.onmouseleave = () => div.style.transform = 'translateY(0)';

            container.appendChild(div);
        });
    }

    function renderDetailTimeline(data, sectionColors, patternColors) {
        const { beats, lyrics, actionTimeline, sections } = data;
        const duration = beats.audio.durationSec;
        const pixelPerSecond = 2000 / duration; // 2000px for total duration

        // ë°°ê²½ ê·¸ë¦¬ë“œ
        renderGrid(duration, pixelPerSecond);

        // ì„¹ì…˜ ë ˆì´ì–´
        renderSectionLayer(sections, duration, pixelPerSecond, sectionColors);

        // ê°€ì‚¬ ë ˆì´ì–´
        renderLyricsLayer(lyrics.lines, duration, pixelPerSecond);

        // ë¹„íŠ¸ ë ˆì´ì–´
        renderBeatsLayer(beats.beats, duration, pixelPerSecond);

        // ë™ì‘ íŒ¨í„´ ë ˆì´ì–´
        renderPatternsLayer(actionTimeline, duration, pixelPerSecond, patternColors);

        // ì‹œê°„ì¶•
        renderTimeAxis(duration, pixelPerSecond);
    }

    function renderGrid(duration, pixelPerSecond) {
        const container = document.getElementById('timeline-grid');
        if (!container) return;

        let html = '';
        for (let t = 0; t <= duration; t += 5) {
            const x = t * pixelPerSecond;
            const opacity = t % 10 === 0 ? 0.3 : 0.1;
            html += `<div style="position:absolute; left:${x}px; top:0; bottom:0; width:1px; background:rgba(0,0,0,${opacity});"></div>`;
        }
        container.innerHTML = html;
    }

    function renderSectionLayer(sections, duration, pixelPerSecond, colors) {
        const container = document.getElementById('timeline-sections');
        if (!container || !sections) return;

        container.innerHTML = sections.map(section => {
            const x = section.startTime * pixelPerSecond;
            const width = (section.endTime - section.startTime) * pixelPerSecond;
            const color = colors[section.label] || '#ccc';

            return `<div style="position:absolute; left:${x}px; width:${width}px; height:100%; background:${color}; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; border:2px solid white; border-radius:4px; font-size:16px;">
                ${section.label.toUpperCase()}
            </div>`;
        }).join('');
    }

    function renderLyricsLayer(lyricsLines, duration, pixelPerSecond) {
        const container = document.getElementById('timeline-lyrics');
        if (!container || !lyricsLines) return;

        container.innerHTML = lyricsLines.map(line => {
            const x = line.start * pixelPerSecond;
            const width = (line.end - line.start) * pixelPerSecond;

            return `<div style="position:absolute; left:${x}px; width:${width}px; height:70px; background:#28a745; color:white; padding:8px; border-radius:6px; border:2px solid white; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:13px; display:flex; flex-direction:column; justify-content:center;" title="${line.text}">
                <div style="font-weight:bold;">â™ª ${line.text.substring(0, 30)}${line.text.length > 30 ? '...' : ''}</div>
                <div style="font-size:10px; opacity:0.9; margin-top:3px;">${line.start}s ~ ${line.end}s</div>
            </div>`;
        }).join('');
    }

    function renderBeatsLayer(beatsArray, duration, pixelPerSecond) {
        const container = document.getElementById('timeline-beats');
        if (!container || !beatsArray) return;

        let html = '';
        beatsArray.forEach((beat, index) => {
            const x = beat.t * pixelPerSecond;
            const isBarStart = beat.beat === 1;
            const color = isBarStart ? '#dc3545' : '#667eea';
            const size = isBarStart ? 12 : 8;

            html += `<div style="position:absolute; left:${x-size/2}px; top:25px; width:${size}px; height:${size}px; background:${color}; border-radius:50%; border:${isBarStart ? '2px solid white' : 'none'};" title="Bar ${beat.bar} Beat ${beat.beat} (${beat.t.toFixed(2)}s)"></div>`;

            // Bar ë²ˆí˜¸ í‘œì‹œ (ë§¤ 4 barë§ˆë‹¤)
            if (isBarStart && beat.bar % 4 === 1) {
                html += `<div style="position:absolute; left:${x}px; top:5px; font-size:10px; color:#666; font-weight:bold;">Bar ${beat.bar}</div>`;
            }
        });

        container.innerHTML = html;
    }

    function renderPatternsLayer(timeline, duration, pixelPerSecond, colors) {
        const container = document.getElementById('timeline-patterns');
        if (!container || !timeline) return;

        // íŒ¨í„´ ê·¸ë£¹í™” (ì—°ì†ëœ ê°™ì€ íŒ¨í„´ í•©ì¹˜ê¸°)
        const groups = [];
        let currentGroup = null;

        timeline.forEach(event => {
            if (!currentGroup || currentGroup.patternId !== event.patternId) {
                if (currentGroup) groups.push(currentGroup);
                currentGroup = {
                    patternId: event.patternId,
                    startTime: event.time,
                    endTime: event.time + (event.duration || 0.5),
                    description: event.description
                };
            } else {
                currentGroup.endTime = event.time + (event.duration || 0.5);
            }
        });
        if (currentGroup) groups.push(currentGroup);

        container.innerHTML = groups.map(group => {
            const x = group.startTime * pixelPerSecond;
            const width = (group.endTime - group.startTime) * pixelPerSecond;
            const color = colors[group.patternId] || '#ccc';

            return `<div style="position:absolute; left:${x}px; width:${width}px; height:70px; background:${color}; color:white; padding:10px; border-radius:6px; border:2px solid white; display:flex; flex-direction:column; justify-content:center; align-items:center; font-weight:bold; font-size:14px;" title="${group.description}">
                <div style="font-size:18px;">${group.patternId}</div>
                <div style="font-size:10px; opacity:0.9; margin-top:3px;">${(group.endTime - group.startTime).toFixed(1)}s</div>
            </div>`;
        }).join('');
    }

    function renderTimeAxis(duration, pixelPerSecond) {
        const container = document.getElementById('timeline-axis');
        if (!container) return;

        let html = '';
        for (let t = 0; t <= duration; t += 10) {
            const x = t * pixelPerSecond;
            const mins = Math.floor(t / 60);
            const secs = Math.floor(t % 60);

            html += `<div style="position:absolute; left:${x}px; top:0;">
                <div style="width:2px; height:20px; background:#333;"></div>
                <div style="position:absolute; left:-20px; top:25px; width:40px; text-align:center; font-size:12px; font-weight:bold; color:#333;">${mins}:${secs.toString().padStart(2, '0')}</div>
            </div>`;
        }

        container.innerHTML = html;
    }

    function enableDragScroll() {
        const scrollContainer = document.getElementById('detail-timeline-scroll');
        if (!scrollContainer) return;

        let isDown = false;
        let startX;
        let scrollLeft;

        scrollContainer.addEventListener('mousedown', (e) => {
            isDown = true;
            scrollContainer.style.cursor = 'grabbing';
            startX = e.pageX - scrollContainer.offsetLeft;
            scrollLeft = scrollContainer.scrollLeft;
        });

        scrollContainer.addEventListener('mouseleave', () => {
            isDown = false;
            scrollContainer.style.cursor = 'grab';
        });

        scrollContainer.addEventListener('mouseup', () => {
            isDown = false;
            scrollContainer.style.cursor = 'grab';
        });

        scrollContainer.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - scrollContainer.offsetLeft;
            const walk = (x - startX) * 2;
            scrollContainer.scrollLeft = scrollLeft - walk;
        });

        // Shift + íœ ë¡œ ê°€ë¡œ ìŠ¤í¬ë¡¤
        scrollContainer.addEventListener('wheel', (e) => {
            if (e.shiftKey) {
                e.preventDefault();
                scrollContainer.scrollLeft += e.deltaY;
            }
        });
    }
</script>
</body>
</html>

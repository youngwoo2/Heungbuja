# 빌드 및 배포 가이드

## 1. 시스템 개요

- 서비스명: **흥부자 (Heungbuja)**
- 주요 컴포넌트
  - **Spring Boot 백엔드**: `backend/spring-server`, 포트 `8080`, 컨텍스트 경로 `/api`
  - **Motion AI 서버**: `backend/motion-server` (FastAPI), 포트 `8000`
  - **Music AI 서버**: `backend/music-server` (FastAPI), 포트 `8001`
  - **사용자 웹 (User)**: `frontend` (React + Vite)
  - **관리자 웹 (Admin)**: `admin` (React + Vite)
  - **인프라 서비스**: MySQL, MongoDB, Redis, Nginx, Certbot
- 컨테이너 오케스트레이션: **Docker Compose** (`docker-compose.yml` 하나로 전체 스택 기동)

## 2. 사전 준비

### 2-1. 필수 소프트웨어

- Docker 20+ / Docker Desktop
- Docker Compose v2+
- Git
- (선택) Java 17, Node.js 18+, Python 3.10+  
  → 개별 서비스만 로컬에서 직접 실행할 때 필요

### 2-2. 사용 포트 및 리소스

- 사용 포트
  - `80`, `443`: Nginx (외부 진입점)
  - `8080`: Spring Boot API
  - `8000`: Motion 서버
  - `8001`: Music 서버
  - `3306`: MySQL
  - `27017`: MongoDB
  - `6379`: Redis
- 권장 리소스
  - CPU: 4코어 이상
  - 메모리: 8GB 이상
  - 디스크: 10GB 이상

## 3. 소스 코드 받기

```bash
git clone <repository-url>
cd S13P31A103
```

> 실제 Git 주소는 프로젝트 저장소 URL을 사용하세요.

## 4. 환경 변수 설정 (`.env`)

프로젝트 루트에 있는 `.env` 파일을 통해 모든 컨테이너에서 공통으로 환경 변수를 사용합니다.  
기본 템플릿은 `.env.example` 을 참고합니다.

```bash
cp .env.example .env
```

`.env` 에서는 아래 항목들을 **실제 값**으로 교체해야 합니다.

```env
# MySQL
MYSQL_ROOT_PASSWORD=실제_root_비밀번호
MYSQL_DATABASE=heungbuja_db
MYSQL_USER=heungbuja_user
MYSQL_PASSWORD=실제_사용자_비밀번호

# Spring Boot
SPRING_PROFILES_ACTIVE=prod
SERVER_PORT=8080

# MongoDB (선택: 기본값 사용 가능)
MONGO_INITDB_ROOT_USERNAME=heungbu
MONGO_INITDB_ROOT_PASSWORD=실제_mongo_root_비밀번호

# Redis
REDIS_PASSWORD=실제_redis_비밀번호

# 외부 연동 키 (상세 발급 방법은 2_외부_환경_설정.md 참고)
OPENAI_GMS_API_KEY=실제_gms_api_key
APP_S3_BUCKET=실제_s3_bucket_이름
APP_S3_REGION=ap-northeast-2
```

- 추가적인 환경 변수는 `backend/spring-server/src/main/resources/application.yml` 을 참고하면 됩니다.
- 비밀번호, 토큰 등 민감 정보는 Git에 커밋하지 않고, 별도의 비밀 관리 방식(예: Vault, Password Manager 등)으로 관리합니다.

## 5. 로컬/개발 환경 실행

### 5-1. 전체 스택 실행

루트 디렉터리에서 다음 명령으로 전체 서비스를 한 번에 실행할 수 있습니다.

```bash
docker compose up -d
```

- 최초 실행 시 이미지 빌드 및 의존성 설치로 인해 시간이 다소 소요될 수 있습니다.
- 컨테이너 상태 확인:

```bash
docker compose ps
docker compose logs -f spring
```

### 5-2. 개별 서비스 헬스 체크

- Spring Boot: `http://localhost:8080/api/health`
- Motion 서버: `http://localhost:8000/health`
- Music 서버: `http://localhost:8001/health`
- 사용자 웹: `http://localhost:3000`
- 관리자 웹: `http://localhost:3001`

## 6. 빌드

### 6-1. Spring Boot 애플리케이션 빌드

로컬에서 백엔드만 별도 빌드가 필요할 경우:

```bash
cd backend/spring-server
./gradlew clean build -x test
```

### 6-2. 프론트엔드 빌드 (선택)

Docker 없이 로컬에서 직접 실행하거나 정적 파일만 배포할 때 사용합니다.

```bash
# 사용자 웹
cd frontend
npm install
npm run build

# 관리자 웹
cd ../admin
npm install
npm run build
```

## 7. 운영 배포

운영 서버(리눅스 기반)를 기준으로 설명합니다.

### 7-1. 코드 및 환경 파일 준비

```bash
git clone <repository-url>
cd S13P31A103
cp .env.example .env
# .env 파일을 열어 운영용 실제 값으로 수정
```

### 7-2. Docker 이미지 빌드 및 컨테이너 기동

```bash
docker compose build
docker compose up -d
```

### 7-3. Nginx + HTTPS 설정 확인

- Nginx 설정 파일: `nginx/nginx.v2.conf`
  - 도메인, 리버스 프록시 경로, 정적 파일 경로 등을 확인/수정
- SSL 인증서 발급: `certbot` 서비스가 `heungbuja.site`, `www.heungbuja.site` 기준으로 인증서를 발급하도록 설정되어 있습니다.
  - 인증서 및 관련 데이터 경로:
    - `certbot/conf`
    - `certbot/www`
    - `nginx/certs` (필요 시 참고)

### 7-4. 서비스 확인

- 사용자 웹: `https://heungbuja.site`
- 관리자 웹: 실제 설정에 따라 `/admin` 또는 별도 서브도메인 사용 가능
- API 헬스 체크: `https://heungbuja.site/api/health`

## 8. 운영 시 보안 체크리스트

- `.env` 파일의 모든 기본 값(`your_*`, 예시 비밀번호 등)을 운영용 강력한 값으로 교체
- DB 계정은 서비스 전용 계정을 사용하고, 최소 권한만 부여
- `.env` 파일 권한을 최소화 (예: `chmod 600 .env`)
- Docker 호스트 방화벽에서 사용하지 않는 포트는 모두 차단
- 정기적으로 이미지/패키지 업데이트 및 취약점 점검 수행

## 9. 트러블슈팅

### 9-1. 컨테이너가 바로 종료되는 경우

```bash
docker compose ps
docker compose logs spring
docker compose logs mysql
docker compose logs nginx
```

- DB 접속 오류: `.env` 의 DB 계정/비밀번호, `SPRING_DATASOURCE_URL` 등을 확인
- 포트 충돌: 해당 포트를 사용 중인 프로세스를 종료하거나 포트 매핑을 변경

### 9-2. 포트 충돌 확인

```bash
# 리눅스
sudo lsof -i :8080

# Windows (PowerShell)
Get-Process -Id (Get-NetTCPConnection -LocalPort 8080).OwningProcess
```

### 9-3. SSL/HTTPS 접속 문제

- 도메인이 올바르게 서버 IP를 바라보는지 DNS 설정 확인
- `docker compose logs certbot` 으로 인증서 발급 오류 메시지 확인
- `nginx/nginx.v2.conf` 에서 도메인, 인증서 경로, 리버스 프록시 대상 서비스(Spring, Motion, Music 등) 확인

---

이 문서는 **흥부자 서비스의 전체 빌드 및 배포 흐름**을 기준으로 작성되었습니다.  
인프라 구조가 변경되면 이 문서도 함께 업데이트해 주세요.

